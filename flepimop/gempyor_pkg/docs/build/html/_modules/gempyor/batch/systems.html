<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>gempyor.batch.systems &#8212; gempyor  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for gempyor.batch.systems</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;BatchSystem&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LocalBatchSystem&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SlurmBatchSystem&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_batch_system&quot;</span><span class="p">,</span>
    <span class="s2">&quot;register_batch_system&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">stat</span> <span class="kn">import</span> <span class="n">S_IXUSR</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">overload</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">confuse</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">PositiveInt</span>

<span class="kn">from</span> <span class="nn">.._jinja</span> <span class="kn">import</span> <span class="n">_jinja_environment</span>
<span class="kn">from</span> <span class="nn">..logging</span> <span class="kn">import</span> <span class="n">get_script_logger</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">_format_cli_options</span><span class="p">,</span> <span class="n">_shutil_which</span>
<span class="kn">from</span> <span class="nn">.types</span> <span class="kn">import</span> <span class="n">JobResources</span><span class="p">,</span> <span class="n">JobResult</span><span class="p">,</span> <span class="n">JobSize</span><span class="p">,</span> <span class="n">JobSubmission</span>


<span class="n">_batch_systems</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="BatchSystem">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem">[docs]</a>
<span class="k">class</span> <span class="nc">BatchSystem</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract base class for batch systems.</span>

<span class="sd">    This class contains logic for interacting with batch systems, such as formatting</span>
<span class="sd">    job resources and time limits.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: The name of the batch system. Must be unique when registered.</span>
<span class="sd">        needs_cluster: Whether the batch system requires a cluster to run jobs, defaults</span>
<span class="sd">            to `False`.</span>
<span class="sd">        estimatible: Whether the batch system can estimate the resources required for a</span>
<span class="sd">            job, defaults to `False`. If `True` then the batch system should implement</span>
<span class="sd">            the `status` method.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import timedelta</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.batch import BatchSystem, JobResources, JobSize</span>
<span class="sd">        &gt;&gt;&gt; class MyCustomBatchSystem(BatchSystem):</span>
<span class="sd">        ...     name = &quot;my_custom&quot;</span>
<span class="sd">        ...     def submit(self, script, options, verbosity, dry_run):</span>
<span class="sd">        ...             return None</span>
<span class="sd">        &gt;&gt;&gt; batch_system = MyCustomBatchSystem()</span>
<span class="sd">        &gt;&gt;&gt; resources = JobResources(nodes=1, cpus=2, memory=1024)</span>
<span class="sd">        &gt;&gt;&gt; batch_system.format_nodes(resources)</span>
<span class="sd">        &#39;1&#39;</span>
<span class="sd">        &gt;&gt;&gt; batch_system.format_cpus(resources)</span>
<span class="sd">        &#39;2&#39;</span>
<span class="sd">        &gt;&gt;&gt; batch_system.format_memory(resources)</span>
<span class="sd">        &#39;1024&#39;</span>
<span class="sd">        &gt;&gt;&gt; time_limit = timedelta(days=1, hours=2, minutes=34, seconds=56)</span>
<span class="sd">        &gt;&gt;&gt; batch_system.format_time_limit(time_limit)</span>
<span class="sd">        &#39;1595&#39;</span>
<span class="sd">        &gt;&gt;&gt; batch_system.size_from_jobs_simulations_blocks(2, 10, None, 5)</span>
<span class="sd">        JobSize(blocks=2, chains=10, samples=None, simulations=5)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">needs_cluster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">estimatible</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@overload</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">script</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">script</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSubmission</span><span class="p">:</span> <span class="o">...</span>

<div class="viewcode-block" id="BatchSystem.submit">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.submit">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">script</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSubmission</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit a job to the batch system.</span>

<span class="sd">        Args:</span>
<span class="sd">            script: The path to the script to submit.</span>
<span class="sd">            options: Additional options to pass to the batch system, if applicable.</span>
<span class="sd">            verbosity: The verbosity level of the submission.</span>
<span class="sd">            dry_run: Whether to perform a dry run of the submission, if applicable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The job submission result or `None` if a dry run.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Batch systems which implement this method and do not support dry runs should</span>
<span class="sd">            raise a `NotImplementedError` when `dry_run` is `True`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="BatchSystem.submit_command">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.submit_command">[docs]</a>
    <span class="k">def</span> <span class="nf">submit_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSubmission</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit a command to the batch system.</span>

<span class="sd">        Args:</span>
<span class="sd">            command: The command to submit.</span>
<span class="sd">            options: Additional options to pass to the batch system, if applicable.</span>
<span class="sd">            verbosity: The verbosity level of the submission.</span>
<span class="sd">            dry_run: Whether to perform a dry run of the submission, if applicable.</span>
<span class="sd">            **kwargs: Additional keyword arguments to be used by subclasses.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The job submission result or `None` if a dry run.</span>

<span class="sd">        See Also:</span>
<span class="sd">            The `submit` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_script_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="s2">&quot;Local batch system does not support command submissions on windows. &quot;</span>
                <span class="s2">&quot;If you have experience with scripting on windows and would like to &quot;</span>
                <span class="s2">&quot;contribute, please consider opening a pull request.&quot;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp</span><span class="p">:</span>
            <span class="n">temp_script</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="n">temp_script</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span>
                <span class="n">_jinja_environment</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;submit_command.bash.j2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span><span class="p">}}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Submit command script placed at &#39;</span><span class="si">%s</span><span class="s2">&#39; for inspection.&quot;</span><span class="p">,</span> <span class="n">temp_script</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">temp_script</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">)</span></div>


<div class="viewcode-block" id="BatchSystem.status">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.status">[docs]</a>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">JobSubmission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobResult</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the status of a job submission.</span>

<span class="sd">        Args:</span>
<span class="sd">            submission: The job submission to get the status of.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The status of the job submission or `None` if the status could not be</span>
<span class="sd">            determined or the batch system is not estimatible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BatchSystem.format_nodes">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.format_nodes">[docs]</a>
    <span class="k">def</span> <span class="nf">format_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_resources</span><span class="p">:</span> <span class="n">JobResources</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format the number of nodes for a job.</span>

<span class="sd">        The default implementation returns the number of nodes as a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_resources: The job resources to format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The formatted number of nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_resources</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span></div>


<div class="viewcode-block" id="BatchSystem.format_cpus">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.format_cpus">[docs]</a>
    <span class="k">def</span> <span class="nf">format_cpus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_resources</span><span class="p">:</span> <span class="n">JobResources</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format the number of CPUs for a job.</span>

<span class="sd">        The default implementation returns the number of CPUs as a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_resources: The job resources to format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The formatted number of CPUs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_resources</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span></div>


<div class="viewcode-block" id="BatchSystem.format_memory">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.format_memory">[docs]</a>
    <span class="k">def</span> <span class="nf">format_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_resources</span><span class="p">:</span> <span class="n">JobResources</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format the amount of memory for a job.</span>

<span class="sd">        The default implementation returns the amount of memory as a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_resources: The job resources to format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The formatted amount of memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_resources</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span></div>


<div class="viewcode-block" id="BatchSystem.format_time_limit">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.format_time_limit">[docs]</a>
    <span class="k">def</span> <span class="nf">format_time_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_time_limit</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format the time limit for a job.</span>

<span class="sd">        The default implementation returns the time limit in minutes rounded up.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_time_limit: The time limit to format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The formatted time limit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">job_time_limit</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">))</span></div>


<div class="viewcode-block" id="BatchSystem.size_from_jobs_simulations_blocks">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.size_from_jobs_simulations_blocks">[docs]</a>
    <span class="k">def</span> <span class="nf">size_from_jobs_simulations_blocks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blocks</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chains</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">samples</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">simulations</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSize</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer a job size from several explicit and implicit parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            blocks: An explicit number of blocks per a job.</span>
<span class="sd">            chains: An explicit number of chains.</span>
<span class="sd">            samples: An explicit number of samples per a block.</span>
<span class="sd">            simulations: An explicit number of simulations per a block.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A job size instance with either the explicit or inferred job sizing.</span>

<span class="sd">        See Also:</span>
<span class="sd">            `gempyor.batch.JobSize`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">JobSize</span><span class="p">(</span>
            <span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">simulations</span><span class="o">=</span><span class="n">simulations</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BatchSystem.options_from_config_and_cli">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.BatchSystem.options_from_config_and_cli">[docs]</a>
    <span class="k">def</span> <span class="nf">options_from_config_and_cli</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">confuse</span><span class="o">.</span><span class="n">Configuration</span><span class="p">,</span>
        <span class="n">cli_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate batch system options from a configuration and CLI options.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: The configuration options to use.</span>
<span class="sd">            cli_options: The CLI options to use.</span>
<span class="sd">            verbosity: The verbosity level of the submission.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The batch system options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="LocalBatchSystem">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.LocalBatchSystem">[docs]</a>
<span class="k">class</span> <span class="nc">LocalBatchSystem</span><span class="p">(</span><span class="n">BatchSystem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch system for running jobs locally.</span>

<span class="sd">    This class is a batch system for running jobs locally. It is intended for testing</span>
<span class="sd">    and development purposes, not production jobs. Therefore it will override user</span>
<span class="sd">    inputs to limit the number of jobs to 1 and the number of blocks x simulations to</span>
<span class="sd">    10.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: The name of the batch system which is &#39;local&#39;.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import warnings</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.batch import LocalBatchSystem</span>
<span class="sd">        &gt;&gt;&gt; batch_system = LocalBatchSystem()</span>
<span class="sd">        &gt;&gt;&gt; batch_system.size_from_jobs_simulations_blocks(1, 1, 25, 50)</span>
<span class="sd">        JobSize(blocks=1, chains=1, samples=25, simulations=50)</span>
<span class="sd">        &gt;&gt;&gt; with warnings.catch_warnings(record=True) as warns:</span>
<span class="sd">        ...     size = batch_system.size_from_jobs_simulations_blocks(2, 4, 50, 100)</span>
<span class="sd">        ...     for warn in warns:</span>
<span class="sd">        ...             print(warn.message)</span>
<span class="sd">        ...</span>
<span class="sd">        Local batch system only supports 1 chain but was given 4, overriding.</span>
<span class="sd">        Local batch system only supports 1 block but was given 2, overriding.</span>
<span class="sd">        Local batch system only supports 50 total simulations but was given 800, overriding.</span>
<span class="sd">        Local batch system only supports 25 total samples but was given 400, overriding.</span>
<span class="sd">        &gt;&gt;&gt; size</span>
<span class="sd">        JobSize(blocks=1, chains=1, samples=25, simulations=50)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>

<div class="viewcode-block" id="LocalBatchSystem.submit">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.LocalBatchSystem.submit">[docs]</a>
    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">script</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSubmission</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit a job to the local batch system.</span>

<span class="sd">        Args:</span>
<span class="sd">            script: The path to the script to submit.</span>
<span class="sd">            options: Additional options to pass to the batch system.</span>
<span class="sd">            verbosity: The verbosity level of the submission.</span>
<span class="sd">            dry_run: Whether to perform a dry run of the submission.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The job submission result where the `job_id` is the PID of the process or</span>
<span class="sd">            `None` if a dry run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_submit_via_subprocess</span><span class="p">(</span>
            <span class="n">exec</span><span class="o">=</span><span class="n">script</span><span class="p">,</span>
            <span class="n">coerce_exec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">exec_method</span><span class="o">=</span><span class="s2">&quot;popen&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">job_id_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">proc</span><span class="p">:</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="p">(</span>
                <span class="n">get_script_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LocalBatchSystem.size_from_jobs_simulations_blocks">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.LocalBatchSystem.size_from_jobs_simulations_blocks">[docs]</a>
    <span class="k">def</span> <span class="nf">size_from_jobs_simulations_blocks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blocks</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chains</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">samples</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">simulations</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSize</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer a job size from several explicit and implicit parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            blocks: An explicit number of blocks per a job.</span>
<span class="sd">            chains: An explicit number of chains.</span>
<span class="sd">            samples: An explicit number of samples per a block.</span>
<span class="sd">            simulations: An explicit number of simulations per a block.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A job size instance with either the explicit or inferred job sizing.</span>

<span class="sd">        See Also:</span>
<span class="sd">            `gempyor.batch.JobSize`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prelim_size</span> <span class="o">=</span> <span class="n">JobSize</span><span class="p">(</span>
            <span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">simulations</span><span class="o">=</span><span class="n">simulations</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">chains</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">chains</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Local batch system only supports 1 chain but &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;was given </span><span class="si">{</span><span class="n">prelim_size</span><span class="o">.</span><span class="n">chains</span><span class="si">}</span><span class="s2">, overriding.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">blocks</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Local batch system only supports 1 block but &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;was given </span><span class="si">{</span><span class="n">prelim_size</span><span class="o">.</span><span class="n">blocks</span><span class="si">}</span><span class="s2">, overriding.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">total_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">total_samples</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Local batch system only supports 25 total samples but &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;was given </span><span class="si">{</span><span class="n">prelim_size</span><span class="o">.</span><span class="n">total_samples</span><span class="si">}</span><span class="s2">, overriding.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">total_simulations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">total_simulations</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Local batch system only supports 50 total simulations but &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;was given </span><span class="si">{</span><span class="n">prelim_size</span><span class="o">.</span><span class="n">total_simulations</span><span class="si">}</span><span class="s2">, overriding.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">JobSize</span><span class="p">(</span>
            <span class="n">blocks</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">blocks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">chains</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">chains</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">samples</span><span class="o">=</span><span class="p">(</span>
                <span class="kc">None</span>
                <span class="k">if</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">total_samples</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">prelim_size</span><span class="o">.</span><span class="n">total_samples</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">simulations</span><span class="o">=</span><span class="p">(</span>
                <span class="kc">None</span>
                <span class="k">if</span> <span class="n">prelim_size</span><span class="o">.</span><span class="n">total_simulations</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">prelim_size</span><span class="o">.</span><span class="n">total_simulations</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SlurmBatchSystem">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.SlurmBatchSystem">[docs]</a>
<span class="k">class</span> <span class="nc">SlurmBatchSystem</span><span class="p">(</span><span class="n">BatchSystem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch system for running jobs on a Slurm HPC cluster.</span>

<span class="sd">    This class is a batch system for running jobs on a Slurm HPC cluster. It provides</span>
<span class="sd">    formatting overrides that are specific to Slurm&#39;s submission requirements.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: The name of the batch system which is &#39;slurm&#39;.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import timedelta</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.batch import SlurmBatchSystem, JobResources</span>
<span class="sd">        &gt;&gt;&gt; batch_system = SlurmBatchSystem()</span>
<span class="sd">        &gt;&gt;&gt; resources = JobResources(nodes=2, cpus=4, memory=8*1024)</span>
<span class="sd">        &gt;&gt;&gt; batch_system.format_memory(resources)</span>
<span class="sd">        &#39;8192MB&#39;</span>
<span class="sd">        &gt;&gt;&gt; time_limit = timedelta(days=1, hours=2, minutes=34, seconds=56)</span>
<span class="sd">        &gt;&gt;&gt; batch_system.format_time_limit(time_limit)</span>
<span class="sd">        &#39;26:34:56&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_sbatch_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;submitted batch job (\d+)&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">_seff_state_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;state:\s+(pending|running|completed|failed)(\s+\(exit\s+code\s+([0-9]+)\))?&quot;</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_seff_wall_time_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;job\s+wall\-clock\s+time:\s+([0-9]+):([0-9]+):([0-9]+)&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
    <span class="p">)</span>
    <span class="n">_seff_memory_efficiency_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;memory\s+efficiency:\s([0-9]+\.[0-9]+)%&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
    <span class="p">)</span>
    <span class="n">_seff_cpu_efficiency_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;cpu\s+efficiency:\s([0-9]+\.[0-9]+)%&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
    <span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;slurm&quot;</span>
    <span class="n">needs_cluster</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">estimatible</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="SlurmBatchSystem.submit">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.SlurmBatchSystem.submit">[docs]</a>
    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">script</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSubmission</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit a job to the slurm batch system.</span>

<span class="sd">        Args:</span>
<span class="sd">            script: The path to the script to submit.</span>
<span class="sd">            options: Additional options to pass to the batch system.</span>
<span class="sd">            verbosity: The verbosity level of the submission.</span>
<span class="sd">            dry_run: Whether to perform a dry run of the submission.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The job submission result where the `job_id` is the slurm ID of the job or</span>
<span class="sd">            `None` if a dry run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_submit_via_subprocess</span><span class="p">(</span>
            <span class="n">exec</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">_shutil_which</span><span class="p">(</span><span class="s2">&quot;sbatch&quot;</span><span class="p">)),</span>
            <span class="n">coerce_exec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">exec_method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">absolute</span><span class="p">())],</span>
            <span class="n">job_id_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">proc</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">logger</span><span class="o">=</span><span class="p">(</span>
                <span class="n">get_script_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SlurmBatchSystem.submit_command">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.SlurmBatchSystem.submit_command">[docs]</a>
    <span class="k">def</span> <span class="nf">submit_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSubmission</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit a command to the slurm batch system.</span>

<span class="sd">        Args:</span>
<span class="sd">            command: The command to submit.</span>
<span class="sd">            options: Additional options to pass to the batch system, if applicable.</span>
<span class="sd">            verbosity: The verbosity level of the submission.</span>
<span class="sd">            dry_run: Whether to perform a dry run of the submission, if applicable.</span>
<span class="sd">            **kwargs: Additional keyword arguments used to generate the sbatch</span>
<span class="sd">                submission script.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The job submission result or `None` if a dry run.</span>

<span class="sd">        Notes:</span>
<span class="sd">            If `dry_run` is `True` then the sbatch submission script will be copied to</span>
<span class="sd">            the current working directory before program end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_script_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.sbatch&quot;</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">job_name</span> <span class="o">:=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job_name&quot;</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">job_name</span><span class="p">,</span>
            <span class="nb">dir</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span>
            <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">temp_script</span><span class="p">:</span>
            <span class="n">sbatch_script</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temp_script</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="n">sbatch_script</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span>
                <span class="n">_jinja_environment</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;sbatch_submit_command.bash.j2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span><span class="p">}}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using sbatch script &#39;</span><span class="si">%s</span><span class="s2">&#39; for submission&quot;</span><span class="p">,</span> <span class="n">sbatch_script</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="n">sbatch_script</span><span class="p">,</span>
                <span class="n">options</span><span class="p">,</span>
                <span class="n">verbosity</span><span class="p">,</span>
                <span class="n">dry_run</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="SlurmBatchSystem.status">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.SlurmBatchSystem.status">[docs]</a>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">JobSubmission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the status of a job submission via `seff`.</span>

<span class="sd">        Args:</span>
<span class="sd">            submission: The job submission to get the status of.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The status of the job submission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seff</span> <span class="o">=</span> <span class="n">_shutil_which</span><span class="p">(</span><span class="s2">&quot;seff&quot;</span><span class="p">)</span>
        <span class="n">seff_proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span><span class="n">seff</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">job_id</span><span class="p">)],</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">seff_proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">job_result_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seff_state_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">state</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">returncode</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="n">job_result_kwargs</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">job_result_kwargs</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">returncode</span><span class="p">)</span> <span class="k">if</span> <span class="n">returncode</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">match</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seff_wall_time_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="n">job_result_kwargs</span><span class="p">[</span><span class="s2">&quot;wall_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span>
                    <span class="n">hours</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">hours</span><span class="p">),</span> <span class="n">minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">minutes</span><span class="p">),</span> <span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">match</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seff_memory_efficiency_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job_result_kwargs</span><span class="p">[</span><span class="s2">&quot;memory_efficiency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">match</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seff_cpu_efficiency_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job_result_kwargs</span><span class="p">[</span><span class="s2">&quot;cpu_efficiency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">JobResult</span><span class="p">(</span><span class="o">**</span><span class="n">job_result_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SlurmBatchSystem.format_memory">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.SlurmBatchSystem.format_memory">[docs]</a>
    <span class="k">def</span> <span class="nf">format_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_resources</span><span class="p">:</span> <span class="n">JobResources</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_resources</span><span class="o">.</span><span class="n">memory</span><span class="si">}</span><span class="s2">MB&quot;</span></div>


<div class="viewcode-block" id="SlurmBatchSystem.format_time_limit">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.SlurmBatchSystem.format_time_limit">[docs]</a>
    <span class="k">def</span> <span class="nf">format_time_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_time_limit</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">total_seconds</span> <span class="o">=</span> <span class="n">job_time_limit</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">total_seconds</span> <span class="o">/</span> <span class="p">(</span><span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">))</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">total_seconds</span> <span class="o">-</span> <span class="p">(</span><span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="n">hours</span><span class="p">))</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_seconds</span> <span class="o">-</span> <span class="p">(</span><span class="mf">60.0</span> <span class="o">*</span> <span class="n">minutes</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="n">hours</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="SlurmBatchSystem.options_from_config_and_cli">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.SlurmBatchSystem.options_from_config_and_cli">[docs]</a>
    <span class="k">def</span> <span class="nf">options_from_config_and_cli</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">confuse</span><span class="o">.</span><span class="n">Configuration</span><span class="p">,</span>
        <span class="n">cli_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate batch system options from a configuration and CLI options.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: The configuration options to use.</span>
<span class="sd">            cli_options: The CLI options to use.</span>
<span class="sd">            verbosity: The verbosity level of the submission.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The batch system options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_script_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">partition</span> <span class="o">:=</span> <span class="n">cli_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extra&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;partition&quot;</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;partition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partition</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">email</span> <span class="o">:=</span> <span class="n">cli_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extra&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;mail-user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;mail-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ALL&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generated options: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">options</span></div>
</div>



<div class="viewcode-block" id="register_batch_system">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.register_batch_system">[docs]</a>
<span class="k">def</span> <span class="nf">register_batch_system</span><span class="p">(</span><span class="n">batch_system</span><span class="p">:</span> <span class="n">BatchSystem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a batch system with gempyor.</span>

<span class="sd">    Add a batch system to the list of registered batch systems with gempyor. This</span>
<span class="sd">    function acts as a complement to `get_batch_system` and is intended to be used by</span>
<span class="sd">    users who wish to add their own batch system to gempyor.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_system: The batch system to register.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the batch system is already registered, checks the `name`</span>
<span class="sd">            attribute to determine this.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.batch import BatchSystem, register_batch_system</span>
<span class="sd">        &gt;&gt;&gt; class CustomBatchSystem(BatchSystem):</span>
<span class="sd">        ...     name = &quot;custom&quot;</span>
<span class="sd">        &gt;&gt;&gt; register_batch_system(CustomBatchSystem()) is None</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...     register_batch_system(CustomBatchSystem()) is None</span>
<span class="sd">        ... except Exception as e:</span>
<span class="sd">        ...     print(e)</span>
<span class="sd">        ...</span>
<span class="sd">        Batch system &#39;custom&#39; already registered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">batch_system</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">bs</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="n">_batch_systems</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch system &#39;</span><span class="si">{</span><span class="n">batch_system</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already registered.&quot;</span><span class="p">)</span>
    <span class="n">_batch_systems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_system</span><span class="p">)</span></div>



<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">get_batch_system</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchSystem</span><span class="p">:</span> <span class="o">...</span>


<div class="viewcode-block" id="get_batch_system">
<a class="viewcode-back" href="../../../api/gempyor.batch.html#gempyor.batch.systems.get_batch_system">[docs]</a>
<span class="k">def</span> <span class="nf">get_batch_system</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchSystem</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a registered batch system by name.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the batch system to get.</span>
<span class="sd">        raise_on_missing: Whether to raise an error if the batch system is not found.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The batch system with the given name or `None` if not found.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the batch system is not found and `raise_on_missing` is `True`.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.batch import get_batch_system</span>
<span class="sd">        &gt;&gt;&gt; get_batch_system(&quot;local&quot;)</span>
<span class="sd">        &lt;gempyor.batch.LocalBatchSystem object at 0x1629f9b10&gt;</span>
<span class="sd">        &gt;&gt;&gt; get_batch_system(&quot;slurm&quot;)</span>
<span class="sd">        &lt;gempyor.batch.SlurmBatchSystem object at 0x1629f9ad0&gt;</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...     get_batch_system(&quot;does not exist&quot;)</span>
<span class="sd">        ... except Exception as e:</span>
<span class="sd">        ...     print(e)</span>
<span class="sd">        ...</span>
<span class="sd">        Batch system &#39;does not exist&#39; not found in registered batch systems.</span>
<span class="sd">        &gt;&gt;&gt; get_batch_system(&quot;does not exist&quot;, raise_on_missing=False) is None</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_system</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">bs</span> <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="n">_batch_systems</span> <span class="k">if</span> <span class="n">bs</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">batch_system</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">raise_on_missing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch system &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found in registered batch systems.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batch_system</span></div>



<span class="k">def</span> <span class="nf">_reset_batch_systems</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset the batch systems to the default state.</span>

<span class="sd">    This function is intended for testing purposes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;_batch_systems&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch_system</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SlurmBatchSystem</span><span class="p">(),</span> <span class="n">LocalBatchSystem</span><span class="p">()):</span>
        <span class="n">register_batch_system</span><span class="p">(</span><span class="n">batch_system</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_resolve_batch_system_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">local</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">slurm</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve the batch system name from the given arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the batch system or `None` to infer from `local` and `slurm`.</span>
<span class="sd">        local: A flag to use the local batch system.</span>
<span class="sd">        slurm: A flag to use the slurm batch system.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The resolved batch system name lowercased or `None` if no batch system was</span>
<span class="sd">        resolved.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If more than one batch system is indicated via boolean flags.</span>
<span class="sd">        ValueError: If the given name conflicts with the boolean flags.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.batch import _resolve_batch_system_name</span>
<span class="sd">        &gt;&gt;&gt; _resolve_batch_system_name(&quot;abc&quot;, False, False)</span>
<span class="sd">        &#39;abc&#39;</span>
<span class="sd">        &gt;&gt;&gt; _resolve_batch_system_name(&quot;SLURM&quot;, False, False)</span>
<span class="sd">        &#39;slurm&#39;</span>
<span class="sd">        &gt;&gt;&gt; _resolve_batch_system_name(&quot;local&quot;, True, False)</span>
<span class="sd">        &#39;local&#39;</span>
<span class="sd">        &gt;&gt;&gt; _resolve_batch_system_name(None, True, False)</span>
<span class="sd">        &#39;local&#39;</span>
<span class="sd">        &gt;&gt;&gt; _resolve_batch_system_name(None, False, True)</span>
<span class="sd">        &#39;slurm&#39;</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...     _resolve_batch_system_name(None, True, True)</span>
<span class="sd">        ... except Exception as e:</span>
<span class="sd">        ...     print(e)</span>
<span class="sd">        There were 2 boolean flags given, expected either 0 or 1.</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...     _resolve_batch_system_name(&quot;slurm&quot;, True, False)</span>
<span class="sd">        ... except Exception as e:</span>
<span class="sd">        ...     print(e)</span>
<span class="sd">        Conflicting batch systems given. The batch system name is &#39;slurm&#39; and the flags indicate &#39;local&#39;.</span>
<span class="sd">        &gt;&gt;&gt; _resolve_batch_system_name(None, False, False) is None</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">boolean_flags</span> <span class="o">:=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">local</span><span class="p">,</span> <span class="n">slurm</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There were </span><span class="si">{</span><span class="n">boolean_flags</span><span class="si">}</span><span class="s2"> boolean flags given, expected either 0 or 1.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">flag_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">local</span><span class="p">,</span> <span class="n">slurm</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;slurm&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">flag_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Conflicting batch systems given. The batch system name &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;is &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; and the flags indicate &#39;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>
        <span class="k">elif</span> <span class="n">slurm</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;slurm&quot;</span>
    <span class="k">return</span> <span class="n">name</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">_submit_via_subprocess</span><span class="p">(</span>
    <span class="n">exec</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">coerce_exec</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">exec_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;popen&quot;</span><span class="p">],</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">job_id_callback</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Callable</span><span class="p">[[</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CompletedProcess</span> <span class="o">|</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">],</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">),</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">_submit_via_subprocess</span><span class="p">(</span>
    <span class="n">exec</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">coerce_exec</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">exec_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;popen&quot;</span><span class="p">],</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">job_id_callback</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Callable</span><span class="p">[[</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CompletedProcess</span> <span class="o">|</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">],</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">),</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSubmission</span><span class="p">:</span> <span class="o">...</span>


<span class="k">def</span> <span class="nf">_submit_via_subprocess</span><span class="p">(</span>
    <span class="n">exec</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">coerce_exec</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">exec_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;popen&quot;</span><span class="p">],</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">job_id_callback</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Callable</span><span class="p">[[</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CompletedProcess</span> <span class="o">|</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">],</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">),</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobSubmission</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Submit a job via a subprocess.</span>

<span class="sd">    Args:</span>
<span class="sd">        exec: The path to the command to execute.</span>
<span class="sd">        coerce_exec: Whether to make the command executable if it is not.</span>
<span class="sd">        exec_method: The method to use to execute the command, if &#39;run&#39; then this</span>
<span class="sd">            function will use `subprocess.run` and if &#39;popen&#39; it will use</span>
<span class="sd">            `subprocess.Popen`.</span>
<span class="sd">        options: Additional options to pass to the command if any.</span>
<span class="sd">        args: Additional arguments to pass to the command if any.</span>
<span class="sd">        job_id_callback: A callback to extract the job ID from the executed command.</span>
<span class="sd">        logger: The logger to use for logging.</span>
<span class="sd">        dry_run: Whether to perform a dry run of the submission.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A job submission result or `None` if a dry run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using script &#39;</span><span class="si">%s</span><span class="s2">&#39; for local execution&quot;</span><span class="p">,</span> <span class="n">exec</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">exec</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">exec</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The executable &#39;</span><span class="si">{</span><span class="n">exec</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; either does not exist or is not a file.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">coerce_exec</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">((</span><span class="n">current_perms</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S_IXUSR</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The file &#39;</span><span class="si">%s</span><span class="s2">&#39; is not executable, making it executable.&quot;</span><span class="p">,</span> <span class="n">exec</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="n">new_perms</span> <span class="o">=</span> <span class="n">current_perms</span> <span class="o">|</span> <span class="n">S_IXUSR</span>
        <span class="n">exec</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">new_perms</span><span class="p">)</span>

    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">exec</span><span class="o">.</span><span class="n">absolute</span><span class="p">())]</span> <span class="o">+</span> <span class="n">_format_cli_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;If not dry run would have executed script with: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing script with: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">exec_method</span> <span class="o">==</span> <span class="s2">&quot;popen&quot;</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="p">[</span><span class="n">comm</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">comm</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="s2">&quot;Received non-zero exit code, </span><span class="si">%u</span><span class="s2">, from executed script.&quot;</span><span class="p">,</span>
                <span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Captured stdout from executed script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No stdout captured from executed script.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Captured stderr from executed script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No stderr captured from executed script.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Captured stdout from executed script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Captured stderr from executed script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="n">job_id</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">job_id_callback</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">job_id_callback</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracted job ID of: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">exec_method</span> <span class="o">==</span> <span class="s2">&quot;popen&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JobSubmission</span><span class="p">(</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">process</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="n">returncode</span><span class="o">=</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">JobSubmission</span><span class="o">.</span><span class="n">from_completed_process</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>


<span class="n">_reset_batch_systems</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">gempyor</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/gempyor.html">gempyor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gempyor.html">gempyor package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, ACCIDDA.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>