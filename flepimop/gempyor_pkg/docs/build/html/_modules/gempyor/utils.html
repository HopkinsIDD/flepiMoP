<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>gempyor.utils &#8212; gempyor  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for gempyor.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">shlex</span> <span class="kn">import</span> <span class="n">quote</span> <span class="k">as</span> <span class="n">shlex_quote</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">import</span> <span class="nn">confuse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">sympy.parsing.sympy_parser</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">file_paths</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">confuse</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="s2">&quot;flepiMoP&quot;</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="write_df">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.write_df">[docs]</a>
<span class="k">def</span> <span class="nf">write_df</span><span class="p">(</span>
    <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">extension</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes a pandas DataFrame without its index to a file.</span>

<span class="sd">    Writes a pandas DataFrame to either a CSV or Parquet file without its index and can</span>
<span class="sd">    infer which format to use based on the extension given in `fname` or based on</span>
<span class="sd">    explicit `extension`.</span>

<span class="sd">    Args:</span>
<span class="sd">        fname: The name of the file to write to.</span>
<span class="sd">        df: A pandas DataFrame whose contents to write, but without its index.</span>
<span class="sd">        extension: A user specified extension to use for the file if not contained in</span>
<span class="sd">            `fname` already.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: The given output extension is not supported yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Decipher the path given</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">fname</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">extension</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="c1"># Write df to either a csv or parquet or raise if an invalid extension</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Invalid extension provided: &#39;.</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">&#39;. Supported extensions are `.csv` or `.parquet`.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="read_df">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.read_df">[docs]</a>
<span class="k">def</span> <span class="nf">read_df</span><span class="p">(</span>
    <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span>
    <span class="n">extension</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads a pandas DataFrame from either a CSV or Parquet file.</span>

<span class="sd">    Reads a pandas DataFrame to either a CSV or Parquet file and can infer which format</span>
<span class="sd">    to use based on the extension given in `fname` or based on explicit `extension`. If</span>
<span class="sd">    the file being read is a csv with a column called &#39;subpop&#39; then that column will be</span>
<span class="sd">    cast as a string.</span>

<span class="sd">    Args:</span>
<span class="sd">        fname: The name of the file to read from.</span>
<span class="sd">        extension: A user specified extension to use for the file if not contained in</span>
<span class="sd">            `fname` already.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A pandas DataFrame parsed from the file given.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: The given output extension is not supported yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Decipher the path given</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">fname</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">extension</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="c1"># Read df from either a csv or parquet or raise if an invalid extension</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;subpop&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)},</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Invalid extension provided: &#39;.</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">&#39;. Supported extensions are `.csv` or `.parquet`.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="command_safe_run">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.command_safe_run">[docs]</a>
<span class="k">def</span> <span class="nf">command_safe_run</span><span class="p">(</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mycommand&quot;</span><span class="p">,</span> <span class="n">fail_on_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a shell command and prints diagnostics if command fails.</span>

<span class="sd">    Args:</span>
<span class="sd">        command: The CLI command to be given.</span>
<span class="sd">        command_name: The reference name for you command. Default value is &quot;mycommand&quot;.</span>
<span class="sd">        fail_on_fail: If True, an exception will be thrown if the command fails (default is True)</span>

<span class="sd">    Returns:</span>
<span class="sd">        As a tuple; the return code, the standard output, and standard error from running the command.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If fail_on_fail=True and the command fails, an error will be thrown.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="kn">import</span> <span class="nn">shlex</span>  <span class="c1"># using shlex to split the command because it&#39;s not obvious https://docs.python.org/3/library/subprocess.html#subprocess.Popen</span>

    <span class="n">sr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">command</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sr</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">command_name</span><span class="si">}</span><span class="s2">&#39; failed failed with returncode &#39;</span><span class="si">{</span><span class="n">sr</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">command_name</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{command_name}</span><span class="s2"> command failed with stdout and stderr:&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{command_name}</span><span class="s2"> stdout &gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{command_name}</span><span class="s2"> stdout &lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{command_name}</span><span class="s2"> stderr &gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{command_name}</span><span class="s2"> stderr &lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fail_on_fail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="n">command_name</span><span class="si">}</span><span class="s2">&#39; command failed.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sr</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span></div>



<div class="viewcode-block" id="add_method">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.add_method">[docs]</a>
<span class="k">def</span> <span class="nf">add_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function which adds a function to a class.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls: The class you want to add a method to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        decorator: The decorator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">return</span> <span class="n">decorator</span></div>



<div class="viewcode-block" id="search_and_import_plugins_class">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.search_and_import_plugins_class">[docs]</a>
<span class="k">def</span> <span class="nf">search_and_import_plugins_class</span><span class="p">(</span>
    <span class="n">plugin_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function serving to create a class that finds and imports the necessary modules.</span>

<span class="sd">    Args:</span>
<span class="sd">        plugin_file_path: Pathway to the module.</span>
<span class="sd">        path_prefix: Pathway prefix to the module.</span>
<span class="sd">        class_name: Name of the class.</span>
<span class="sd">        **kwargs: Further arguments passed to initilization of the class.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The instance of the class that was instantiated with provided **kwargs.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Suppose there is a module called `my_plugin.py with a class `MyClass` located at `/path/to/plugin/`.</span>

<span class="sd">        Dynamically import and instantiate the class:</span>

<span class="sd">        &gt;&gt;&gt; instance = search_and_import_plugins_class(&#39;/path/to/plugin&#39;, path_prefix, &#39;MyClass&#39;, **params)</span>

<span class="sd">        View the instance:</span>

<span class="sd">        &gt;&gt;&gt; print(instance)</span>
<span class="sd">        &lt;__main__.MyClass object at 0x7f8b2c6b4d60&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Look for all possible plugins and import them</span>
    <span class="c1"># https://stackoverflow.com/questions/67631/how-can-i-import-a-module-dynamically-given-the-full-path</span>
    <span class="c1"># unfortunatelly very complicated, this is cpython only ??</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>

    <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_prefix</span><span class="p">,</span> <span class="n">plugin_file_path</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>
    <span class="c1"># the following works, but these above lines seems necessary to pickle // runs</span>
    <span class="kn">from</span> <span class="nn">pydoc</span> <span class="kn">import</span> <span class="n">importfile</span>

    <span class="n">module</span> <span class="o">=</span> <span class="n">importfile</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">klass</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="c1">### Profile configuration</span>
<span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">pstats</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>


<div class="viewcode-block" id="profile">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.profile">[docs]</a>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sort_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">,</span>
    <span class="n">lines_to_print</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">strip_dirs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A time profiler decorator.</span>
<span class="sd">    Inspired by and modified the profile decorator of Giampaolo Rodola:</span>
<span class="sd">    http://code.activestate.com/recipes/577817-profile-decorator/</span>

<span class="sd">    Args:</span>
<span class="sd">        output_file:</span>
<span class="sd">            Path of the output file. If only name of the file is given, it&#39;s</span>
<span class="sd">            saved in the current directory.</span>
<span class="sd">            If it&#39;s None, the name of the decorated function is used.</span>
<span class="sd">        sort_by:</span>
<span class="sd">            Sorting criteria for the Stats object.</span>
<span class="sd">            For a list of valid string and SortKey refer to:</span>
<span class="sd">            https://docs.python.org/3/library/profile.html#pstats.Stats.sort_stats</span>
<span class="sd">        lines_to_print:</span>
<span class="sd">            Number of lines to print. Default (None) is for all the lines.</span>
<span class="sd">            This is useful in reducing the size of the printout, especially</span>
<span class="sd">            that sorting by &#39;cumulative&#39;, the time consuming operations</span>
<span class="sd">            are printed toward the top of the file.</span>
<span class="sd">        strip_dirs:</span>
<span class="sd">            Whether to remove the leading path info from file names.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Profile of the decorated function.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; @profile(output_file=&quot;my_function.prof&quot;)</span>
<span class="sd">        &gt;&gt;&gt; def my_function():</span>
<span class="sd">            # Function body content</span>
<span class="sd">            pass</span>
<span class="sd">        &gt;&gt;&gt; my_function()</span>
<span class="sd">        After running ``my_function``, a file named ``my_function.prof`` will be created in the current WD.</span>
<span class="sd">        This file contains the profiling data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">_output_file</span> <span class="o">=</span> <span class="n">output_file</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.prof&quot;</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">dump_stats</span><span class="p">(</span><span class="n">_output_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">retval</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">return</span> <span class="n">inner</span></div>



<div class="viewcode-block" id="as_list">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.as_list">[docs]</a>
<span class="k">def</span> <span class="nf">as_list</span><span class="p">(</span><span class="n">thing</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns argument passed as a list.</span>

<span class="sd">    Args:</span>
<span class="sd">        thing: The object that you would like to be converted to a list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The object converted to a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">thing</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">thing</span><span class="p">]</span></div>



<span class="c1">### A little timer class</span>
<div class="viewcode-block" id="Timer">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.Timer">[docs]</a>
<span class="k">class</span> <span class="nc">Timer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A timer class that starts, ends, and records time in between.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: Name of event.</span>
<span class="sd">        tstart: Time start.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] started&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] completed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">tstart</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="ISO8601Date">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.ISO8601Date">[docs]</a>
<span class="k">class</span> <span class="nc">ISO8601Date</span><span class="p">(</span><span class="n">confuse</span><span class="o">.</span><span class="n">Template</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in config dates into datetimes.dates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ISO8601Date.convert">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.ISO8601Date.convert">[docs]</a>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="n">confuse</span><span class="o">.</span><span class="n">ConfigView</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the given value to a datetime.date object.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: The value to be converted. Can be datetime.date object or ISO8601 string.</span>
<span class="sd">            view:  A view object from confuse, to be used for error reporting.</span>

<span class="sd">        Raises:</span>
<span class="sd">            confuse.TemplateError: If `value` is neither a datetime.date nor an ISO8601Date string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;must be a date object or ISO8601 date&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="as_date">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.as_date">[docs]</a>
<span class="nd">@add_method</span><span class="p">(</span><span class="n">confuse</span><span class="o">.</span><span class="n">ConfigView</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">as_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluates an datetime.date or ISO8601 date string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A datetime.date data type of the date associated with the object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ISO8601Date</span><span class="p">())</span></div>



<div class="viewcode-block" id="as_evaled_expression">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.as_evaled_expression">[docs]</a>
<span class="nd">@add_method</span><span class="p">(</span><span class="n">confuse</span><span class="o">.</span><span class="n">ConfigView</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">as_evaled_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluates an expression string, returning a float.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A float data type of the value associated with the object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: On parsing errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sympy</span><span class="o">.</span><span class="n">parsing</span><span class="o">.</span><span class="n">sympy_parser</span><span class="o">.</span><span class="n">parse_expr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected numeric or string expression [received: &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;].&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_truncated_normal">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.get_truncated_normal">[docs]</a>
<span class="k">def</span> <span class="nf">get_truncated_normal</span><span class="p">(</span>
    <span class="n">mean</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">sd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">_distn_infrastructure</span><span class="o">.</span><span class="n">rv_frozen</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a truncated normal distribution.</span>

<span class="sd">    This function constructs a truncated normal distribution with the specified</span>
<span class="sd">    mean, standard deviation, and bounds. The truncated normal distribution is</span>
<span class="sd">    a normal distribution bounded within the interval [a, b].</span>

<span class="sd">    Args:</span>
<span class="sd">        mean: The mean of the truncated normal distribution. Defaults to 0.</span>
<span class="sd">        sd: The standard deviation of the truncated normal distribution. Defaults to 1.</span>
<span class="sd">        a: The lower bound of the truncated normal distribution. Defaults to 0.</span>
<span class="sd">        b: The upper bound of the truncated normal distribution. Defaults to 10.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rv_frozen: A frozen instance of the truncated normal distribution with the specified parameters.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Create a truncated normal distribution with specified parameters (truncated between 1 and 10):</span>
<span class="sd">        &gt;&gt;&gt; truncated_normal_dist = get_truncated_normal(mean=5, sd=2, a=1, b=10)</span>
<span class="sd">        &gt;&gt;&gt; print(truncated_normal_dist)</span>
<span class="sd">        rv_frozen(&lt;scipy.stats._distn_infrastructure.rv_frozen object at 0x...&gt;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">sd</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">sd</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">truncnorm</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sd</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_log_normal">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.get_log_normal">[docs]</a>
<span class="k">def</span> <span class="nf">get_log_normal</span><span class="p">(</span>
    <span class="n">meanlog</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sdlog</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">_distn_infrastructure</span><span class="o">.</span><span class="n">rv_frozen</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a log normal distribution.</span>

<span class="sd">    This function constructs a log normal distribution with the specified</span>
<span class="sd">    log mean and log standard deviation.</span>

<span class="sd">    Args:</span>
<span class="sd">        meanlog: The log of the mean of the log normal distribution.</span>
<span class="sd">        sdlog: The log of the standard deviation of the log normal distribution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rv_frozen: A frozen instance of the log normal distribution with the</span>
<span class="sd">        specified parameters.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Create a log-normal distribution with specified parameters:</span>
<span class="sd">        &gt;&gt;&gt; log_normal_dist = get_log_normal(meanlog=1, sdlog=0.5)</span>
<span class="sd">        &gt;&gt;&gt; print(log_normal_dist)</span>
<span class="sd">        &lt;scipy.stats._distn_infrastructure.rv_frozen object at 0x...&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">sdlog</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">meanlog</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="random_distribution_sampler">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.random_distribution_sampler">[docs]</a>
<span class="k">def</span> <span class="nf">random_distribution_sampler</span><span class="p">(</span>
    <span class="n">distribution</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;fixed&quot;</span><span class="p">,</span> <span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;poisson&quot;</span><span class="p">,</span> <span class="s2">&quot;binomial&quot;</span><span class="p">,</span> <span class="s2">&quot;truncnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;lognorm&quot;</span>
    <span class="p">],</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create function to sample from a random distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        distribution: The type of distribution to generate a sampling function for.</span>
<span class="sd">        **kwargs: Further parameters that are passed to the underlying function for the</span>
<span class="sd">            given distribution.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The further args expected by each distribution type are:</span>
<span class="sd">        - fixed: value,</span>
<span class="sd">        - uniform: low, high,</span>
<span class="sd">        - poisson: lam,</span>
<span class="sd">        - binomial: n, p,</span>
<span class="sd">        - truncnorm: mean, sd, a, b,</span>
<span class="sd">        - lognorm: meanlog, sdlog.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A function that can be called to sample from that distribution.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If `distribution` is &#39;binomial&#39; the given `p` must be in (0,1).</span>
<span class="sd">        NotImplementedError: If `distribution` is not one of the type hinted options.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; np.random.seed(123)</span>
<span class="sd">        &gt;&gt;&gt; uniform_sampler = random_distribution_sampler(&quot;uniform&quot;, low=0.0, high=3.0)</span>
<span class="sd">        &gt;&gt;&gt; uniform_sampler()</span>
<span class="sd">        2.089407556793585</span>
<span class="sd">        &gt;&gt;&gt; uniform_sampler()</span>
<span class="sd">        0.8584180048511384</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
        <span class="c1"># Fixed value is the same as uniform on [a, a)</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
        <span class="c1"># Uniform on [low, high)</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;low&quot;</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;high&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;poisson&quot;</span><span class="p">:</span>
        <span class="c1"># Poisson with mean lambda</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lam&quot;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;binomial&quot;</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid `p-value`: &#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&#39; is out of range [0,1].&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;truncnorm&quot;</span><span class="p">:</span>
        <span class="c1"># Truncated normal with mean, sd on interval [a, b]</span>
        <span class="k">return</span> <span class="n">get_truncated_normal</span><span class="p">(</span>
            <span class="n">mean</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">),</span>
            <span class="n">sd</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sd&quot;</span><span class="p">),</span>
            <span class="n">a</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span>
            <span class="n">b</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">rvs</span>
    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;lognorm&quot;</span><span class="p">:</span>
        <span class="c1"># Lognormal distribution with meanlog, sdlog</span>
        <span class="k">return</span> <span class="n">get_log_normal</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meanlog&quot;</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sdlog&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">rvs</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown distribution [received: &#39;</span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&#39;].&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="as_random_distribution">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.as_random_distribution">[docs]</a>
<span class="nd">@add_method</span><span class="p">(</span><span class="n">confuse</span><span class="o">.</span><span class="n">ConfigView</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">as_random_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a random distribution object from a distribution config key.</span>

<span class="sd">    Args:</span>
<span class="sd">        self: Class instance (in this case, a config key) to construct the random distribution from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A partial object containing the random distribution.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: When values are out of range.</span>
<span class="sd">        NotImplementedError: If an unknown distribution is found.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Say that ``config`` is a ``confuse.ConfigView`` instance.</span>

<span class="sd">        To create a uniform distribution between 1 and 10:</span>
<span class="sd">        &gt;&gt;&gt; dist_function = config.as_random_distribution()</span>
<span class="sd">        &gt;&gt;&gt; sample = dist_function()</span>
<span class="sd">        5.436789235794546</span>

<span class="sd">        To use a truncated normal distribution:</span>
<span class="sd">        &gt;&gt;&gt; config_truncnorm = confuse.ConfigView({</span>
<span class="sd">            &quot;distribution&quot;: &quot;truncnorm&quot;,</span>
<span class="sd">            &quot;mean&quot;: 0</span>
<span class="sd">            &quot;sd&quot;: 1,</span>
<span class="sd">            &quot;a&quot;: -1,</span>
<span class="sd">            &quot;b&quot;: 1</span>
<span class="sd">            })</span>
<span class="sd">        &gt;&gt;&gt; truncnorm_dist_function = config_truncnorm.as_random_distribution()</span>
<span class="sd">        &gt;&gt;&gt; truncnorm_sample = truncnorm_dist_function()</span>
<span class="sd">        0.312745</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s2">&quot;poisson&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;lam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s2">&quot;binomial&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid `p-value`: &#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&#39; is out of range [0,1].&quot;</span><span class="p">)</span>
                <span class="c1"># if (self[&quot;p&quot;] &lt; 0) or (self[&quot;p&quot;] &gt; 1):</span>
                <span class="c1">#    raise ValueError(f&quot;&quot;&quot;p value { self[&quot;p&quot;] } is out of range [0,1]&quot;&quot;&quot;)</span>
            <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
                <span class="c1"># self[&quot;p&quot;].as_evaled_expression(),</span>
                <span class="n">p</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s2">&quot;truncnorm&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_truncated_normal</span><span class="p">(</span>
                <span class="n">mean</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
                <span class="n">sd</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;sd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
                <span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
                <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">rvs</span>
        <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s2">&quot;lognorm&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_log_normal</span><span class="p">(</span>
                <span class="n">meanlog</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;meanlog&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
                <span class="n">sdlog</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;sdlog&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">rvs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown distribution [received: &#39;</span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s2">&#39;].&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># we allow a fixed value specified directly:</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">as_evaled_expression</span><span class="p">(),</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="list_filenames">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.list_filenames">[docs]</a>
<span class="k">def</span> <span class="nf">list_filenames</span><span class="p">(</span>
    <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the list of all filenames and paths in the provided folder.</span>

<span class="sd">    This function lists all files in the specified folder and its subdirectories.</span>
<span class="sd">    If filters are provided, only the files containing each of the substrings</span>
<span class="sd">    in the filters will be returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder:</span>
<span class="sd">            The directory to search for files. Defaults to the current directory.</span>
<span class="sd">        filters:</span>
<span class="sd">            A string or a list of strings to filter filenames. Only files</span>
<span class="sd">            containing all the provided substrings will be returned. Defaults to an</span>
<span class="sd">            empty list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of strings representing the paths to the files that match the filters.</span>

<span class="sd">    Examples:</span>
<span class="sd">        To get all files containing &quot;hosp&quot;:</span>
<span class="sd">        &gt;&gt;&gt; gempyor.utils.list_filenames(</span>
<span class="sd">            folder=&quot;model_output/&quot;,</span>
<span class="sd">            filters=[&quot;hosp&quot;],</span>
<span class="sd">        )</span>

<span class="sd">        To get only &quot;hosp&quot; files with a &quot;.parquet&quot; extension:</span>
<span class="sd">        &gt;&gt;&gt; gempyor.utils.list_filenames(</span>
<span class="sd">            folder=&quot;model_output/&quot;,</span>
<span class="sd">            filters=[&quot;hosp&quot;, &quot;.parquet&quot;],</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">filters</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">filters</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">folder</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">files</span></div>



<div class="viewcode-block" id="extract_slot">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.extract_slot">[docs]</a>
<span class="k">def</span> <span class="nf">extract_slot</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the slot number from the filename and add to DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        file: The filename to extract the slot number from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A pandas DataFrame containing the contents of `file` along with a column called</span>
<span class="sd">        &#39;slot&#39; that contains the slot number extracted from the filename.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the &#39;slot&#39; column already exists in the DataFrame read in.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pathlib import Path</span>
<span class="sd">        &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.utils import extract_slot</span>
<span class="sd">        &gt;&gt;&gt; sample = pd.DataFrame(data={&quot;letters&quot;: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]})</span>
<span class="sd">        &gt;&gt;&gt; file = Path.cwd() / &quot;00017.foobar.csv&quot;</span>
<span class="sd">        &gt;&gt;&gt; sample.to_csv(file, index=False)</span>
<span class="sd">        &gt;&gt;&gt; extract_slot(file)</span>
<span class="sd">        letters  slot</span>
<span class="sd">        0       a    17</span>
<span class="sd">        1       b    17</span>
<span class="sd">        2       c    17</span>
<span class="sd">        &gt;&gt;&gt; extract_slot(file).info()</span>
<span class="sd">        &lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;</span>
<span class="sd">        RangeIndex: 3 entries, 0 to 2</span>
<span class="sd">        Data columns (total 2 columns):</span>
<span class="sd">        #   Column   Non-Null Count  Dtype</span>
<span class="sd">        ---  ------   --------------  -----</span>
<span class="sd">        0   letters  3 non-null      object</span>
<span class="sd">        1   slot     3 non-null      int64</span>
<span class="sd">        dtypes: int64(1), object(1)</span>
<span class="sd">        memory usage: 180.0+ bytes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;slot&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Column &#39;slot&#39; already exists in the DataFrame from file: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;slot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="read_directory">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.read_directory">[docs]</a>
<span class="k">def</span> <span class="nf">read_directory</span><span class="p">(</span>
    <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read all files in a directory into a single DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory: The directory to read files from.</span>
<span class="sd">        filters: A string or a list of strings to filter filenames. Only files</span>
<span class="sd">            containing all the provided substrings will be read. Defaults to `None` for</span>
<span class="sd">            no filters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A pandas DataFrame containing the contents of all the files in the directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">list_filenames</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">dfs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extract_slot</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="rolling_mean_pad">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.rolling_mean_pad">[docs]</a>
<span class="k">def</span> <span class="nf">rolling_mean_pad</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">],</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the column-wise rolling mean with centered window.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: A two dimensional numpy array, typically the row dimension is time and the</span>
<span class="sd">            column dimension is subpop.</span>
<span class="sd">        window: The window size for the rolling mean.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A two dimensional numpy array that is the same shape as `data`.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Below is a brief set of examples showcasing how to smooth a metric, like</span>
<span class="sd">        hospitalizations, using this function.</span>
<span class="sd">        ```</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.utils import rolling_mean_pad</span>
<span class="sd">        &gt;&gt;&gt; hospitalizations = np.arange(1., 29.).reshape((7, 4))</span>
<span class="sd">        &gt;&gt;&gt; hospitalizations</span>
<span class="sd">        array([[ 1.,  2.,  3.,  4.],</span>
<span class="sd">            [ 5.,  6.,  7.,  8.],</span>
<span class="sd">            [ 9., 10., 11., 12.],</span>
<span class="sd">            [13., 14., 15., 16.],</span>
<span class="sd">            [17., 18., 19., 20.],</span>
<span class="sd">            [21., 22., 23., 24.],</span>
<span class="sd">            [25., 26., 27., 28.]])</span>
<span class="sd">        &gt;&gt;&gt; rolling_mean_pad(hospitalizations, 5)</span>
<span class="sd">        array([[ 3.4,  4.4,  5.4,  6.4],</span>
<span class="sd">            [ 5.8,  6.8,  7.8,  8.8],</span>
<span class="sd">            [ 9. , 10. , 11. , 12. ],</span>
<span class="sd">            [13. , 14. , 15. , 16. ],</span>
<span class="sd">            [17. , 18. , 19. , 20. ],</span>
<span class="sd">            [20.2, 21.2, 22.2, 23.2],</span>
<span class="sd">            [22.6, 23.6, 24.6, 25.6]])</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">window</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">convolve1d</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">window</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">window</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">window</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">window</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">i_star</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span></div>



<div class="viewcode-block" id="print_disk_diagnosis">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.print_disk_diagnosis">[docs]</a>
<span class="k">def</span> <span class="nf">print_disk_diagnosis</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads and prints AWS disk diagnostic information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
    <span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">disk_usage</span>

    <span class="k">def</span> <span class="nf">bash</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a shell command and returns its output.</span>

<span class="sd">        Args:</span>
<span class="sd">            command: The shell command to be executed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The output of the shell command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;START AWS DIAGNOSIS ================================&quot;</span><span class="p">)</span>
    <span class="n">total_bytes</span><span class="p">,</span> <span class="n">used_bytes</span><span class="p">,</span> <span class="n">free_bytes</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;shutil.disk_usage: </span><span class="si">{</span><span class="n">total_bytes</span><span class="o">/</span><span class="w"> </span><span class="mi">1000000</span><span class="si">}</span><span class="s2"> Mb total, </span><span class="si">{</span><span class="n">used_bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000000</span><span class="si">}</span><span class="s2"> Mb used, </span><span class="si">{</span><span class="n">free_bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000000</span><span class="si">}</span><span class="s2"> Mb free...&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df -hT: &#39;</span><span class="si">{</span><span class="n">bash</span><span class="p">(</span><span class="s1">&#39;df -hT&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df -i: &#39;</span><span class="si">{</span><span class="n">bash</span><span class="p">(</span><span class="s1">&#39;df -i&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;free -h: &#39;</span><span class="si">{</span><span class="n">bash</span><span class="p">(</span><span class="s1">&#39;free -h&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lsblk: &#39;</span><span class="si">{</span><span class="n">bash</span><span class="p">(</span><span class="s1">&#39;lsblk&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;END AWS DIAGNOSIS ================================&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_resume_out_filename">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.create_resume_out_filename">[docs]</a>
<span class="k">def</span> <span class="nf">create_resume_out_filename</span><span class="p">(</span>
    <span class="n">flepi_run_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_slot_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_block_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">filetype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">liketype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compiles run output information.</span>

<span class="sd">    Args:</span>
<span class="sd">        flepi_run_index: Index of the run.</span>
<span class="sd">        flepi_prefix: File prefix.</span>
<span class="sd">        flepi_slot_index: Index of the slot.</span>
<span class="sd">        flepi_block_index: Index of the block.</span>
<span class="sd">        filetype: File type.</span>
<span class="sd">        liketype: Chimeric or global.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The path to a corresponding output file.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Generate an output file with specified parameters:</span>
<span class="sd">        &gt;&gt;&gt; filename = create_resume_out_filename(</span>
<span class="sd">            flepi_run_index=&quot;test_run&quot;,</span>
<span class="sd">            flepi_prefix=&quot;model_output/run_id/&quot;,</span>
<span class="sd">            flepi_slot_index=&quot;1&quot;,</span>
<span class="sd">            flepi_block_index=&quot;2&quot;,</span>
<span class="sd">            filetype=&quot;seed&quot;,</span>
<span class="sd">            liketype=&quot;chimeric&quot;</span>
<span class="sd">            )</span>
<span class="sd">        &gt;&gt;&gt; print(filename)</span>
<span class="sd">        &quot;experiment/001/normal/intermediate/000000123.000000000.1.parquet&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flepi_prefix</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">flepi_run_index</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">inference_filepath_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">liketype</span><span class="si">}</span><span class="s2">/intermediate&quot;</span>
    <span class="n">inference_filename_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:09d}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">flepi_slot_index</span><span class="p">))</span>
    <span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:09d}</span><span class="s2">.</span><span class="si">{:09d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">flepi_block_index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;parquet&quot;</span>
    <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;seed&quot;</span><span class="p">:</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
    <span class="k">return</span> <span class="n">file_paths</span><span class="o">.</span><span class="n">create_file_name</span><span class="p">(</span>
        <span class="n">run_id</span><span class="o">=</span><span class="n">flepi_run_index</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
        <span class="n">inference_filename_prefix</span><span class="o">=</span><span class="n">inference_filename_prefix</span><span class="p">,</span>
        <span class="n">inference_filepath_suffix</span><span class="o">=</span><span class="n">inference_filepath_suffix</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="n">ftype</span><span class="o">=</span><span class="n">filetype</span><span class="p">,</span>
        <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="create_resume_input_filename">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.create_resume_input_filename">[docs]</a>
<span class="k">def</span> <span class="nf">create_resume_input_filename</span><span class="p">(</span>
    <span class="n">resume_run_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_slot_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">filetype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">liketype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compiles run input information.</span>

<span class="sd">    Args:</span>
<span class="sd">        resume_run_index: Index of the run.</span>
<span class="sd">        flepi_prefix: File prefix.</span>
<span class="sd">        flepi_slot_index: Index of the slot.</span>
<span class="sd">        filetype: File type.</span>
<span class="sd">        liketype: Chimeric or global.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The path to the a corresponding input file.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Generate an input file with specified parameters:</span>
<span class="sd">        &gt;&gt;&gt; filename = create_resume_input_filename(</span>
<span class="sd">            resume_run_index=&quot;2&quot;,</span>
<span class="sd">            flepi_prefix=&quot;model_output/run_id/&quot;,</span>
<span class="sd">            flepi_slot_index=&quot;1&quot;,</span>
<span class="sd">            filetype=&quot;seed&quot;,</span>
<span class="sd">            liketype=&quot;chimeric&quot;</span>
<span class="sd">            )</span>
<span class="sd">        &gt;&gt;&gt; print(filename)</span>
<span class="sd">        &quot;experiment/002/normal/final/789.csv&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flepi_prefix</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">resume_run_index</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">inference_filepath_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">liketype</span><span class="si">}</span><span class="s2">/final&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">flepi_slot_index</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;parquet&quot;</span>
    <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;seed&quot;</span><span class="p">:</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
    <span class="k">return</span> <span class="n">file_paths</span><span class="o">.</span><span class="n">create_file_name</span><span class="p">(</span>
        <span class="n">run_id</span><span class="o">=</span><span class="n">resume_run_index</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
        <span class="n">inference_filepath_suffix</span><span class="o">=</span><span class="n">inference_filepath_suffix</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="n">ftype</span><span class="o">=</span><span class="n">filetype</span><span class="p">,</span>
        <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="get_filetype_for_resume">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.get_filetype_for_resume">[docs]</a>
<span class="k">def</span> <span class="nf">get_filetype_for_resume</span><span class="p">(</span>
    <span class="n">resume_discard_seeding</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flepi_block_index</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a list of parquet file types that are relevant for resuming a process based on</span>
<span class="sd">    specific environment variable settings.</span>
<span class="sd">    This function dynamically determines the list</span>
<span class="sd">    based on the current operational context given by the environment.</span>

<span class="sd">    Args:</span>
<span class="sd">        resume_discard_seeding: Determines whether seeding-related file types should be included (str).</span>
<span class="sd">        flepi_block_index: Determines a specific operational mode or block of the process (str).</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of file types.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Determine file types for block index 1 with seeding data NOT discarded:</span>
<span class="sd">        &gt;&gt;&gt; filetypes = get_filetype_for_resume(resume_discard_seeding=&quot;false&quot;, flepi_block_index=&quot;1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(filetypes)</span>
<span class="sd">        [&quot;seed&quot;, &quot;spar&quot;, &quot;snpi&quot;, &quot;hpar&quot;, &quot;hnpi&quot;, &quot;init&quot;]</span>

<span class="sd">        Determine file types for block index 2 with seeding data discarded:</span>
<span class="sd">        &gt;&gt;&gt; filtypes = get_filetype_for_resume(resume_discard_seeding=&quot;true&quot;, flepi_block_index=&quot;2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(filetypes)</span>
<span class="sd">        [&quot;seed&quot;, &quot;spar&quot;, &quot;snpi&quot;, &quot;hpar&quot;, &quot;hnpi&quot;, &quot;host&quot;, &quot;llik&quot;, &quot;init&quot;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flepi_block_index</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resume_discard_seeding</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;spar&quot;</span><span class="p">,</span> <span class="s2">&quot;snpi&quot;</span><span class="p">,</span> <span class="s2">&quot;hpar&quot;</span><span class="p">,</span> <span class="s2">&quot;hnpi&quot;</span><span class="p">,</span> <span class="s2">&quot;init&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="s2">&quot;spar&quot;</span><span class="p">,</span> <span class="s2">&quot;snpi&quot;</span><span class="p">,</span> <span class="s2">&quot;hpar&quot;</span><span class="p">,</span> <span class="s2">&quot;hnpi&quot;</span><span class="p">,</span> <span class="s2">&quot;init&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="s2">&quot;spar&quot;</span><span class="p">,</span> <span class="s2">&quot;snpi&quot;</span><span class="p">,</span> <span class="s2">&quot;hpar&quot;</span><span class="p">,</span> <span class="s2">&quot;hnpi&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;llik&quot;</span><span class="p">,</span> <span class="s2">&quot;init&quot;</span><span class="p">]</span></div>



<div class="viewcode-block" id="create_resume_file_names_map">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.create_resume_file_names_map">[docs]</a>
<span class="k">def</span> <span class="nf">create_resume_file_names_map</span><span class="p">(</span>
    <span class="n">resume_discard_seeding</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_block_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resume_run_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_slot_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flepi_run_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">last_job_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a mapping of input file names to output file names for a resume process based on</span>
<span class="sd">    parquet file types and environmental conditions. The function adjusts the file name mappings</span>
<span class="sd">    based on the operational block index and the location of the last job output.</span>

<span class="sd">    Args:</span>
<span class="sd">        resume_discard_seeding:  Determines whether seeding-related file types should be included.</span>
<span class="sd">        flepi_block_index: Determines a specific operational mode or block of the process.</span>
<span class="sd">        resume_run_index: Resume run index.</span>
<span class="sd">        flepi_prefix: File prefix.</span>
<span class="sd">        flepi_slot_index: Index of the slot.</span>
<span class="sd">        flepi_run_index: flepiMoP run index.</span>
<span class="sd">        last_job_output: Adjusts the keys in the mapping to be prefixed with this path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary where keys are input file paths and values are corresponding</span>
<span class="sd">        output file paths.</span>

<span class="sd">    The mappings depend on:</span>
<span class="sd">    - Parquet file types appropriate for resuming a process, as determined by the environment.</span>
<span class="sd">    - Whether the files are for &#39;global&#39; or &#39;chimeric&#39; types, as these liketypes influence the</span>
<span class="sd">      file naming convention.</span>
<span class="sd">    - The operational block index (&#39;FLEPI_BLOCK_INDEX&#39;), which can alter the input file names for</span>
<span class="sd">      block index &#39;1&#39;.</span>
<span class="sd">    - The presence and value of &#39;LAST_JOB_OUTPUT&#39; environment variable, which if set to an S3 path,</span>
<span class="sd">      adjusts the keys in the mapping to be prefixed with this path.</span>

<span class="sd">    Raises:</span>
<span class="sd">        No explicit exceptions are raised within the function, but it relies heavily on external</span>
<span class="sd">        functions and environment variables which if improperly configured could lead to unexpected</span>
<span class="sd">        behavior.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Generate a mapping of file names for a given resume process:</span>
<span class="sd">        &gt;&gt;&gt; file_names_map = create_resume_file_names_map(</span>
<span class="sd">            resume_discard_seeding=&quot;false&quot;,</span>
<span class="sd">            flepi_block_index=&quot;1&quot;,</span>
<span class="sd">            resume_run_index=&quot;1&quot;,</span>
<span class="sd">            flepi_prefix=&quot;model_output/run_id/&quot;,</span>
<span class="sd">            flepi_slot_index=&quot;1&quot;,</span>
<span class="sd">            flepi_run_index=&quot;test_run&quot;,</span>
<span class="sd">            last_job_output=&quot;s3://bucket/path/&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(file_names_map)</span>
<span class="sd">        {</span>
<span class="sd">        &#39;s3://bucket/path/model_output/run_id/1_type1_global_1.in&#39;: &#39;model_output/run_id/test_run_type1_global_1_1.out&#39;,</span>
<span class="sd">        &#39;s3://bucket/path/model_output/run_id/1_type1_chimeric_1.in&#39;: &#39;model_output/run_id/test_run_type1_chimeric_1_1.out&#39;,</span>
<span class="sd">        &#39;s3://bucket/path/model_output/run_id/1_type2_global_1.in&#39;: &#39;model_output/run_id/test_run_type2_global_1_1.out&#39;,</span>
<span class="sd">        &#39;s3://bucket/path/model_output/run_id/1_type2_chimeric_1.in&#39;: &#39;model_output/run_id/test_run_type2_chimeric_1_1.out&#39;</span>
<span class="sd">        }</span>
<span class="sd">        # Note: this output is toy output implemented with toy file names.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - The paths may be modified by the &#39;LAST_JOB_OUTPUT&#39; if it is set and points to an S3 location.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_types</span> <span class="o">=</span> <span class="n">get_filetype_for_resume</span><span class="p">(</span>
        <span class="n">resume_discard_seeding</span><span class="o">=</span><span class="n">resume_discard_seeding</span><span class="p">,</span> <span class="n">flepi_block_index</span><span class="o">=</span><span class="n">flepi_block_index</span>
    <span class="p">)</span>
    <span class="n">resume_file_name_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">liketypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;chimeric&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="n">file_types</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">liketype</span> <span class="ow">in</span> <span class="n">liketypes</span><span class="p">:</span>
            <span class="n">output_file_name</span> <span class="o">=</span> <span class="n">create_resume_out_filename</span><span class="p">(</span>
                <span class="n">flepi_run_index</span><span class="o">=</span><span class="n">flepi_run_index</span><span class="p">,</span>
                <span class="n">flepi_prefix</span><span class="o">=</span><span class="n">flepi_prefix</span><span class="p">,</span>
                <span class="n">flepi_slot_index</span><span class="o">=</span><span class="n">flepi_slot_index</span><span class="p">,</span>
                <span class="n">flepi_block_index</span><span class="o">=</span><span class="n">flepi_block_index</span><span class="p">,</span>
                <span class="n">filetype</span><span class="o">=</span><span class="n">filetype</span><span class="p">,</span>
                <span class="n">liketype</span><span class="o">=</span><span class="n">liketype</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">input_file_name</span> <span class="o">=</span> <span class="n">output_file_name</span>
            <span class="k">if</span> <span class="n">flepi_block_index</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
                <span class="n">input_file_name</span> <span class="o">=</span> <span class="n">create_resume_input_filename</span><span class="p">(</span>
                    <span class="n">resume_run_index</span><span class="o">=</span><span class="n">resume_run_index</span><span class="p">,</span>
                    <span class="n">flepi_prefix</span><span class="o">=</span><span class="n">flepi_prefix</span><span class="p">,</span>
                    <span class="n">flepi_slot_index</span><span class="o">=</span><span class="n">flepi_slot_index</span><span class="p">,</span>
                    <span class="n">filetype</span><span class="o">=</span><span class="n">filetype</span><span class="p">,</span>
                    <span class="n">liketype</span><span class="o">=</span><span class="n">liketype</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">resume_file_name_mapping</span><span class="p">[</span><span class="n">input_file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_file_name</span>
    <span class="k">if</span> <span class="n">last_job_output</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">old_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">resume_file_name_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">old_keys</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last_job_output</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">resume_file_name_mapping</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">resume_file_name_mapping</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">resume_file_name_mapping</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">resume_file_name_mapping</span></div>



<div class="viewcode-block" id="download_file_from_s3">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.download_file_from_s3">[docs]</a>
<span class="k">def</span> <span class="nf">download_file_from_s3</span><span class="p">(</span><span class="n">name_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downloads files from AWS S3 based on a mapping of S3 URIs to local file paths. The function</span>
<span class="sd">    checks if the directory for the first output file exists and creates it if necessary. It</span>
<span class="sd">    then iterates over each S3 URI in the provided mapping, downloads the file to the corresponding</span>
<span class="sd">    local path, and handles errors if the S3 URI format is incorrect or if the download fails.</span>

<span class="sd">    Args:</span>
<span class="sd">        name_map:</span>
<span class="sd">            A dictionary where keys are S3 URIs (strings) and values</span>
<span class="sd">            are the local file paths (strings) where the files should</span>
<span class="sd">            be saved.</span>

<span class="sd">    Returns:</span>
<span class="sd">        This function does not return a value; its primary effect is the side effect of</span>
<span class="sd">        downloading files and potentially creating directories.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If an S3 URI does not start with &#39;s3://&#39;, indicating an invalid format.</span>
<span class="sd">        ClientError: If an error occurs during the download from S3, such as a permissions issue,</span>
<span class="sd">                     a missing file, or network-related errors. These are caught and logged but not</span>
<span class="sd">                     re-raised, to allow the function to attempt subsequent downloads.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; name_map = {</span>
<span class="sd">            &quot;s3://mybucket/data/file1.txt&quot;: &quot;/local/path/to/file1.txt&quot;,</span>
<span class="sd">            &quot;s3://mybucket/data/file2.txt&quot;: &quot;/local/path/to/file2.txt&quot;</span>
<span class="sd">        }</span>
<span class="sd">        &gt;&gt;&gt; download_file_from_s3(name_map)</span>
<span class="sd">        # This would download &#39;file1.txt&#39; and &#39;file2.txt&#39; from &#39;mybucket&#39; on S3 to the specified local paths.</span>

<span class="sd">        # If an S3 URI is malformed:</span>
<span class="sd">        &gt;&gt;&gt; name_map = {</span>
<span class="sd">            &quot;http://wrongurl.com/data/file1.txt&quot;: &quot;/local/path/to/file1.txt&quot;</span>
<span class="sd">        }</span>
<span class="sd">        &gt;&gt;&gt; download_file_from_s3(name_map)</span>
<span class="sd">        # This will raise a ValueError indicating the invalid S3 URI format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">boto3</span>
        <span class="kn">from</span> <span class="nn">botocore.exceptions</span> <span class="kn">import</span> <span class="n">ClientError</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;No module named `boto3` found, which is required for &quot;</span>
                <span class="s2">&quot;`gempyor.utils.download_file_from_s3`. Please install the aws target.&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>
    <span class="n">first_output_filename</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">name_map</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">first_output_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s3_uri</span> <span class="ow">in</span> <span class="n">name_map</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s3_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">):</span>
                <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="nb">object</span> <span class="o">=</span> <span class="n">s3_uri</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">:]</span>
                <span class="n">s3</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name_map</span><span class="p">[</span><span class="n">s3_uri</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid S3 URI format [received: &#39;</span><span class="si">{</span><span class="n">s3_uri</span><span class="si">}</span><span class="s2">&#39;].&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39;: could not download filefrom S3.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="move_file_at_local">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.utils.move_file_at_local">[docs]</a>
<span class="k">def</span> <span class="nf">move_file_at_local</span><span class="p">(</span><span class="n">name_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Moves files locally according to a given mapping.</span>
<span class="sd">    This function takes a dictionary where the keys are source file paths and</span>
<span class="sd">    the values are destination file paths. It ensures that the destination</span>
<span class="sd">    directories exist and then copies the files from the source paths to the</span>
<span class="sd">    destination paths.</span>

<span class="sd">    Args:</span>
<span class="sd">        name_map: A dictionary mapping source file paths to destination file paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">name_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_dump_formatted_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">confuse</span><span class="o">.</span><span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump confuse configuration to a formatted YAML string.</span>

<span class="sd">    Args:</span>
<span class="sd">        cfg: The confuse configuration object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A formatted YAML string representation of the configuration.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.utils import _dump_formatted_yaml</span>
<span class="sd">        &gt;&gt;&gt; import confuse</span>
<span class="sd">        &gt;&gt;&gt; conf = confuse.Configuration(&quot;foobar&quot;)</span>
<span class="sd">        &gt;&gt;&gt; data = {</span>
<span class="sd">        ...     &quot;name&quot;: &quot;Test Config&quot;,</span>
<span class="sd">        ...     &quot;compartments&quot;: {</span>
<span class="sd">        ...         &quot;infection_stage&quot;: [&quot;S&quot;, &quot;E&quot;, &quot;I&quot;, &quot;R&quot;]</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     &quot;seir&quot;: {</span>
<span class="sd">        ...         &quot;parameters&quot;: {</span>
<span class="sd">        ...             &quot;beta&quot;: {&quot;value&quot;: 3.4},</span>
<span class="sd">        ...             &quot;gamma&quot;: {&quot;value&quot;: 5.6},</span>
<span class="sd">        ...         },</span>
<span class="sd">        ...         &quot;transitions&quot;: {</span>
<span class="sd">        ...             &quot;source&quot;: [&quot;S&quot;],</span>
<span class="sd">        ...             &quot;destination&quot;: [&quot;E&quot;],</span>
<span class="sd">        ...             &quot;rate&quot;: [&quot;beta * gamma&quot;],</span>
<span class="sd">        ...             &quot;proportional_to&quot;: [[&quot;S&quot;], [&quot;I&quot;]],</span>
<span class="sd">        ...             &quot;proportion_exponent&quot;: [1, 1],</span>
<span class="sd">        ...         },</span>
<span class="sd">        ...     },</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; conf.set(data)</span>
<span class="sd">        &gt;&gt;&gt; print(_dump_formatted_yaml(conf))</span>
<span class="sd">        name: &quot;Test Config&quot;</span>
<span class="sd">        compartments:</span>
<span class="sd">            infection_stage: [S, E, I, R]</span>
<span class="sd">        seir:</span>
<span class="sd">            parameters:</span>
<span class="sd">                beta:</span>
<span class="sd">                    value: 3.4</span>
<span class="sd">                gamma:</span>
<span class="sd">                    value: 5.6</span>
<span class="sd">            transitions:</span>
<span class="sd">                source: [S]</span>
<span class="sd">                destination: [E]</span>
<span class="sd">                rate: [&quot;beta * gamma&quot;]</span>
<span class="sd">                proportional_to: [[S], [I]]</span>
<span class="sd">                proportion_exponent: [1, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">CustomDumper</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">Dumper</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_represent_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_represent_str</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_represent_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dumper</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dumper</span><span class="o">.</span><span class="n">represent_sequence</span><span class="p">(</span><span class="s2">&quot;tag:yaml.org,2002:seq&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flow_style</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_represent_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dumper</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dumper</span><span class="o">.</span><span class="n">represent_scalar</span><span class="p">(</span><span class="s2">&quot;tag:yaml.org,2002:str&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dumper</span><span class="o">.</span><span class="n">represent_scalar</span><span class="p">(</span><span class="s2">&quot;tag:yaml.org,2002:str&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">dump</span><span class="p">()),</span> <span class="n">Dumper</span><span class="o">=</span><span class="n">CustomDumper</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_shutil_which</span><span class="p">(</span>
    <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A thin wrapper around `shutil.which` with extra validation.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmd: The name of the command to search for.</span>
<span class="sd">        mode: The permission mask required of possible files.</span>
<span class="sd">        path: A path describing the locations to search, or `None` to use</span>
<span class="sd">            the PATH environment variable.</span>
<span class="sd">        check: If `True` an `OSError` will be raised if a `cmd` is not found.</span>
<span class="sd">            Similar in spirit to the `check` arg of `subprocess.run`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Either the full path to the `cmd` found, or `None` if `cmd` is not</span>
<span class="sd">        found and `check` is `False`.</span>

<span class="sd">    Raises:</span>
<span class="sd">        OSError: If `cmd` is not found and `check` is `True`.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; from shutil import which</span>
<span class="sd">        &gt;&gt;&gt; _shutil_which(&quot;python&quot;) == which(&quot;python&quot;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; _shutil_which(&quot;does_not_exist&quot;, check=False)</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...     _shutil_which(&quot;does_not_exist&quot;, check=True)</span>
<span class="sd">        ... except Exception as e:</span>
<span class="sd">        ...     print(type(e))</span>
<span class="sd">        ...     print(str(e).replace(os.environ.get(&quot;PATH&quot;), &quot;...&quot;))</span>
<span class="sd">        ...</span>
<span class="sd">        &lt;class &#39;OSError&#39;&gt;</span>
<span class="sd">        Did not find &#39;does_not_exist&#39; on path &#39;...&#39;.</span>

<span class="sd">    See Also:</span>
<span class="sd">        [`shutil.which`](https://docs.python.org/3/library/shutil.html#shutil.which)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check</span> <span class="ow">and</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">path</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Did not find &#39;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#39; on path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_git_head</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the sha commit hash for the head of a git repository.</span>

<span class="sd">    Args:</span>
<span class="sd">        repository: A directory under version control with git to get the sha commit of.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The sha commit of head for `repository`.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; from pathlib import Path</span>
<span class="sd">        &gt;&gt;&gt; _git_head(Path(os.environ[&quot;FLEPI_PATH&quot;]))</span>
<span class="sd">        &#39;efe896b1a5e4f8e33667c170cd5319d6ef1e3db5&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">git_cmd</span> <span class="o">=</span> <span class="n">_shutil_which</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">git_cmd</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">repository</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_git_checkout</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CompletedProcess</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checkout a new branch from a given git repository.</span>

<span class="sd">    Args:</span>
<span class="sd">        repository: A directory under version control with git to</span>
<span class="sd">            checkout a new branch in.</span>
<span class="sd">        branch: The name of the new branch to checkout.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; from pathlib import Path</span>
<span class="sd">        &gt;&gt;&gt; _git_checkout(Path(os.environ[&quot;FLEPI_PATH&quot;]), &quot;my-new-branch&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">git_cmd</span> <span class="o">=</span> <span class="n">_shutil_which</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">git_cmd</span><span class="p">,</span> <span class="s2">&quot;checkout&quot;</span><span class="p">,</span> <span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="n">shlex_quote</span><span class="p">(</span><span class="n">branch</span><span class="p">)],</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">repository</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span>
        <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_cli_options</span><span class="p">(</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">always_single</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">iterable_formatting</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;comma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a dictionary of CLI options into a formatted list.</span>

<span class="sd">    Args:</span>
<span class="sd">        options: A dictionary where the keys correspond to the option name and the</span>
<span class="sd">            values correspond to the option value. Values are escaped for shell.</span>
<span class="sd">        always_single: If `True` all options will be formatted with a single dash prefix</span>
<span class="sd">            always, useful for commands that don&#39;t support long options like</span>
<span class="sd">            `pdftotext`. If `False` the option will be formatted with a double dash</span>
<span class="sd">            prefix if the key is longer than one character.</span>
<span class="sd">        iterable_formatting: The formatting to use for iterable values. If &#39;split&#39; each</span>
<span class="sd">            value will be formatted as a separate option. If &#39;comma&#39; the values will be</span>
<span class="sd">            joined with a comma and formatted as a single option.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of options that can be passed to</span>
<span class="sd">        [`subprocess.run`](https://docs.python.org/3/library/subprocess.html#subprocess.run)</span>
<span class="sd">        or similar functions.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.utils import _format_cli_options</span>
<span class="sd">        &gt;&gt;&gt; _format_cli_options({&quot;name&quot;: &quot;foo bar fizz buzz&quot;})</span>
<span class="sd">        [&quot;--name=&#39;foo bar fizz buzz&#39;&quot;]</span>
<span class="sd">        &gt;&gt;&gt; _format_cli_options({&quot;o&quot;: &quot;/path/to/output.log&quot;})</span>
<span class="sd">        [&#39;-o=/path/to/output.log&#39;]</span>
<span class="sd">        &gt;&gt;&gt; _format_cli_options({&quot;opt1&quot;: &quot;```&quot;, &quot;opt2&quot;: &quot;$( echo &#39;Hello!&#39;)&quot;})</span>
<span class="sd">        [&quot;--opt1=&#39;```&#39;&quot;, &#39;--opt2=\&#39;$( echo \&#39;&quot;\&#39;&quot;\&#39;Hello!\&#39;&quot;\&#39;&quot;\&#39;)\&#39;&#39;]</span>
<span class="sd">        &gt;&gt;&gt; _format_cli_options({&quot;output&quot;: &quot;/path/to/output.log&quot;}, always_single=True)</span>
<span class="sd">        [&#39;-output=/path/to/output.log&#39;]</span>
<span class="sd">        &gt;&gt;&gt; _format_cli_options({&quot;person&quot;: [&quot;Alice&quot;, &quot;Bob&quot;, &quot;Charlie&quot;]})</span>
<span class="sd">        [&#39;--person=Alice&#39;, &#39;--person=Bob&#39;, &#39;--person=Charlie&#39;]</span>
<span class="sd">        &gt;&gt;&gt; _format_cli_options(</span>
<span class="sd">        ...     {&quot;person&quot;: [&quot;Alice&quot;, &quot;Bob&quot;, &quot;Charlie&quot;]},</span>
<span class="sd">        ...     iterable_formatting=&quot;comma&quot;,</span>
<span class="sd">        ... )</span>
<span class="sd">        [&#39;--person=Alice,Bob,Charlie&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">options</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">new_opts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">opt_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">always_single</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;--&#39;</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">new_opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opt_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">shlex_quote</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">iterable_formatting</span> <span class="o">==</span> <span class="s2">&quot;comma&quot;</span><span class="p">:</span>
            <span class="n">new_opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opt_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex_quote</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_opts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opt_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">shlex_quote</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_opts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">opts</span>


<span class="k">def</span> <span class="nf">_random_seeds_list</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a list of unique random integers within a specified range.</span>

<span class="sd">    Args:</span>
<span class="sd">        a: The lower bound of the range, inclusive.</span>
<span class="sd">        b: The upper bound of the range, inclusive.</span>
<span class="sd">        n: The number of unique random integers to generate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of `n` unique integers between `a` and `b`.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the lower bound is not less than the upper bound.</span>
<span class="sd">        ValueError: If the range is too small to accommodate `n` unique integers.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import random</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.utils import _random_seeds_list</span>
<span class="sd">        &gt;&gt;&gt; random.seed(42)</span>
<span class="sd">        &gt;&gt;&gt; _random_seeds_list(1, 100, 5)</span>
<span class="sd">        [82, 15, 4, 95, 36]</span>
<span class="sd">        &gt;&gt;&gt; _random_seeds_list(1, 100, 5)</span>
<span class="sd">        [32, 29, 18, 95, 14]</span>
<span class="sd">        &gt;&gt;&gt; _random_seeds_list(1, 5, 5)</span>
<span class="sd">        [5, 1, 4, 2, 3]</span>
<span class="sd">        &gt;&gt;&gt; _random_seeds_list(1, 20, 0)</span>
<span class="sd">        []</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...     _random_seeds_list(1, 5, 6)</span>
<span class="sd">        ... except Exception as e:</span>
<span class="sd">        ...     print(e)</span>
<span class="sd">        ...</span>
<span class="sd">        Range [1, 5] is too small for 6 unique random integers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">random_seeds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The lower bound, </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">, must be less than the upper bound, </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of random integers to generate must be non-negative.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Range [</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">] is too small for </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> unique random integers.&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">random_seeds</span><span class="p">:</span>
            <span class="n">random_seeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">random_seeds</span>


<span class="k">def</span> <span class="nf">_nslots_random_seeds</span><span class="p">(</span><span class="n">nslots</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a list of unique random integers for the number of slots.</span>

<span class="sd">    This function generates a list of `nslots` unique random integers between</span>
<span class="sd">    [`nslots` + 1, 2^32 + 1]. Intended for use in generating random seeds for individual</span>
<span class="sd">    slots when simulations are done in parallel.</span>

<span class="sd">    Args:</span>
<span class="sd">        nslots: The number of slots to generate random integers for.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import random</span>
<span class="sd">        &gt;&gt;&gt; from gempyor.utils import _nslots_random_seeds</span>
<span class="sd">        &gt;&gt;&gt; random.seed(42)</span>
<span class="sd">        &gt;&gt;&gt; _nslots_random_seeds(5)</span>
<span class="sd">        [2746317219, 478163333, 107420375, 3184935169, 1181241949]</span>
<span class="sd">        &gt;&gt;&gt; _nslots_random_seeds(5)</span>
<span class="sd">        [1051802518, 958682852, 599310831, 3163119791, 440213421]</span>
<span class="sd">        &gt;&gt;&gt; _nslots_random_seeds(1)</span>
<span class="sd">        [2906402159]</span>
<span class="sd">        &gt;&gt;&gt; _nslots_random_seeds(1)</span>
<span class="sd">        [3181143733]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_random_seeds_list</span><span class="p">(</span><span class="n">nslots</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nslots</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">gempyor</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/gempyor.html">gempyor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/gempyor.html">gempyor package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, ACCIDDA.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>