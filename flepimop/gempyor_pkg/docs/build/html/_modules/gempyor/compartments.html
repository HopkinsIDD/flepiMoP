<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>gempyor.compartments &#8212; gempyor  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for gempyor.compartments</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines class, methods, and functions necessary to establising compartments in the model.</span>

<span class="sd">Classes:</span>
<span class="sd">    Compartments: An object to handle compartment data for the model.</span>

<span class="sd">Functions:</span>
<span class="sd">    get_list_dimension: Returns length of object passed (if a list); otherwise returns 1.</span>
<span class="sd">    list_access_element_safe: Attempts to access something from the given object at specified index.</span>
<span class="sd">    list_access_element: Attempts to access soemthing from the given object at specified index.</span>
<span class="sd">    list_recursive_convert_to_string: Convert item(s) in object to str(s).</span>
<span class="sd">    compartments: A container for subcommands related to the compartmental model.</span>
<span class="sd">    plot: Generate a plot representing transition between compartments.</span>
<span class="sd">    export: Export compartment data to a CSV file.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="nn">pq</span>
<span class="kn">from</span> <span class="nn">click</span> <span class="kn">import</span> <span class="n">pass_context</span><span class="p">,</span> <span class="n">Context</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">as_list</span>
<span class="kn">from</span> <span class="nn">.shared_cli</span> <span class="kn">import</span> <span class="n">config_files_argument</span><span class="p">,</span> <span class="n">config_file_options</span><span class="p">,</span> <span class="n">parse_config_files</span><span class="p">,</span> <span class="n">cli</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Compartments">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments">[docs]</a>
<span class="k">class</span> <span class="nc">Compartments</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object to handle compartment data for the model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        times_set: Counter to track succesful data intialization from config.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Minimal object to be easily picklable for // runs</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seir_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compartments_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compartments_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transitions_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a `Compartments` object.</span>

<span class="sd">        Args:</span>
<span class="sd">            seir_config: Config file for SEIR model construction information.</span>
<span class="sd">            compartments_config: Config file for compartment information.</span>
<span class="sd">            compartments_file: File to specify compartment information.</span>
<span class="sd">            transitions_file: File to specify transition information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times_set</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">## Something like this is needed for check script:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">compartments_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">transitions_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="n">compartments_file</span><span class="p">,</span> <span class="n">transitions_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times_set</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">compartments_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constructFromConfig</span><span class="p">(</span><span class="n">seir_config</span><span class="p">,</span> <span class="n">compartments_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times_set</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Compartments object not set, no config or file provided.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Compartments.constructFromConfig">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.constructFromConfig">[docs]</a>
    <span class="k">def</span> <span class="nf">constructFromConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seir_config</span><span class="p">,</span> <span class="n">compartment_config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called by the constructor if the compartments are not loaded from a file.</span>
<span class="sd">        It will parse the compartments and transitions from the configuration files.</span>
<span class="sd">        It will populate dynamic class attributes `compartments` and `transitions`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_compartments</span><span class="p">(</span><span class="n">seir_config</span><span class="p">,</span> <span class="n">compartment_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_transitions</span><span class="p">(</span><span class="n">seir_config</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">compartments</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class="viewcode-block" id="Compartments.parse_compartments">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.parse_compartments">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_compartments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seir_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">compartment_config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses compartment configurations and returns a DataFrame of compartment names.</span>

<span class="sd">        Args:</span>
<span class="sd">            seir_config: Configuraton information for model.</span>
<span class="sd">            compartment_config: Configuration information for model comartments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A DataFrame where each row is a unique compartment and columns</span>
<span class="sd">            correspond to attributes of the compartments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compartment_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">compartment_name</span><span class="p">,</span> <span class="n">compartment_value</span> <span class="ow">in</span> <span class="n">compartment_config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">:</span> <span class="n">compartment_value</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">compartment_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">compartment_df</span> <span class="o">=</span> <span class="n">tmp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compartment_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">compartment_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
        <span class="n">compartment_df</span> <span class="o">=</span> <span class="n">compartment_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;key&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">compartment_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compartment_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">compartment_df</span></div>


<div class="viewcode-block" id="Compartments.parse_transitions">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.parse_transitions">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_transitions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">seir_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">fake_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the transitions defined in config and returns a concatenated DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            seir_config: Configuraton information for model.</span>
<span class="sd">            fake_config:</span>
<span class="sd">                Flag indicating whether or not transitions provied are placeholders.</span>
<span class="sd">                Default value is False.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A DataFrame containing all transitions from the config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_single_transition</span><span class="p">(</span><span class="n">seir_config</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">fake_config</span><span class="p">)]</span>
            <span class="p">),</span>
            <span class="n">seir_config</span><span class="p">[</span><span class="s2">&quot;transitions&quot;</span><span class="p">],</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.check_transition_element">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.check_transition_element">[docs]</a>
    <span class="k">def</span> <span class="nf">check_transition_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">single_transition_config</span><span class="p">,</span> <span class="n">problem_dimension</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Compartments.check_transition_elements">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.check_transition_elements">[docs]</a>
    <span class="k">def</span> <span class="nf">check_transition_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">single_transition_config</span><span class="p">,</span> <span class="n">problem_dimension</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Compartments.access_original_config_by_multi_index">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.access_original_config_by_multi_index">[docs]</a>
    <span class="k">def</span> <span class="nf">access_original_config_by_multi_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config_piece</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encapsulate_as_list</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dimension</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span> <span class="n">dimension</span><span class="p">)]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span> <span class="n">dimension</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">list_access_element_safe</span><span class="p">(</span><span class="n">config_piece</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">encapsulate_as_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">tmp</span></div>


<div class="viewcode-block" id="Compartments.expand_transition_elements">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.expand_transition_elements">[docs]</a>
    <span class="k">def</span> <span class="nf">expand_transition_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">single_transition_config</span><span class="p">,</span> <span class="n">problem_dimension</span><span class="p">):</span>
        <span class="n">proportion_size</span> <span class="o">=</span> <span class="n">get_list_dimension</span><span class="p">(</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">])</span>
        <span class="n">new_transition_config</span> <span class="o">=</span> <span class="n">single_transition_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># replace &quot;source&quot; by the actual source from the config</span>
        <span class="k">for</span> <span class="n">p_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">proportion_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">][</span><span class="n">p_idx</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span>
                <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">][</span><span class="n">p_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_transition_config</span><span class="p">[</span>
                    <span class="s2">&quot;source&quot;</span>
                <span class="p">]</span>

        <span class="n">temp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">problem_dimension</span><span class="p">)</span>

        <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">problem_dimension</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">problem_dimension</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">problem_dimension</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">problem_dimension</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">problem_dimension</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span>
        <span class="p">)</span>

        <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span>
            <span class="n">temp_array</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;multi_index&quot;</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># it is an iterator that will go through all the indexes of the array</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">list_recursive_convert_to_string</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">access_original_config_by_multi_index</span><span class="p">(</span>
                            <span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; in expand_transition_elements for `source:` at index &#39;</span><span class="si">{</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition source is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition destination is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;destination&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;transition_dimension: &#39;</span><span class="si">{</span><span class="n">problem_dimension</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">list_recursive_convert_to_string</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">access_original_config_by_multi_index</span><span class="p">(</span>
                            <span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">],</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; in expand_transition_elements for `destination:` at index &#39;</span><span class="si">{</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition source is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition destination is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;destination&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;transition_dimension: &#39;</span><span class="si">{</span><span class="n">problem_dimension</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">list_recursive_convert_to_string</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">access_original_config_by_multi_index</span><span class="p">(</span>
                            <span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; in expand_transition_elements for `rate:` at index &#39;</span><span class="si">{</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition source is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition destination is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;destination&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;transition_dimension: &#39;</span><span class="si">{</span><span class="n">problem_dimension</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">as_list</span><span class="p">(</span>
                    <span class="n">list_recursive_convert_to_string</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">access_original_config_by_multi_index</span><span class="p">(</span>
                                <span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">][</span><span class="n">p_idx</span><span class="p">],</span>
                                <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">,</span>
                                <span class="n">problem_dimension</span><span class="p">,</span>
                                <span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">p_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">proportion_size</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; in expand_transition_elements for `proportional_to:` at index &#39;</span><span class="si">{</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition source is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition destination is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;destination&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;transition_dimension: &#39;</span><span class="si">{</span><span class="n">problem_dimension</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;proportion_exponent&quot;</span> <span class="ow">in</span> <span class="n">single_transition_config</span>
            <span class="p">):</span>  <span class="c1"># if proportion_exponent is not defined, it is set to 1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">access_original_config_by_multi_index</span><span class="p">(</span>
                        <span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">,</span>
                        <span class="n">problem_dimension</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">list_recursive_convert_to_string</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">access_original_config_by_multi_index</span><span class="p">(</span>
                                    <span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">][</span><span class="n">p_idx</span><span class="p">],</span>
                                    <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">,</span>
                                    <span class="n">problem_dimension</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="k">for</span> <span class="n">p_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">proportion_size</span><span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; in expand_transition_elements for `proportion_exponent:` at index &#39;</span><span class="si">{</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition source is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; this transition destination is: &#39;</span><span class="si">{</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s1">&#39;destination&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;transition_dimension: &#39;</span><span class="si">{</span><span class="n">problem_dimension</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_transition_config</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;1&quot;</span>
                <span class="p">]</span> <span class="o">*</span> <span class="n">proportion_size</span>

        <span class="k">return</span> <span class="n">new_transition_config</span></div>


<div class="viewcode-block" id="Compartments.format_source">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.format_source">[docs]</a>
    <span class="k">def</span> <span class="nf">format_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_column</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">y</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">source_column</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.unformat_source">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.unformat_source">[docs]</a>
    <span class="k">def</span> <span class="nf">unformat_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_column</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">source_column</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.format_destination">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.format_destination">[docs]</a>
    <span class="k">def</span> <span class="nf">format_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination_column</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">y</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span>
                <span class="n">destination_column</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.unformat_destination">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.unformat_destination">[docs]</a>
    <span class="k">def</span> <span class="nf">unformat_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination_column</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">destination_column</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.format_rate">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.format_rate">[docs]</a>
    <span class="k">def</span> <span class="nf">format_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate_column</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">y</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%*%</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">rate_column</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.unformat_rate">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.unformat_rate">[docs]</a>
    <span class="k">def</span> <span class="nf">unformat_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate_column</span><span class="p">,</span> <span class="n">compartment_dimension</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%*%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="n">compartment_dimension</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rate_column</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rc</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">compartment_dimension</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.format_proportional_to">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.format_proportional_to">[docs]</a>
    <span class="k">def</span> <span class="nf">format_proportional_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proportional_to_column</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">y</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;+&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">as_list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                <span class="p">),</span>
                                <span class="n">x</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">),</span>
                        <span class="n">x</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="n">proportional_to_column</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.unformat_proportional_to">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.unformat_proportional_to">[docs]</a>
    <span class="k">def</span> <span class="nf">unformat_proportional_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proportional_to_column</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">proportional_to_column</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)):</span>
            <span class="n">rc</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rc</span><span class="p">[</span><span class="n">row</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="n">row</span><span class="p">])):</span>
                <span class="n">rc</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">as_list</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">elem</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.format_proportion_exponent">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.format_proportion_exponent">[docs]</a>
    <span class="k">def</span> <span class="nf">format_proportion_exponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proportion_exponent_column</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">y</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%*%</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">proportion_exponent_column</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.unformat_proportion_exponent">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.unformat_proportion_exponent">[docs]</a>
    <span class="k">def</span> <span class="nf">unformat_proportion_exponent</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">proportion_exponent_column</span><span class="p">,</span> <span class="n">compartment_dimension</span>
    <span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%*%</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">proportion_exponent_column</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)):</span>
            <span class="n">rc</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="n">compartment_dimension</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rc</span><span class="p">[</span><span class="n">row</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">rc</span><span class="p">[</span><span class="n">row</span><span class="p">]:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">compartment_dimension</span><span class="p">:</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.parse_single_transition">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.parse_single_transition">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_single_transition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">seir_config</span><span class="p">,</span> <span class="n">single_transition_config</span><span class="p">,</span> <span class="n">fake_config</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="c1">## This method relies on having run parse_compartments</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fake_config</span><span class="p">:</span>
            <span class="n">single_transition_config</span> <span class="o">=</span> <span class="n">single_transition_config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_transition_element</span><span class="p">(</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_transition_element</span><span class="p">(</span><span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">])</span>
        <span class="n">source_dimension</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">get_list_dimension</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">destination_dimension</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">get_list_dimension</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">single_transition_config</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">problem_dimension</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">source_dimension</span><span class="p">,</span> <span class="n">destination_dimension</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_transition_elements</span><span class="p">(</span><span class="n">single_transition_config</span><span class="p">,</span> <span class="n">problem_dimension</span><span class="p">)</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_transition_elements</span><span class="p">(</span>
            <span class="n">single_transition_config</span><span class="p">,</span> <span class="n">problem_dimension</span>
        <span class="p">)</span>

        <span class="n">tmp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">problem_dimension</span><span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">tmp_array</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;multi_index&quot;</span><span class="p">])</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]),</span>
            <span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]],</span>
                        <span class="s2">&quot;destination&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]],</span>
                        <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]],</span>
                        <span class="s2">&quot;proportional_to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]],</span>
                        <span class="s2">&quot;proportion_exponent&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">][</span><span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">]</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">it</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.toFile">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.toFile">[docs]</a>
    <span class="k">def</span> <span class="nf">toFile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">compartments_file</span><span class="o">=</span><span class="s2">&quot;compartments.parquet&quot;</span><span class="p">,</span>
        <span class="n">transitions_file</span><span class="o">=</span><span class="s2">&quot;transitions.parquet&quot;</span><span class="p">,</span>
        <span class="n">write_parquet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">out_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">write_parquet</span><span class="p">:</span>
            <span class="n">pa_df</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">out_df</span><span class="p">,</span> <span class="n">preserve_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">parquet</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">pa_df</span><span class="p">,</span> <span class="n">compartments_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">compartments_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">out_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_source</span><span class="p">(</span><span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
        <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_destination</span><span class="p">(</span><span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">])</span>
        <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_rate</span><span class="p">(</span><span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
        <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_proportional_to</span><span class="p">(</span><span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">])</span>
        <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_proportion_exponent</span><span class="p">(</span>
            <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">write_parquet</span><span class="p">:</span>
            <span class="n">pa_df</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">out_df</span><span class="p">,</span> <span class="n">preserve_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">parquet</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">pa_df</span><span class="p">,</span> <span class="n">transitions_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">transitions_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Compartments.fromFile">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.fromFile">[docs]</a>
    <span class="k">def</span> <span class="nf">fromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartments_file</span><span class="p">,</span> <span class="n">transitions_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">compartments_file</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">transitions_file</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">compartment_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unformat_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unformat_destination</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unformat_rate</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span> <span class="n">compartment_dimension</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unformat_proportional_to</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unformat_proportion_exponent</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">],</span> <span class="n">compartment_dimension</span>
        <span class="p">)</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="Compartments.get_comp_idx">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.get_comp_idx">[docs]</a>
    <span class="k">def</span> <span class="nf">get_comp_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">error_info</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;no information&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the index of a compartiment given a filter. The filter has to isolate a compartment,</span>
<span class="sd">        but it ignores columns that don&#39;t exist:</span>

<span class="sd">        Args:</span>
<span class="sd">            comp_dict:</span>
<span class="sd">                A dictionary where keys are compartment names and</span>
<span class="sd">                values are values to filter by for each column.</span>
<span class="sd">            error_info:</span>
<span class="sd">                A message providing additional context about where the</span>
<span class="sd">                the method was called from. Default value is &quot;no information&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Index of the comaprtment that matches the filter.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Filter results in more than one or zero matches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">comp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">comp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The provided dictionary does not allow an isolated compartment: &#39;</span><span class="si">{</span><span class="n">comp_dict</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Isolate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;The `get_comp_idx` function was called by &#39;</span><span class="si">{</span><span class="n">error_info</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">comp_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Compartments.get_ncomp">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.get_ncomp">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ncomp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compartments.get_transition_array">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.get_transition_array">[docs]</a>
    <span class="k">def</span> <span class="nf">get_transition_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the transition matrix for the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[str], np.ndarray, np.ndarray, np.ndarray]:</span>
<span class="sd">                - unique_strings: unique strings from `proportion_exponent` and `rate`</span>
<span class="sd">                - transition_array: array representing transitions and corresponding compartment indices.</span>
<span class="sd">                - proportion_array: array representing proportion compartment indices</span>
<span class="sd">                - proportion_info: array containing start and end indices for proportions</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If term is not found in list of valid compartments.</span>
<span class="sd">            ValueErrror: If any string in `rate` or `proportional_to` is an invalid candidate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;SEIR.compartments&quot;</span><span class="p">):</span>
            <span class="n">transition_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cit</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;destination&quot;</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">colname</span><span class="p">]):</span>
                    <span class="n">elem</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
                    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">compartment</span><span class="p">]</span> <span class="o">==</span> <span class="n">elem</span><span class="p">:</span>
                            <span class="n">rc</span> <span class="o">=</span> <span class="n">compartment</span>
                    <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not find &#39;</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">&#39; defined by &#39;</span><span class="si">{</span><span class="n">elem</span><span class="si">}</span><span class="s2">&#39; in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">transition_array</span><span class="p">[</span><span class="n">cit</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span>

            <span class="n">unique_strings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="c1"># candidate = candidate.replace(&quot;*1&quot;, &quot;&quot;)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">unique_strings</span><span class="p">:</span>
                        <span class="n">unique_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># candidate = candidate.replace(&quot;*1&quot;, &quot;&quot;)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">unique_strings</span><span class="p">:</span>
                    <span class="n">unique_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

            <span class="c1"># parenthesis are now supported</span>
            <span class="c1"># assert reduce(lambda a, b: a and b, [(x.find(&quot;(&quot;) == -1) for x in unique_strings])</span>
            <span class="c1"># assert reduce(lambda a, b: a and b, [(x.find(&quot;)&quot;) == -1) for x in unique_strings])</span>
            <span class="k">assert</span> <span class="n">reduce</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="p">,</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unique_strings</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">reduce</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="p">,</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unique_strings</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]):</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># candidate = candidate.replace(&quot;*1&quot;, &quot;&quot;)</span>
                <span class="k">if</span> <span class="n">candidate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_strings</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Candidate &#39;</span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">&#39; from &#39;rate&#39; column is not in the list of unique strings: </span><span class="si">{</span><span class="n">unique_strings</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_strings</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">candidate</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">transition_array</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span>

            <span class="n">current_proportion_start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">]):</span>
                <span class="n">transition_array</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_proportion_start</span>
                <span class="n">transition_array</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_proportion_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="n">current_proportion_start</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

            <span class="n">proportion_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">transition_array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
            <span class="n">current_proportion_sum_start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">current_proportion_sum_it</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">it2</span><span class="p">,</span> <span class="n">elem2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
                    <span class="n">elem_tmp</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">w</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span><span class="n">elem2</span><span class="p">))</span>
                        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">]</span>

                    <span class="c1"># for it3, elem3 in enumerate(elem_tmp):</span>
                    <span class="c1">#     rc = -1</span>
                    <span class="c1">#     for compartment in range(self.compartments.shape[0]):</span>
                    <span class="c1">#         if self.compartments[&quot;name&quot;][compartment] == elem3:</span>
                    <span class="c1">#             rc = compartment</span>
                    <span class="c1">#     if rc == -1:</span>
                    <span class="c1">#         raise ValueError(f&quot;Could not find match for {elem3} in compartments&quot;)</span>
                    <span class="n">proportion_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span>
                        <span class="n">current_proportion_sum_it</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">current_proportion_sum_start</span>
                    <span class="n">proportion_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">current_proportion_sum_it</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">current_proportion_sum_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem_tmp</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">current_proportion_sum_it</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">current_proportion_sum_start</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem_tmp</span><span class="p">)</span>
            <span class="n">proportion_compartment_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportion_exponent&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="c1"># candidate = candidate.replace(&quot;*1&quot;, &quot;&quot;)</span>
                    <span class="k">if</span> <span class="n">candidate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_strings</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Proportion exponent &#39;</span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">&#39; is not found in the list of unique strings: &#39;</span><span class="si">{</span><span class="n">unique_strings</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_strings</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">candidate</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">proportion_info</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">proportion_compartment_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span>
                    <span class="n">proportion_compartment_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">assert</span> <span class="n">proportion_compartment_index</span> <span class="o">==</span> <span class="n">current_proportion_sum_it</span>

            <span class="n">proportion_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">current_proportion_sum_start</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

            <span class="n">proportion_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="s2">&quot;proportional_to&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">it2</span><span class="p">,</span> <span class="n">elem2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
                    <span class="n">elem_tmp</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">w</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span><span class="n">elem2</span><span class="p">))</span>
                        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">]</span>

                    <span class="k">for</span> <span class="n">it3</span><span class="p">,</span> <span class="n">elem3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elem_tmp</span><span class="p">):</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">compartment</span><span class="p">]</span> <span class="o">==</span> <span class="n">elem3</span><span class="p">:</span>
                                <span class="n">rc</span> <span class="o">=</span> <span class="n">compartment</span>
                        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Could not find `proportional_to` &#39;</span><span class="si">{</span><span class="n">elem3</span><span class="si">}</span><span class="s2">&#39; in compartments. &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;Available compartments: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                            <span class="p">)</span>

                        <span class="n">proportion_array</span><span class="p">[</span><span class="n">proportion_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span>
                        <span class="n">proportion_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">## This will need to be reworked to deal with the summing bit</span>
            <span class="c1">## There will be changes needed in the steps_source too</span>
            <span class="c1">## They are doable though</span>
            <span class="c1"># for it, elem in enumerate(self.transitions[&#39;proportional_to&#39;]):</span>
            <span class="c1">#     elem = [y for y in map(</span>
            <span class="c1">#         lambda x: reduce(</span>
            <span class="c1">#             lambda a, b: str(a) + &quot;_&quot; + str(b),</span>
            <span class="c1">#             map(</span>
            <span class="c1">#                 lambda x: reduce(</span>
            <span class="c1">#                     lambda a, b: str(a) + &quot;+&quot; + str(b),</span>
            <span class="c1">#                     as_list(x)</span>
            <span class="c1">#                 ),</span>
            <span class="c1">#                 x</span>
            <span class="c1">#             )</span>
            <span class="c1">#         ),</span>
            <span class="c1">#         elem</span>
            <span class="c1">#     )]</span>
            <span class="c1">#     for it2, elem2 in enumerate(elem):</span>
            <span class="c1">#         rc = -1</span>
            <span class="c1">#         for compartment in range(self.compartments.shape[0]):</span>
            <span class="c1">#             if self.compartments[&quot;name&quot;][compartment] == elem2:</span>
            <span class="c1">#                 rc = compartment</span>
            <span class="c1">#         proportion_array[it]</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">unique_strings</span><span class="p">,</span>
            <span class="n">transition_array</span><span class="p">,</span>
            <span class="n">proportion_array</span><span class="p">,</span>
            <span class="n">proportion_info</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Compartments.parse_parameters">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.parse_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">parameter_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">unique_strings</span><span class="p">:</span> <span class="nb">list</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses provided parameters and stores them in NumPy arrays.</span>

<span class="sd">        Args:</span>
<span class="sd">            parameters: Input parameters to be parsed.</span>
<span class="sd">            parameter_names: List of all parameter names.</span>
<span class="sd">            unique_strings:</span>
<span class="sd">                List of unique values from `proportion_exponent`</span>
<span class="sd">                and `rate` columns of transitions data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Array of parsed parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parsed_parameters_old = self.parse_parameter_strings_to_numpy_arrays(parameters, parameter_names, unique_strings)</span>
        <span class="n">parsed_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_parameter_strings_to_numpy_arrays_v2</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span> <span class="n">parameter_names</span><span class="p">,</span> <span class="n">unique_strings</span>
        <span class="p">)</span>
        <span class="c1"># for i in range(len(unique_strings)):</span>
        <span class="c1">#    print(unique_strings[i], (parsed_parameters[i]==parsed_parameters_old[i]).all())</span>
        <span class="k">return</span> <span class="n">parsed_parameters</span></div>


<div class="viewcode-block" id="Compartments.parse_parameter_strings_to_numpy_arrays_v2">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.parse_parameter_strings_to_numpy_arrays_v2">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_parameter_strings_to_numpy_arrays_v2</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">parameter_names</span><span class="p">,</span> <span class="n">string_list</span>
    <span class="p">):</span>
        <span class="c1"># is using eval a better way ???</span>
        <span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sp</span>

        <span class="c1"># Validate input lengths</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Number of parameter values does not match the number of parameter names.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Define the symbols used in the formulas</span>
        <span class="n">symbolic_parameters_namespace</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parameter_names</span><span class="p">}</span>

        <span class="n">symbolic_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parameter_names</span><span class="p">]</span>

        <span class="n">parsed_formulas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="n">string_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># here it is very important to pass locals so that e.g if the  gamma parameter</span>
                <span class="c1"># is defined, it is not converted into the gamma scipy function</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="n">symbolic_parameters_namespace</span><span class="p">)</span>
                <span class="n">parsed_formulas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot parse formula &#39;</span><span class="si">{</span><span class="n">formula</span><span class="si">}</span><span class="s2">&#39; from parameters: &#39;</span><span class="si">{</span><span class="n">parameter_names</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># Print the error message for debugging</span>

        <span class="c1"># the list order needs to be right.</span>
        <span class="n">parameter_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">param</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">symbolic_parameters</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">parameter_values_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameter_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">symbolic_parameters</span><span class="p">]</span>

        <span class="c1"># Create a lambdify function for substitution</span>
        <span class="n">substitution_function</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">symbolic_parameters</span><span class="p">,</span> <span class="n">parsed_formulas</span><span class="p">)</span>

        <span class="c1"># Apply the lambdify function with parameter values as a list</span>
        <span class="n">substituted_formulas</span> <span class="o">=</span> <span class="n">substitution_function</span><span class="p">(</span><span class="o">*</span><span class="n">parameter_values_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">substituted_formulas</span><span class="p">)):</span>
            <span class="c1"># sometime it&#39;s &quot;1&quot; or &quot;1*1*1*...&quot; which produce an int or float instead of an array</span>
            <span class="c1"># in this case we find the next array and set it to that size,</span>
            <span class="c1"># TODO: instead of searching for the next array, better to just use the parameter shape.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substituted_formulas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">substituted_formulas</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substituted_formulas</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">substituted_formulas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">substituted_formulas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
                            <span class="n">substituted_formulas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">substituted_formulas</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compartments.parse_parameter_strings_to_numpy_arrays">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.parse_parameter_strings_to_numpy_arrays">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_parameter_strings_to_numpy_arrays</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="n">parameter_names</span><span class="p">,</span>
        <span class="n">string_list</span><span class="p">,</span>
        <span class="n">operator_reduce_lambdas</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span>
            <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span>
            <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">,</span>
            <span class="s2">&quot;^&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="o">**</span><span class="n">b</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">operators</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">operators</span>
        <span class="p">):</span>  <span class="c1"># empty list means all have been tried. Usually there just remains one string in string_list at that time.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not parse string &#39;</span><span class="si">{</span><span class="n">string_list</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;This usually means that &#39;</span><span class="si">{</span><span class="n">string_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; is a parameter name that is not defined &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or that it contains an operator that is not in the list of supported operators: &#39;</span><span class="si">{</span><span class="n">operators</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;The defined parameters are &#39;</span><span class="si">{</span><span class="n">parameter_names</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="n">split_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string_list</span><span class="p">]</span>
        <span class="n">rc_size</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">string_list</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">rc_size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rc_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sit</span><span class="p">,</span> <span class="n">string</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split_strings</span><span class="p">):</span>
            <span class="n">tmp_rc_size</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">tmp_rc_size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">tmp_rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp_rc_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
            <span class="n">is_numeric</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="p">]</span>
            <span class="n">is_parameter</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="ow">in</span> <span class="n">parameter_names</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="p">]</span>
            <span class="n">is_resolvable</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">is_numeric</span><span class="p">,</span> <span class="n">is_parameter</span><span class="p">)]</span>
            <span class="n">is_totally_resolvable</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="p">,</span> <span class="n">is_resolvable</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_totally_resolvable</span><span class="p">:</span>
                <span class="n">not_resolvable_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">is_resolvable</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">]</span>

                <span class="n">tmp_rc</span><span class="p">[</span><span class="n">not_resolvable_indices</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parse_parameter_strings_to_numpy_arrays</span><span class="p">(</span>
                        <span class="n">parameters</span><span class="p">,</span>
                        <span class="n">parameter_names</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">string</span><span class="p">[</span><span class="ow">not</span> <span class="n">is_resolvable</span><span class="p">]],</span>
                        <span class="n">operator_reduce_lambdas</span><span class="p">,</span>
                        <span class="n">operators</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">numeric_index</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">is_numeric</span><span class="p">))</span> <span class="k">if</span> <span class="n">is_numeric</span><span class="p">[</span><span class="n">x</span><span class="p">]]:</span>
                <span class="n">tmp_rc</span><span class="p">[</span><span class="n">numeric_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">numeric_index</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">parameter_index</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">is_parameter</span><span class="p">))</span> <span class="k">if</span> <span class="n">is_parameter</span><span class="p">[</span><span class="n">x</span><span class="p">]]:</span>
                <span class="n">parameter_name_index</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">it</span>
                    <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">string</span><span class="p">[</span><span class="n">parameter_index</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">tmp_rc</span><span class="p">[</span><span class="n">parameter_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">parameter_name_index</span><span class="p">]</span>
            <span class="n">rc</span><span class="p">[</span><span class="n">sit</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator_reduce_lambdas</span><span class="p">[</span><span class="n">operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tmp_rc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rc</span></div>


<div class="viewcode-block" id="Compartments.get_compartments_explicitDF">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.get_compartments_explicitDF">[docs]</a>
    <span class="k">def</span> <span class="nf">get_compartments_explicitDF</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a copy of the compartments information DataFrame.</span>

<span class="sd">        All columns receive a &#39;mc_&#39; prefix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the compartments DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
            <span class="n">deep</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>  <span class="c1"># .melt(id_vars=&#39;name&#39;, var_name=&#39;meta_compartment&#39;, value_name=&#39;sub_compartment&#39;)</span>
        <span class="c1"># add prefix mc to all columns, even name</span>
        <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">cn</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;mc_</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Compartments.plot">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.Compartments.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;transition_graph&quot;</span><span class="p">,</span> <span class="n">source_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">destination_filters</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">graphviz</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">partial</span>

        <span class="n">some_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_transitions</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir&quot;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">filter_func</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">this_filter</span><span class="o">=</span><span class="p">[]):</span>
            <span class="k">for</span> <span class="n">must</span> <span class="ow">in</span> <span class="n">this_filter</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">must</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">some_graph</span> <span class="o">=</span> <span class="n">some_graph</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="n">x</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                    <span class="n">partial</span><span class="p">(</span><span class="n">filter_func</span><span class="p">,</span> <span class="n">this_filter</span><span class="o">=</span><span class="n">source_filters</span><span class="p">),</span>
                    <span class="n">some_graph</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">some_graph</span> <span class="o">=</span> <span class="n">some_graph</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="n">x</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
                    <span class="n">partial</span><span class="p">(</span><span class="n">filter_func</span><span class="p">,</span> <span class="n">this_filter</span><span class="o">=</span><span class="n">destination_filters</span><span class="p">),</span>
                    <span class="n">some_graph</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>

        <span class="n">graph_description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;digraph {</span><span class="se">\n</span><span class="s2">  overlap = false;&quot;</span>
            <span class="o">+</span> <span class="n">reduce</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span>
                <span class="n">some_graph</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">])</span><span class="si">}</span><span class="s2"> [label=&quot;</span><span class="si">{</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;];&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
        <span class="p">)</span>

        <span class="n">src</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">graph_description</span><span class="p">)</span>
        <span class="n">src</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="get_list_dimension">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.get_list_dimension">[docs]</a>
<span class="k">def</span> <span class="nf">get_list_dimension</span><span class="p">(</span><span class="n">thing</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the dimension of a given object.</span>

<span class="sd">    Args:</span>
<span class="sd">        thing: Object whose dimension needs to be determined.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Length of the object if a list, otherwise 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="list_access_element_safe">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.list_access_element_safe">[docs]</a>
<span class="k">def</span> <span class="nf">list_access_element_safe</span><span class="p">(</span>
    <span class="n">thing</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encapsulate_as_list</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempts to access an element from the given object `thing` at the specified index `idx`.</span>

<span class="sd">    Args:</span>
<span class="sd">        thing: Object to be accessed from.</span>
<span class="sd">        idx: Index of object you would like to access.</span>
<span class="sd">        dimension: Dimension or shape of the object.</span>
<span class="sd">        encapsulate_as_list: If `True`, the accessed element will be returned as a list. Default is False.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If `thing` is not iterable or `idx ` is out of range.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Item at `idx` if `thing` is list, or</span>
<span class="sd">        element itself if `thing` is not a list.</span>
<span class="sd">        Returned item will be a list if `encapsulate_as_list` is `True`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">list_access_element</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">encapsulate_as_list</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in list_access_element_safe for &#39;</span><span class="si">{</span><span class="n">thing</span><span class="si">}</span><span class="s2">&#39; at index &#39;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This is often, but not always because the object above is a list (there are brackets around it). &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and in this case it is not broadcast, so if you want to it to be broadcasted, you need remove the brackets around it. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;dimension: &#39;</span><span class="si">{</span><span class="n">dimension</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="list_access_element">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.list_access_element">[docs]</a>
<span class="k">def</span> <span class="nf">list_access_element</span><span class="p">(</span>
    <span class="n">thing</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encapsulate_as_list</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Access an element from a list or return the input itself if not a list.</span>
<span class="sd">    If input `thing` is a list, the function will return the element at the specified index (`idx`).</span>
<span class="sd">    If input `thing` is not a list, the function will return the element itself, regardless of the</span>
<span class="sd">    `idx` value.</span>

<span class="sd">    Args:</span>
<span class="sd">        thing: Object to be accessed from.</span>
<span class="sd">        idx: Index of object you would like to access.</span>
<span class="sd">        dimension: Dimension or shape of the object.</span>
<span class="sd">        encapsulate_as_list: If `True`, the accessed element will be returned as a list. Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Item at `idx` if `thing` is list, or</span>
<span class="sd">        element itself if `thing` is not a list.</span>
<span class="sd">        Returned item will be a list if `encapsulate_as_list` is `True`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dimension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">as_list</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">as_list</span><span class="p">(</span><span class="n">list_access_element</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">thing</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">thing</span>
    <span class="k">if</span> <span class="n">encapsulate_as_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">as_list</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rc</span></div>



<div class="viewcode-block" id="list_recursive_convert_to_string">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.compartments.list_recursive_convert_to_string">[docs]</a>
<span class="k">def</span> <span class="nf">list_recursive_convert_to_string</span><span class="p">(</span><span class="n">thing</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return given object as a str,</span>
<span class="sd">    or recursively convert elements of given list to strs.</span>

<span class="sd">    Args:</span>
<span class="sd">        thing: Object to be converted to a str or series of strs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Value(s) in `thing` as str(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">list_recursive_convert_to_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span></div>



<span class="nd">@cli</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
<span class="nd">@pass_context</span>
<span class="k">def</span> <span class="nf">compartments</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add commands for working with FlepiMoP compartments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="nd">@compartments</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">config_files_argument</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">config_file_options</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<span class="nd">@pass_context</span>
<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command to generate a plot representing transitions between compartments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parse_config_files</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;compartments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">Compartments</span><span class="p">(</span>
        <span class="n">seir_config</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir&quot;</span><span class="p">],</span> <span class="n">compartments_config</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;compartments&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># TODO: this should be a command like build compartments.</span>
    <span class="p">(</span>
        <span class="n">unique_strings</span><span class="p">,</span>
        <span class="n">transition_array</span><span class="p">,</span>
        <span class="n">proportion_array</span><span class="p">,</span>
        <span class="n">proportion_info</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">get_transition_array</span><span class="p">()</span>

    <span class="n">comp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;transition_graph&quot;</span><span class="p">,</span> <span class="n">source_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">destination_filters</span><span class="o">=</span><span class="p">[])</span>


<span class="nd">@compartments</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">config_files_argument</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">config_file_options</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<span class="nd">@pass_context</span>
<span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export compartment information to a CSV file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parse_config_files</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;compartments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">Compartments</span><span class="p">(</span>
        <span class="n">seir_config</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir&quot;</span><span class="p">],</span> <span class="n">compartments_config</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;compartments&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="p">(</span>
        <span class="n">unique_strings</span><span class="p">,</span>
        <span class="n">transition_array</span><span class="p">,</span>
        <span class="n">proportion_array</span><span class="p">,</span>
        <span class="n">proportion_info</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">get_transition_array</span><span class="p">()</span>
    <span class="n">comp</span><span class="o">.</span><span class="n">toFile</span><span class="p">(</span><span class="s2">&quot;compartments_file.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;transitions_file.csv&quot;</span><span class="p">,</span> <span class="n">write_parquet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;wrote files &#39;compartments_file.csv&#39;, &#39;transitions_file.csv&#39; &quot;</span><span class="p">)</span>


<span class="n">cli</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">gempyor</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/gempyor.html">gempyor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/gempyor.html">gempyor package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, ACCIDDA.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>