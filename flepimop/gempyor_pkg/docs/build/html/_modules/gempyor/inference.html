<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>gempyor.inference &#8212; gempyor  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for gempyor.inference</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1">##</span>
<span class="c1"># inference.py defines handlers to the gempyor epidemic module</span>
<span class="c1"># (both (SEIR) and the pipeline outcomes module (Outcomes))</span>
<span class="c1"># so they can be used from R for inference.</span>
<span class="c1"># R folks needs to define start a python, and set some variable as describe in the notebook</span>
<span class="c1"># This populate the namespace with four functions, with return value 0 if the</span>
<span class="c1"># function terminated successfully</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes:</span>
<span class="sd">    GempyorInference:</span>
<span class="sd">        Encapsulates the process of simulation. Provides functionality for parameter</span>
<span class="sd">        inference, SEIR model execution, outcome computation, and inference optimization.</span>

<span class="sd">Functions:</span>
<span class="sd">    simulation_atomic:</span>
<span class="sd">        Runs a SEIR simulation (generates and reduces parameters, executes SEIR</span>
<span class="sd">        processes, computes outcomes, handles NPIs and seeding data).</span>
<span class="sd">    get_static_arguments: Get the static arguments for the log likelihood function.</span>
<span class="sd">    autodetect_senarios: Auto-detect the scenarios provided in config.</span>
<span class="sd">    paramred_parallel:</span>
<span class="sd">        Initializes a `GempyorInference` object with a configuration file,</span>
<span class="sd">        reads specified NPI file, and computes reduced SEIR model specifications</span>
<span class="sd">        based on this info. Returns the reduced parameters.</span>
<span class="sd">    paramred_parallel_config:</span>
<span class="sd">        Initializes a `GempyorInference` object with a configuration file,</span>
<span class="sd">        retreives SEIR model specifications and NPIs, and computes reduced</span>
<span class="sd">        parameters based on this info. Returns the reduced parameters.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="nn">pq</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">seir</span><span class="p">,</span> <span class="n">model_info</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">file_paths</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">read_df</span><span class="p">,</span> <span class="n">as_list</span>


<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLEPI_LOGLEVEL&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%(name)s</span><span class="s2"> :: </span><span class="si">%(levelname)-8s</span><span class="s2"> :: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>


<span class="c1"># TODO: should be able to draw e.g from an initial condition folder buuut keep the draw as a blob</span>
<span class="c1"># so it is saved by emcee, so I can build a posterio</span>


<span class="c1"># TODO: there is way to many of these functions, merge with the R inference.py implementation to avoid code duplication</span>
<div class="viewcode-block" id="simulation_atomic">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.simulation_atomic">[docs]</a>
<span class="k">def</span> <span class="nf">simulation_atomic</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">snpi_df_in</span><span class="p">,</span>
    <span class="n">hnpi_df_in</span><span class="p">,</span>
    <span class="n">modinf</span><span class="p">:</span> <span class="n">model_info</span><span class="o">.</span><span class="n">ModelInfo</span><span class="p">,</span>
    <span class="n">p_draw</span><span class="p">,</span>
    <span class="n">unique_strings</span><span class="p">,</span>
    <span class="n">transition_array</span><span class="p">,</span>
    <span class="n">proportion_array</span><span class="p">,</span>
    <span class="n">proportion_info</span><span class="p">,</span>
    <span class="n">initial_conditions</span><span class="p">,</span>
    <span class="n">seeding_data</span><span class="p">,</span>
    <span class="n">seeding_amounts</span><span class="p">,</span>
    <span class="n">outcomes_parameters</span><span class="p">,</span>
    <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># We need to reseed because subprocess inherit of the same random generator state.</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">))</span>
    <span class="n">random_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>

    <span class="n">npi_seir</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">build_npi_SEIR</span><span class="p">(</span>
        <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">bypass_DF</span><span class="o">=</span><span class="n">snpi_df_in</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_outcomes</span><span class="p">:</span>
        <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">build_outcome_modifiers</span><span class="p">(</span>
            <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span>
            <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">bypass_DF</span><span class="o">=</span><span class="n">hnpi_df_in</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># reduce them</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_reduce</span><span class="p">(</span><span class="n">p_draw</span><span class="p">,</span> <span class="n">npi_seir</span><span class="p">)</span>
    <span class="c1"># Parse them</span>
    <span class="n">parsed_parameters</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">parse_parameters</span><span class="p">(</span>
        <span class="n">parameters</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pnames</span><span class="p">,</span> <span class="n">unique_strings</span>
    <span class="p">)</span>

    <span class="c1"># Convert the seeding data dictionnary to a numba dictionnary</span>
    <span class="n">seeding_data_nbdict</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="n">key_type</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">unicode_type</span><span class="p">,</span> <span class="n">value_type</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">seeding_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">seeding_data_nbdict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="c1"># Compute the SEIR simulation</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">steps_SEIR</span><span class="p">(</span>
        <span class="n">modinf</span><span class="p">,</span>
        <span class="n">parsed_parameters</span><span class="p">,</span>
        <span class="n">transition_array</span><span class="p">,</span>
        <span class="n">proportion_array</span><span class="p">,</span>
        <span class="n">proportion_info</span><span class="p">,</span>
        <span class="n">initial_conditions</span><span class="p">,</span>
        <span class="n">seeding_data_nbdict</span><span class="p">,</span>
        <span class="n">seeding_amounts</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">seir</span><span class="o">.</span><span class="n">write_spar_snpi</span><span class="p">(</span><span class="n">sim_id</span><span class="o">=</span><span class="n">random_id</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span> <span class="n">p_draw</span><span class="o">=</span><span class="n">p_draw</span><span class="p">,</span> <span class="n">npi</span><span class="o">=</span><span class="n">npi_seir</span><span class="p">)</span>
        <span class="n">seir</span><span class="o">.</span><span class="n">write_seir</span><span class="p">(</span><span class="n">sim_id</span><span class="o">=</span><span class="n">random_id</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>

    <span class="c1"># Compute outcomes</span>
    <span class="n">outcomes_df</span><span class="p">,</span> <span class="n">hpar_df</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">compute_all_multioutcomes</span><span class="p">(</span>
        <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span>
        <span class="n">sim_id2write</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">outcomes_parameters</span><span class="p">,</span>
        <span class="n">loaded_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">npi</span><span class="o">=</span><span class="n">npi_outcomes</span><span class="p">,</span>
        <span class="n">bypass_seir_xr</span><span class="o">=</span><span class="n">states</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outcomes_df</span><span class="p">,</span> <span class="n">hpar</span><span class="p">,</span> <span class="n">hnpi</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">postprocess_and_write</span><span class="p">(</span>
        <span class="n">sim_id</span><span class="o">=</span><span class="n">random_id</span><span class="p">,</span>
        <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span>
        <span class="n">outcomes_df</span><span class="o">=</span><span class="n">outcomes_df</span><span class="p">,</span>
        <span class="n">hpar</span><span class="o">=</span><span class="n">hpar_df</span><span class="p">,</span>
        <span class="n">npi</span><span class="o">=</span><span class="n">npi_outcomes</span><span class="p">,</span>
        <span class="n">write</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># needs to be after write... because parquet write discard the index.</span>
    <span class="n">outcomes_df</span> <span class="o">=</span> <span class="n">outcomes_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>  <span class="c1"># after writing</span>

    <span class="k">return</span> <span class="n">outcomes_df</span></div>



<div class="viewcode-block" id="get_static_arguments">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.get_static_arguments">[docs]</a>
<span class="k">def</span> <span class="nf">get_static_arguments</span><span class="p">(</span><span class="n">modinf</span><span class="p">:</span> <span class="n">model_info</span><span class="o">.</span><span class="n">ModelInfo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the static arguments for the log likelihood function, these are the same for all walkers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;The `modinf` is required to have a parsed `compartments` attribute.&quot;</span>
        <span class="p">)</span>

    <span class="n">real_simulation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">(</span>
        <span class="n">unique_strings</span><span class="p">,</span>
        <span class="n">transition_array</span><span class="p">,</span>
        <span class="n">proportion_array</span><span class="p">,</span>
        <span class="n">proportion_info</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_transition_array</span><span class="p">()</span>

    <span class="n">outcomes_parameters</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">read_parameters_from_config</span><span class="p">(</span><span class="n">modinf</span><span class="p">)</span>
    <span class="n">npi_seir</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">seir</span><span class="o">.</span><span class="n">build_npi_SEIR</span><span class="p">(</span><span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_seir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_outcomes</span><span class="p">:</span>
        <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">build_outcome_modifiers</span><span class="p">(</span>
            <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span>
            <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">p_draw</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_quick_draw</span><span class="p">(</span>
        <span class="n">n_days</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span><span class="p">,</span> <span class="n">nsubpops</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span>
    <span class="p">)</span>

    <span class="n">initial_conditions</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">initial_conditions</span><span class="o">.</span><span class="n">get_from_config</span><span class="p">(</span><span class="n">sim_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">)</span>
    <span class="n">seeding_data</span><span class="p">,</span> <span class="n">seeding_amounts</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">get_seeding_data</span><span class="p">(</span><span class="n">sim_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># reduce them</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_reduce</span><span class="p">(</span><span class="n">p_draw</span><span class="p">,</span> <span class="n">npi_seir</span><span class="p">)</span>
    <span class="c1"># Parse them</span>
    <span class="n">parsed_parameters</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">parse_parameters</span><span class="p">(</span>
        <span class="n">parameters</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pnames</span><span class="p">,</span> <span class="n">unique_strings</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">real_simulation</span><span class="p">:</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">steps_SEIR</span><span class="p">(</span>
            <span class="n">modinf</span><span class="p">,</span>
            <span class="n">parsed_parameters</span><span class="p">,</span>
            <span class="n">transition_array</span><span class="p">,</span>
            <span class="n">proportion_array</span><span class="p">,</span>
            <span class="n">proportion_info</span><span class="p">,</span>
            <span class="n">initial_conditions</span><span class="p">,</span>
            <span class="n">seeding_data</span><span class="p">,</span>
            <span class="n">seeding_amounts</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># To avoid doing a simulation, but since we still need to run outcomes to get the hpar file,</span>
        <span class="c1"># we create a fake state array is all zero</span>
        <span class="n">compartment_coords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">compartment_df</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_compartments_explicitDF</span><span class="p">()</span>
        <span class="c1"># Iterate over columns of the DataFrame and populate the dictionary</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">compartment_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">compartment_coords</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;compartment&quot;</span><span class="p">,</span> <span class="n">compartment_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">ti</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">tf</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">compartment_coords</span><span class="p">,</span>
            <span class="n">subpop</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;mc_name&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;subpop&quot;</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="n">data_vars</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">prevalence</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;compartment&quot;</span><span class="p">,</span> <span class="s2">&quot;subpop&quot;</span><span class="p">],</span> <span class="n">zeros</span><span class="p">),</span>
                <span class="n">incidence</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;compartment&quot;</span><span class="p">,</span> <span class="s2">&quot;subpop&quot;</span><span class="p">],</span> <span class="n">zeros</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
            <span class="n">attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Dynamical simulation results&quot;</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">in_run_id</span>
            <span class="p">),</span>  <span class="c1"># TODO add more information</span>
        <span class="p">)</span>

    <span class="n">snpi_df_ref</span> <span class="o">=</span> <span class="n">npi_seir</span><span class="o">.</span><span class="n">getReductionDF</span><span class="p">()</span> <span class="k">if</span> <span class="n">npi_seir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">outcomes_df</span><span class="p">,</span> <span class="n">hpar_df</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">compute_all_multioutcomes</span><span class="p">(</span>
        <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span>
        <span class="n">sim_id2write</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">outcomes_parameters</span><span class="p">,</span>
        <span class="n">loaded_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">npi</span><span class="o">=</span><span class="n">npi_outcomes</span><span class="p">,</span>
        <span class="n">bypass_seir_xr</span><span class="o">=</span><span class="n">states</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outcomes_df_ref</span><span class="p">,</span> <span class="n">hpar_ref</span><span class="p">,</span> <span class="n">hnpi_df_ref</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">postprocess_and_write</span><span class="p">(</span>
        <span class="n">sim_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span>
        <span class="n">outcomes_df</span><span class="o">=</span><span class="n">outcomes_df</span><span class="p">,</span>
        <span class="n">hpar</span><span class="o">=</span><span class="n">hpar_df</span><span class="p">,</span>
        <span class="n">npi</span><span class="o">=</span><span class="n">npi_outcomes</span><span class="p">,</span>
        <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outcomes_df_ref</span> <span class="o">=</span> <span class="n">outcomes_df_ref</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

    <span class="c1"># need to convert to numba dict to python dict so it is pickable</span>
    <span class="n">seeding_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">seeding_data</span><span class="p">)</span>
    <span class="n">static_sim_arguments</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;snpi_df_ref&quot;</span><span class="p">:</span> <span class="n">snpi_df_ref</span><span class="p">,</span>
        <span class="s2">&quot;hnpi_df_ref&quot;</span><span class="p">:</span> <span class="n">hnpi_df_ref</span><span class="p">,</span>
        <span class="s2">&quot;p_draw&quot;</span><span class="p">:</span> <span class="n">p_draw</span><span class="p">,</span>
        <span class="s2">&quot;unique_strings&quot;</span><span class="p">:</span> <span class="n">unique_strings</span><span class="p">,</span>
        <span class="s2">&quot;transition_array&quot;</span><span class="p">:</span> <span class="n">transition_array</span><span class="p">,</span>
        <span class="s2">&quot;proportion_array&quot;</span><span class="p">:</span> <span class="n">proportion_array</span><span class="p">,</span>
        <span class="s2">&quot;proportion_info&quot;</span><span class="p">:</span> <span class="n">proportion_info</span><span class="p">,</span>
        <span class="s2">&quot;initial_conditions&quot;</span><span class="p">:</span> <span class="n">initial_conditions</span><span class="p">,</span>
        <span class="s2">&quot;seeding_data&quot;</span><span class="p">:</span> <span class="n">seeding_data</span><span class="p">,</span>
        <span class="s2">&quot;seeding_amounts&quot;</span><span class="p">:</span> <span class="n">seeding_amounts</span><span class="p">,</span>
        <span class="s2">&quot;outcomes_parameters&quot;</span><span class="p">:</span> <span class="n">outcomes_parameters</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">static_sim_arguments</span></div>



<div class="viewcode-block" id="autodetect_scenarios">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.autodetect_scenarios">[docs]</a>
<span class="k">def</span> <span class="nf">autodetect_scenarios</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Autodetect the scenarios in the config file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seir_modifiers_scenarios</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir_modifiers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir_modifiers&quot;</span><span class="p">][</span><span class="s2">&quot;scenarios&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">seir_modifiers_scenarios</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir_modifiers&quot;</span><span class="p">][</span><span class="s2">&quot;scenarios&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_str_seq</span><span class="p">()</span>

    <span class="n">outcome_modifiers_scenarios</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;outcomes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;outcome_modifiers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;outcome_modifiers&quot;</span><span class="p">][</span><span class="s2">&quot;scenarios&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">outcome_modifiers_scenarios</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;outcome_modifiers&quot;</span><span class="p">][</span>
                <span class="s2">&quot;scenarios&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">as_str_seq</span><span class="p">()</span>

    <span class="n">outcome_modifiers_scenarios</span> <span class="o">=</span> <span class="n">as_list</span><span class="p">(</span><span class="n">outcome_modifiers_scenarios</span><span class="p">)</span>
    <span class="n">seir_modifiers_scenarios</span> <span class="o">=</span> <span class="n">as_list</span><span class="p">(</span><span class="n">seir_modifiers_scenarios</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seir_modifiers_scenarios</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcome_modifiers_scenarios</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Inference only supports configuration files with one scenario, received &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;SEIR modifiers: &#39;</span><span class="si">{</span><span class="n">seir_modifiers_scenarios</span><span class="si">}</span><span class="s2">&#39;, and &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Outcomes modifiers: &#39;</span><span class="si">{</span><span class="n">outcome_modifiers_scenarios</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">seir_modifiers_scenarios</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">outcome_modifiers_scenarios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>



<span class="c1"># rewrite the get log loss functions as single functions, not in a class. This is not faster</span>
<span class="c1"># def get_logloss(proposal, inferpar, logloss, static_sim_arguments, modinf, silent=True, save=False):</span>
<span class="c1">#     if not inferpar.check_in_bound(proposal=proposal):</span>
<span class="c1">#         if not silent:</span>
<span class="c1">#             print(&quot;OUT OF BOUND!!&quot;)</span>
<span class="c1">#         return -np.inf, -np.inf, -np.inf</span>
<span class="c1">#</span>
<span class="c1">#     snpi_df_mod, hnpi_df_mod = inferpar.inject_proposal(</span>
<span class="c1">#         proposal=proposal,</span>
<span class="c1">#         snpi_df=static_sim_arguments[&quot;snpi_df_ref&quot;],</span>
<span class="c1">#         hnpi_df=static_sim_arguments[&quot;hnpi_df_ref&quot;],</span>
<span class="c1">#     )</span>
<span class="c1">#</span>
<span class="c1">#     ss = copy.deepcopy(static_sim_arguments)</span>
<span class="c1">#     ss[&quot;snpi_df_in&quot;] = snpi_df_mod</span>
<span class="c1">#     ss[&quot;hnpi_df_in&quot;] = hnpi_df_mod</span>
<span class="c1">#     del ss[&quot;snpi_df_ref&quot;]</span>
<span class="c1">#     del ss[&quot;hnpi_df_ref&quot;]</span>
<span class="c1">#</span>
<span class="c1">#     outcomes_df = simulation_atomic(**ss, modinf=modinf, save=save)</span>
<span class="c1">#</span>
<span class="c1">#     ll_total, logloss, regularizations = logloss.compute_logloss(</span>
<span class="c1">#         model_df=outcomes_df, subpop_names=modinf.subpop_struct.subpop_names</span>
<span class="c1">#     )</span>
<span class="c1">#     if not silent:</span>
<span class="c1">#         print(f&quot;llik is {ll_total}&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     return ll_total, logloss, regularizations</span>
<span class="c1">#</span>
<span class="c1"># def get_logloss_as_single_number(proposal, inferpar, logloss, static_sim_arguments, modinf, silent=True, save=False):</span>
<span class="c1">#     ll_total, logloss, regularizations = get_logloss(proposal, inferpar, logloss, static_sim_arguments, modinf, silent, save)</span>
<span class="c1">#     return ll_total</span>


<div class="viewcode-block" id="GempyorInference">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference">[docs]</a>
<span class="k">class</span> <span class="nc">GempyorInference</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to encapsulate the process of inference simulation.</span>

<span class="sd">    Provides functionality for parameter inference, SEIR model execution,</span>
<span class="sd">    outcome computation, and inference optimization.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        seir_modifiers_scenario:</span>
<span class="sd">        outcome_modifiers_scenario:</span>
<span class="sd">        modinf: A `ModelInfo` object.</span>
<span class="sd">        already_built: Flag to determine if necessary objects have been built.</span>
<span class="sd">        autowrite_seir: Flag to automatically write SEIR data after simulation.</span>
<span class="sd">        static_sim_arguments: Dictionary containing static simulation arguments.</span>
<span class="sd">        do_inference: Flag to determine if model should be run with inference.</span>
<span class="sd">        silent: Flag indicating whether to supress output messaging.</span>
<span class="sd">        save: Flag indicating whether simulation results should be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config_filepath</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="s2">&quot;test_run_id&quot;</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">first_sim_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">method_override</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;rk4&quot;</span><span class="p">,</span> <span class="s2">&quot;euler&quot;</span><span class="p">,</span> <span class="s2">&quot;stochastic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rng_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nslots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">inference_filename_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># usually for {global or chimeric}/{intermediate or final}</span>
        <span class="n">inference_filepath_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># usually for the slot_id</span>
        <span class="n">out_run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># if out_run_id is different from in_run_id, fill this</span>
        <span class="n">out_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># if out_prefix is different from in_prefix, fill this</span>
        <span class="n">path_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># in case the data folder is on another directory</span>
        <span class="n">autowrite_seir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the `GempyorInference` object by loading config, setting up the model, and configuring inference parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            config_filepath: Path to the config file.</span>
<span class="sd">            run_id: ID of the run.</span>
<span class="sd">            prefix: Prefix for files.</span>
<span class="sd">            first_sim_index: Index of first simulation, default is 1.</span>
<span class="sd">            method_override: If provided, which model stepping engine to use.</span>
<span class="sd">            rng_seed: Number of slots for parallel computation.</span>
<span class="sd">            nslots: Number of slots, default is 1.</span>
<span class="sd">            inference_filename_prefix: Prefix for inference-related file paths.</span>
<span class="sd">            inference_filepath_suffix: Suffix for inference-related file paths.</span>
<span class="sd">            out_run_id: ID for run output.</span>
<span class="sd">            out_prefix: Prefix for file paths to output.</span>
<span class="sd">            path_prefix: Prefix for paths to files (in case data folder is in another directory)</span>
<span class="sd">            autowrite_seir: Flag to automatically write SEIR data after simulation, default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Config prep</span>
        <span class="n">config</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_prefix</span><span class="p">,</span> <span class="n">config_filepath</span><span class="p">))</span>

        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seir_modifiers_scenario</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outcome_modifiers_scenario</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">autodetect_scenarios</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_id</span> <span class="o">=</span> <span class="n">file_paths</span><span class="o">.</span><span class="n">run_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seir_modifiers_scenario</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_modifiers_scenario</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                <span class="o">+</span> <span class="n">run_id</span>
                <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="p">)</span>
        <span class="n">in_run_id</span> <span class="o">=</span> <span class="n">run_id</span>
        <span class="k">if</span> <span class="n">out_run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_run_id</span> <span class="o">=</span> <span class="n">in_run_id</span>
        <span class="n">in_prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="k">if</span> <span class="n">out_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_prefix</span> <span class="o">=</span> <span class="n">in_prefix</span>

        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>

        <span class="n">write_csv</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">write_parquet</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">method_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;seir&quot;</span><span class="p">][</span><span class="s2">&quot;integration&quot;</span><span class="p">][</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">method_override</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">ModelInfo</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">nslots</span><span class="o">=</span><span class="n">nslots</span><span class="p">,</span>
            <span class="n">seir_modifiers_scenario</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seir_modifiers_scenario</span><span class="p">,</span>
            <span class="n">outcome_modifiers_scenario</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_modifiers_scenario</span><span class="p">,</span>
            <span class="n">write_csv</span><span class="o">=</span><span class="n">write_csv</span><span class="p">,</span>
            <span class="n">write_parquet</span><span class="o">=</span><span class="n">write_parquet</span><span class="p">,</span>
            <span class="n">first_sim_index</span><span class="o">=</span><span class="n">first_sim_index</span><span class="p">,</span>
            <span class="n">in_run_id</span><span class="o">=</span><span class="n">in_run_id</span><span class="p">,</span>
            <span class="n">in_prefix</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
            <span class="n">inference_filename_prefix</span><span class="o">=</span><span class="n">inference_filename_prefix</span><span class="p">,</span>
            <span class="n">inference_filepath_suffix</span><span class="o">=</span><span class="n">inference_filepath_suffix</span><span class="p">,</span>
            <span class="n">out_run_id</span><span class="o">=</span><span class="n">out_run_id</span><span class="p">,</span>
            <span class="n">out_prefix</span><span class="o">=</span><span class="n">out_prefix</span><span class="p">,</span>
            <span class="n">config_filepath</span><span class="o">=</span><span class="n">config_filepath</span><span class="p">,</span>
            <span class="n">path_prefix</span><span class="o">=</span><span class="n">path_prefix</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  gempyor &gt;&gt; Running ***</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">get_engine</span><span class="p">()</span><span class="si">}</span><span class="s2">*** engine simulation;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  gempyor &gt;&gt; ModelInfo </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">setup_name</span><span class="si">}</span><span class="s2">; index: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">first_sim_index</span><span class="si">}</span><span class="s2">; run_id: </span><span class="si">{</span><span class="n">in_run_id</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  gempyor &gt;&gt; prefix: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">in_prefix</span><span class="si">}</span><span class="s2">;&quot;&quot;&quot;</span>  <span class="c1"># ti: {s.ti}; tf: {s.tf};</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">already_built</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># whether we have already built the costly objects that need just one build</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autowrite_seir</span> <span class="o">=</span> <span class="n">autowrite_seir</span>

        <span class="c1">## Inference Stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_sim_arguments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_inference</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inference&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">inference_parameter</span><span class="p">,</span> <span class="n">logloss</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inference&quot;</span><span class="p">][</span><span class="s2">&quot;method&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;emcee&quot;</span><span class="p">:</span>
                <span class="c1"># Generates the static_sim_arguments only if this is a config argument.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">static_sim_arguments</span> <span class="o">=</span> <span class="n">get_static_arguments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">do_inference</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inference_method</span> <span class="o">=</span> <span class="s2">&quot;emcee&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inferpar</span> <span class="o">=</span> <span class="n">inference_parameter</span><span class="o">.</span><span class="n">InferenceParameters</span><span class="p">(</span>
                    <span class="n">global_config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">subpop_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logloss</span> <span class="o">=</span> <span class="n">logloss</span><span class="o">.</span><span class="n">LogLoss</span><span class="p">(</span>
                    <span class="n">inference_config</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;inference&quot;</span><span class="p">],</span>
                    <span class="n">path_prefix</span><span class="o">=</span><span class="n">path_prefix</span><span class="p">,</span>
                    <span class="n">subpop_struct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="p">,</span>
                    <span class="n">time_setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">time_setup</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running Gempyor Inference&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logloss</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inferpar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="GempyorInference.set_silent">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.set_silent">[docs]</a>
    <span class="k">def</span> <span class="nf">set_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">silent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="n">silent</span></div>


<div class="viewcode-block" id="GempyorInference.set_save">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.set_save">[docs]</a>
    <span class="k">def</span> <span class="nf">set_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">save</span></div>


<div class="viewcode-block" id="GempyorInference.get_all_sim_arguments">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_all_sim_arguments">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_sim_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># inferpar, logloss, static_sim_arguments, modinf, proposal, silent, save</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inferpar</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logloss</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static_sim_arguments</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">,</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="GempyorInference.simulate_proposal">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.simulate_proposal">[docs]</a>
    <span class="k">def</span> <span class="nf">simulate_proposal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposal</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inferpar</span><span class="o">.</span><span class="n">check_in_bound</span><span class="p">(</span><span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;`llik` is -inf (out of bound proposal).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">snpi_df_mod</span><span class="p">,</span> <span class="n">hnpi_df_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inferpar</span><span class="o">.</span><span class="n">inject_proposal</span><span class="p">(</span>
            <span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">,</span>
            <span class="n">snpi_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">static_sim_arguments</span><span class="p">[</span><span class="s2">&quot;snpi_df_ref&quot;</span><span class="p">],</span>
            <span class="n">hnpi_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">static_sim_arguments</span><span class="p">[</span><span class="s2">&quot;hnpi_df_ref&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">ss</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_sim_arguments</span><span class="p">)</span>
        <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;snpi_df_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snpi_df_mod</span>
        <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;hnpi_df_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hnpi_df_mod</span>
        <span class="k">del</span> <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;snpi_df_ref&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;hnpi_df_ref&quot;</span><span class="p">]</span>

        <span class="n">outcomes_df</span> <span class="o">=</span> <span class="n">simulation_atomic</span><span class="p">(</span><span class="o">**</span><span class="n">ss</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outcomes_df</span></div>


<div class="viewcode-block" id="GempyorInference.get_logloss">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_logloss">[docs]</a>
    <span class="k">def</span> <span class="nf">get_logloss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposal</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inferpar</span><span class="o">.</span><span class="n">check_in_bound</span><span class="p">(</span><span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OUT OF BOUND!!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">outcomes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_proposal</span><span class="p">(</span><span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">)</span>

        <span class="n">ll_total</span><span class="p">,</span> <span class="n">logloss</span><span class="p">,</span> <span class="n">regularizations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logloss</span><span class="o">.</span><span class="n">compute_logloss</span><span class="p">(</span>
            <span class="n">model_df</span><span class="o">=</span><span class="n">outcomes_df</span><span class="p">,</span> <span class="n">subpop_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;llik is &#39;</span><span class="si">{</span><span class="n">ll_total</span><span class="si">}</span><span class="s2">&#39; &quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ll_total</span><span class="p">,</span> <span class="n">logloss</span><span class="p">,</span> <span class="n">regularizations</span></div>


<div class="viewcode-block" id="GempyorInference.get_logloss_as_single_number">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_logloss_as_single_number">[docs]</a>
    <span class="k">def</span> <span class="nf">get_logloss_as_single_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposal</span><span class="p">):</span>
        <span class="n">ll_total</span><span class="p">,</span> <span class="n">logloss</span><span class="p">,</span> <span class="n">regularizations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_logloss</span><span class="p">(</span><span class="n">proposal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ll_total</span></div>


<div class="viewcode-block" id="GempyorInference.perform_test_run">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.perform_test_run">[docs]</a>
    <span class="k">def</span> <span class="nf">perform_test_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_sim_arguments</span><span class="p">)</span>

        <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;snpi_df_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;snpi_df_ref&quot;</span><span class="p">]</span>
        <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;hnpi_df_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;hnpi_df_ref&quot;</span><span class="p">]</span>
        <span class="c1"># delete the ref</span>
        <span class="k">del</span> <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;snpi_df_ref&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">ss</span><span class="p">[</span><span class="s2">&quot;hnpi_df_ref&quot;</span><span class="p">]</span>

        <span class="n">hosp</span> <span class="o">=</span> <span class="n">simulation_atomic</span><span class="p">(</span><span class="o">**</span><span class="n">ss</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">)</span>

        <span class="n">ll_total</span><span class="p">,</span> <span class="n">logloss</span><span class="p">,</span> <span class="n">regularizations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logloss</span><span class="o">.</span><span class="n">compute_logloss</span><span class="p">(</span>
            <span class="n">model_df</span><span class="o">=</span><span class="n">hosp</span><span class="p">,</span> <span class="n">subpop_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;test run successful 🎉, with logloss=</span><span class="si">{</span><span class="n">ll_total</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> including </span><span class="si">{</span><span class="n">regularizations</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> for regularization (</span><span class="si">{</span><span class="n">regularizations</span><span class="o">/</span><span class="n">ll_total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%) &quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hosp</span><span class="p">,</span> <span class="n">ll_total</span><span class="p">,</span> <span class="n">logloss</span><span class="p">,</span> <span class="n">regularizations</span></div>


<div class="viewcode-block" id="GempyorInference.update_prefix">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.update_prefix">[docs]</a>
    <span class="k">def</span> <span class="nf">update_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_prefix</span><span class="p">,</span> <span class="n">new_out_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">in_prefix</span> <span class="o">=</span> <span class="n">new_prefix</span>
        <span class="k">if</span> <span class="n">new_out_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="n">new_prefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="n">new_out_prefix</span></div>


<div class="viewcode-block" id="GempyorInference.update_run_id">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.update_run_id">[docs]</a>
    <span class="k">def</span> <span class="nf">update_run_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_run_id</span><span class="p">,</span> <span class="n">new_out_run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">in_run_id</span> <span class="o">=</span> <span class="n">new_run_id</span>
        <span class="k">if</span> <span class="n">new_out_run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">out_run_id</span> <span class="o">=</span> <span class="n">new_run_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">out_run_id</span> <span class="o">=</span> <span class="n">new_out_run_id</span></div>


<div class="viewcode-block" id="GempyorInference.one_simulation_legacy">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.one_simulation_legacy">[docs]</a>
    <span class="k">def</span> <span class="nf">one_simulation_legacy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sim_id2write</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">load_ID</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">sim_id2write</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim_id2write</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">load_ID</span><span class="p">:</span>
            <span class="n">sim_id2load</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim_id2load</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; GEMPYOR onesim </span><span class="si">{</span><span class="s1">&#39;(loading file)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">load_ID</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;(from config)&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">):</span>
            <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_SEIR&quot;</span><span class="p">):</span>
                <span class="n">seir</span><span class="o">.</span><span class="n">onerun_SEIR</span><span class="p">(</span>
                    <span class="n">sim_id2write</span><span class="o">=</span><span class="n">sim_id2write</span><span class="p">,</span>
                    <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                    <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span>
                    <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">outcomes_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_OUTCOMES&quot;</span><span class="p">):</span>
                    <span class="n">outcomes</span><span class="o">.</span><span class="n">onerun_delayframe_outcomes</span><span class="p">(</span>
                        <span class="n">sim_id2write</span><span class="o">=</span><span class="n">sim_id2write</span><span class="p">,</span>
                        <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                        <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span>
                        <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="GempyorInference.build_structure">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.build_structure">[docs]</a>
    <span class="k">def</span> <span class="nf">build_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_strings</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transition_array</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proportion_array</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proportion_info</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_transition_array</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">already_built</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="GempyorInference.write_last_seir">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.write_last_seir">[docs]</a>
    <span class="k">def</span> <span class="nf">write_last_seir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_id2write</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sim_id2write</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sim_id2write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_sim_id2write</span>
        <span class="n">out_df</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">write_seir</span><span class="p">(</span><span class="n">sim_id2write</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_states</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_df</span></div>


    <span class="c1"># @profile()</span>
<div class="viewcode-block" id="GempyorInference.one_simulation">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.one_simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">one_simulation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sim_id2write</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">load_ID</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sim_id2load</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to oversee inference simulation.</span>
<span class="sd">        You can optionally load previous simulation data as well.</span>

<span class="sd">        Args:</span>
<span class="sd">            sim_id2write: ID of the simulation to be written.</span>
<span class="sd">            load_ID: Wether to load a previous simulation&#39;s data, default is False.</span>
<span class="sd">            sim_id2load: ID of simulation to be loaded.</span>
<span class="sd">            parallel: Whether to run simulation in parallel chains, default is False.</span>

<span class="sd">        Returns: 0</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `load_ID` is True and `sim_id2load` is not provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_id2write</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim_id2write</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_sim_id2write</span> <span class="o">=</span> <span class="n">sim_id2write</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_loadID</span> <span class="o">=</span> <span class="n">load_ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_sim_id2load</span> <span class="o">=</span> <span class="n">sim_id2load</span>
        <span class="k">if</span> <span class="n">load_ID</span><span class="p">:</span>
            <span class="n">sim_id2load</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim_id2load</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_sim_id2load</span> <span class="o">=</span> <span class="n">sim_id2load</span>

        <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; GEMPYOR onesim </span><span class="si">{</span><span class="s1">&#39;(loading file)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">load_ID</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;(from config)&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_built</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">outcomes_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outcomes_parameters</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">read_parameters_from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">)</span>

            <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">npi_seir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;//things&quot;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span>
                        <span class="n">max_workers</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">seir_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_seir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="p">):</span>
                            <span class="n">ret_seir</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                                <span class="n">seir</span><span class="o">.</span><span class="n">build_npi_SEIR</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                                <span class="n">load_ID</span><span class="p">,</span>
                                <span class="n">sim_id2load</span><span class="p">,</span>
                                <span class="n">config</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">outcomes_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_outcomes</span>
                        <span class="p">):</span>
                            <span class="n">ret_outcomes</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                                <span class="n">outcomes</span><span class="o">.</span><span class="n">build_outcome_modifiers</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                                <span class="n">load_ID</span><span class="p">,</span>
                                <span class="n">sim_id2load</span><span class="p">,</span>
                                <span class="n">config</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_built</span><span class="p">:</span>
                            <span class="n">ret_comparments</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_transition_array</span>
                            <span class="p">)</span>

                <span class="c1"># print(&quot;expections:&quot;, ret_seir.exception(), ret_outcomes.exception(), ret_comparments.exception())</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_built</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unique_strings</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">transition_array</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proportion_array</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proportion_info</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">ret_comparments</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">already_built</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">seir_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_seir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="n">npi_seir</span> <span class="o">=</span> <span class="n">ret_seir</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">outcomes_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_outcomes</span>
                <span class="p">):</span>
                    <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="n">ret_outcomes</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_built</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build_structure</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">seir_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_seir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="n">npi_seir</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">build_npi_SEIR</span><span class="p">(</span>
                        <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                        <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span>
                        <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">outcomes_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_outcomes</span>
                <span class="p">):</span>
                    <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">build_outcome_modifiers</span><span class="p">(</span>
                        <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                        <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span>
                        <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_npi_seir</span> <span class="o">=</span> <span class="n">npi_seir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_npi_outcomes</span> <span class="o">=</span> <span class="n">npi_outcomes</span>
            <span class="c1">### Run every time:</span>
            <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;SEIR.parameters&quot;</span><span class="p">):</span>
                <span class="c1"># Draw or load parameters</span>

                <span class="n">p_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seir_parameters</span><span class="p">(</span><span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">)</span>
                <span class="c1"># reduce them</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_reduce</span><span class="p">(</span><span class="n">p_draw</span><span class="p">,</span> <span class="n">npi_seir</span><span class="p">)</span>
                <span class="c1"># Parse them</span>
                <span class="n">parsed_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">parse_parameters</span><span class="p">(</span>
                    <span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_strings</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_p_draw</span> <span class="o">=</span> <span class="n">p_draw</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_parameters</span> <span class="o">=</span> <span class="n">parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_parsed_parameters</span> <span class="o">=</span> <span class="n">parsed_parameters</span>

            <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_SEIR.seeding&quot;</span><span class="p">):</span>
                <span class="n">seeding_data</span><span class="p">,</span> <span class="n">seeding_amounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">get_seeding_data</span><span class="p">(</span>
                    <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id2load</span> <span class="k">if</span> <span class="n">load_ID</span> <span class="k">else</span> <span class="n">sim_id2write</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">load_ID</span><span class="p">:</span>
                    <span class="n">initial_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">initial_conditions</span><span class="o">.</span><span class="n">get_from_file</span><span class="p">(</span>
                        <span class="n">sim_id2load</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">initial_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">initial_conditions</span><span class="o">.</span><span class="n">get_from_config</span><span class="p">(</span>
                        <span class="n">sim_id2write</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_seeding_data</span> <span class="o">=</span> <span class="n">seeding_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_seeding_amounts</span> <span class="o">=</span> <span class="n">seeding_amounts</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_initial_conditions</span> <span class="o">=</span> <span class="n">initial_conditions</span>

            <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;SEIR.compute&quot;</span><span class="p">):</span>
                <span class="n">states</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">steps_SEIR</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                    <span class="n">parsed_parameters</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transition_array</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proportion_array</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proportion_info</span><span class="p">,</span>
                    <span class="n">initial_conditions</span><span class="p">,</span>
                    <span class="n">seeding_data</span><span class="p">,</span>
                    <span class="n">seeding_amounts</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_states</span> <span class="o">=</span> <span class="n">states</span>

            <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;SEIR.postprocess&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">write_csv</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">:</span>
                    <span class="n">seir</span><span class="o">.</span><span class="n">write_spar_snpi</span><span class="p">(</span><span class="n">sim_id2write</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span> <span class="n">p_draw</span><span class="p">,</span> <span class="n">npi_seir</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autowrite_seir</span><span class="p">:</span>
                        <span class="n">out_df</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">write_seir</span><span class="p">(</span><span class="n">sim_id2write</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span> <span class="n">states</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_out_df</span> <span class="o">=</span> <span class="n">out_df</span>

            <span class="n">loaded_values</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">load_ID</span><span class="p">:</span>
                <span class="n">loaded_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">read_simID</span><span class="p">(</span><span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;hpar&quot;</span><span class="p">,</span> <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_loaded_values</span> <span class="o">=</span> <span class="n">loaded_values</span>

            <span class="c1"># Compute outcomes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">outcomes_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_delayframe_outcomes.compute&quot;</span><span class="p">):</span>
                    <span class="n">outcomes_df</span><span class="p">,</span> <span class="n">hpar_df</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">compute_all_multioutcomes</span><span class="p">(</span>
                        <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                        <span class="n">sim_id2write</span><span class="o">=</span><span class="n">sim_id2write</span><span class="p">,</span>
                        <span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcomes_parameters</span><span class="p">,</span>
                        <span class="n">loaded_values</span><span class="o">=</span><span class="n">loaded_values</span><span class="p">,</span>
                        <span class="n">npi</span><span class="o">=</span><span class="n">npi_outcomes</span><span class="p">,</span>
                        <span class="n">bypass_seir_xr</span><span class="o">=</span><span class="n">states</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_outcomes_df</span> <span class="o">=</span> <span class="n">outcomes_df</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lastsim_hpar_df</span> <span class="o">=</span> <span class="n">hpar_df</span>

                <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_delayframe_outcomes.postprocess&quot;</span><span class="p">):</span>
                    <span class="n">outcomes</span><span class="o">.</span><span class="n">postprocess_and_write</span><span class="p">(</span>
                        <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id2write</span><span class="p">,</span>
                        <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                        <span class="n">outcomes_df</span><span class="o">=</span><span class="n">outcomes_df</span><span class="p">,</span>
                        <span class="n">hpar</span><span class="o">=</span><span class="n">hpar_df</span><span class="p">,</span>
                        <span class="n">npi</span><span class="o">=</span><span class="n">npi_outcomes</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="GempyorInference.plot_transition_graph">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.plot_transition_graph">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_transition_graph</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;transition_graph&quot;</span><span class="p">,</span> <span class="n">source_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">destination_filters</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span>
            <span class="n">source_filters</span><span class="o">=</span><span class="n">source_filters</span><span class="p">,</span>
            <span class="n">destination_filters</span><span class="o">=</span><span class="n">destination_filters</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GempyorInference.get_outcome_npi">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_outcome_npi">[docs]</a>
    <span class="k">def</span> <span class="nf">get_outcome_npi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass_DF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass_FN</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the non-pharmaceutical intervention outcome modifiers.</span>

<span class="sd">        Args:</span>
<span class="sd">            load_ID: Whether to load a previous simulation&#39;s data.</span>
<span class="sd">            sim_id2load: ID of simulation to be loaded.</span>
<span class="sd">            bypass_DF: An alternative data frame to use during outcome modifier construction.</span>
<span class="sd">            bypass_FN: An alternative function to use during outcome modifier construction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An object that contains computed NPI outcome modifiers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_outcomes</span><span class="p">:</span>
            <span class="n">npi_outcomes</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">.</span><span class="n">build_outcome_modifiers</span><span class="p">(</span>
                <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
                <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span>
                <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">bypass_DF</span><span class="o">=</span><span class="n">bypass_DF</span><span class="p">,</span>
                <span class="n">bypass_FN</span><span class="o">=</span><span class="n">bypass_FN</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">npi_outcomes</span></div>


<div class="viewcode-block" id="GempyorInference.get_seir_npi">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_seir_npi">[docs]</a>
    <span class="k">def</span> <span class="nf">get_seir_npi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass_DF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass_FN</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the SEIR non-pharmaceutical interventions information.</span>

<span class="sd">        Args:</span>
<span class="sd">            load_ID: Whether to load a previous simulation&#39;s data, default is False.</span>
<span class="sd">            sim_id2load: ID of simulation to be loaded.</span>
<span class="sd">            bypass_DF: An alternative data frame to use during outcome modifier construction.</span>
<span class="sd">            bypass_FN: An alternative function to use during outcome modifier construction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            npi_seir: An object that contains NPI parameters for the SEIR model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">npi_seir</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">build_npi_SEIR</span><span class="p">(</span>
            <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span>
            <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span>
            <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">bypass_DF</span><span class="o">=</span><span class="n">bypass_DF</span><span class="p">,</span>
            <span class="n">bypass_FN</span><span class="o">=</span><span class="n">bypass_FN</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">npi_seir</span></div>


<div class="viewcode-block" id="GempyorInference.get_seir_parameters">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_seir_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_seir_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass_DF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass_FN</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates SEIR model parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            load_ID: Whether to load a previous simulation&#39;s data, default is False.</span>
<span class="sd">            sim_id2load: ID of simulation to be loaded.</span>
<span class="sd">            bypass_DF: An alternative data frame to use during outcome modifier construction.</span>
<span class="sd">            bypass_FN: An alternative function to use during outcome modifier construction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            p_draw: An array containing the drawn model parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bypass_DF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_df</span> <span class="o">=</span> <span class="n">bypass_DF</span>
        <span class="k">elif</span> <span class="n">bypass_FN</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_df</span> <span class="o">=</span> <span class="n">read_df</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">bypass_FN</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">load_ID</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">param_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">read_simID</span><span class="p">(</span><span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;spar&quot;</span><span class="p">,</span> <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">param_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_load</span><span class="p">(</span>
                <span class="n">param_df</span><span class="o">=</span><span class="n">param_df</span><span class="p">,</span>
                <span class="n">n_days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span><span class="p">,</span>
                <span class="n">nsubpops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_quick_draw</span><span class="p">(</span>
                <span class="n">n_days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span><span class="p">,</span> <span class="n">nsubpops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">p_draw</span></div>


<div class="viewcode-block" id="GempyorInference.get_seir_parametersDF">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_seir_parametersDF">[docs]</a>
    <span class="k">def</span> <span class="nf">get_seir_parametersDF</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass_DF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bypass_FN</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retreive SEIR parameters and return them as a pd.DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            load_ID: Whether to load a previous simulation&#39;s data, default is False.</span>
<span class="sd">            sim_id2load: ID of simulation to be loaded.</span>
<span class="sd">            bypass_DF: An alternative data frame to use during outcome modifier construction.</span>
<span class="sd">            bypass_FN: An alternative function to use during outcome modifier construction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pd.DatyaFrame containing the SEIR model parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seir_parameters</span><span class="p">(</span>
            <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span>
            <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span>
            <span class="n">bypass_DF</span><span class="o">=</span><span class="n">bypass_DF</span><span class="p">,</span>
            <span class="n">bypass_FN</span><span class="o">=</span><span class="n">bypass_FN</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">getParameterDF</span><span class="p">(</span><span class="n">p_draw</span><span class="o">=</span><span class="n">p_draw</span><span class="p">)</span></div>


<div class="viewcode-block" id="GempyorInference.get_seir_parameter_reduced">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_seir_parameter_reduced">[docs]</a>
    <span class="k">def</span> <span class="nf">get_seir_parameter_reduced</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">npi_seir</span><span class="p">,</span>
        <span class="n">p_draw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bypass_DF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bypass_FN</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retreives and reduces SEIR model parameters and returns them as a pd.DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            npi_seir: A dictionary of NPI parameters.</span>
<span class="sd">            p_draw: An array containing drawn model parameters.</span>
<span class="sd">            load_ID: Whether to load a previous simulation&#39;s data, default is False.</span>
<span class="sd">            sim_id2load: ID of simulation to be loaded.</span>
<span class="sd">            bypass_DF: An alternative data frame to use during outcome modifier construction.</span>
<span class="sd">            bypass_FN: An alternative function to use during outcome modifier construction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pd.DataFrame containing reduced SEIR model parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p_draw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seir_parameters</span><span class="p">(</span>
                <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span>
                <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span>
                <span class="n">bypass_DF</span><span class="o">=</span><span class="n">bypass_DF</span><span class="p">,</span>
                <span class="n">bypass_FN</span><span class="o">=</span><span class="n">bypass_FN</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_reduce</span><span class="p">(</span><span class="n">p_draw</span><span class="p">,</span> <span class="n">npi_seir</span><span class="p">)</span>

        <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subpop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">parameters</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pnames</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">ti</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">tf</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">a</span><span class="p">[</span><span class="s2">&quot;subpop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subpop</span>
            <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_df</span><span class="p">,</span> <span class="n">a</span><span class="p">])</span>

        <span class="c1"># for R, duplicate names are not allowed in index:</span>
        <span class="n">full_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">full_df</span> <span class="o">=</span> <span class="n">full_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">full_df</span></div>


    <span class="c1"># TODO these function should support bypass</span>
<div class="viewcode-block" id="GempyorInference.get_parsed_parameters_seir">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_parsed_parameters_seir">[docs]</a>
    <span class="k">def</span> <span class="nf">get_parsed_parameters_seir</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># bypass_DF=None,</span>
        <span class="c1"># bypass_FN=None,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_built</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_structure</span><span class="p">()</span>

        <span class="n">npi_seir</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">build_npi_SEIR</span><span class="p">(</span>
            <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span>
        <span class="p">)</span>
        <span class="n">p_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seir_parameters</span><span class="p">(</span><span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_reduce</span><span class="p">(</span><span class="n">p_draw</span><span class="p">,</span> <span class="n">npi_seir</span><span class="p">)</span>

        <span class="n">parsed_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">parse_parameters</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_strings</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parsed_parameters</span></div>


<div class="viewcode-block" id="GempyorInference.get_reduced_parameters_seir">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.GempyorInference.get_reduced_parameters_seir">[docs]</a>
    <span class="k">def</span> <span class="nf">get_reduced_parameters_seir</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># bypass_DF=None,</span>
        <span class="c1"># bypass_FN=None,</span>
    <span class="p">):</span>
        <span class="n">npi_seir</span> <span class="o">=</span> <span class="n">seir</span><span class="o">.</span><span class="n">build_npi_SEIR</span><span class="p">(</span>
            <span class="n">modinf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span>
        <span class="p">)</span>
        <span class="n">p_draw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seir_parameters</span><span class="p">(</span><span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_reduce</span><span class="p">(</span><span class="n">p_draw</span><span class="p">,</span> <span class="n">npi_seir</span><span class="p">)</span>

        <span class="n">parsed_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">parse_parameters</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_strings</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parsed_parameters</span></div>
</div>



<div class="viewcode-block" id="paramred_parallel">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.paramred_parallel">[docs]</a>
<span class="k">def</span> <span class="nf">paramred_parallel</span><span class="p">(</span><span class="n">run_spec</span><span class="p">,</span> <span class="n">snpi_fn</span><span class="p">):</span>
    <span class="n">config_filepath</span> <span class="o">=</span> <span class="n">run_spec</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
    <span class="n">gempyor_inference</span> <span class="o">=</span> <span class="n">GempyorInference</span><span class="p">(</span>
        <span class="n">config_filepath</span><span class="o">=</span><span class="n">config_filepath</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="s2">&quot;test_run_id&quot;</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;test_prefix/&quot;</span><span class="p">,</span>
        <span class="n">first_sim_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">seir_modifiers_scenario</span><span class="o">=</span><span class="s2">&quot;inference&quot;</span><span class="p">,</span>  <span class="c1"># NPIs scenario to use</span>
        <span class="n">outcome_modifiers_scenario</span><span class="o">=</span><span class="s2">&quot;med&quot;</span><span class="p">,</span>  <span class="c1"># Outcome scenario to use</span>
        <span class="n">path_prefix</span><span class="o">=</span><span class="n">run_spec</span><span class="p">[</span>
            <span class="s2">&quot;geodata&quot;</span>
        <span class="p">],</span>  <span class="c1"># prefix where to find the folder indicated in subpop_setup$</span>
    <span class="p">)</span>

    <span class="n">snpi</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">snpi_fn</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

    <span class="n">npi_seir</span> <span class="o">=</span> <span class="n">gempyor_inference</span><span class="o">.</span><span class="n">get_seir_npi</span><span class="p">(</span><span class="n">bypass_DF</span><span class="o">=</span><span class="n">snpi</span><span class="p">)</span>

    <span class="c1"># params_draw_df = gempyor_inference.get_seir_parametersDF()  # could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=&lt;some_spar_df&gt;) or (bypass_FN=&lt;some_spar_filename&gt;)</span>
    <span class="n">params_draw_arr</span> <span class="o">=</span> <span class="n">gempyor_inference</span><span class="o">.</span><span class="n">get_seir_parameters</span><span class="p">(</span>
        <span class="n">bypass_FN</span><span class="o">=</span><span class="n">snpi_fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;snpi&quot;</span><span class="p">,</span> <span class="s2">&quot;spar&quot;</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=&lt;some_spar_df&gt;) or (bypass_FN=&lt;some_spar_filename&gt;)</span>
    <span class="n">param_reduc_from</span> <span class="o">=</span> <span class="n">gempyor_inference</span><span class="o">.</span><span class="n">get_seir_parameter_reduced</span><span class="p">(</span>
        <span class="n">npi_seir</span><span class="o">=</span><span class="n">npi_seir</span><span class="p">,</span> <span class="n">p_draw</span><span class="o">=</span><span class="n">params_draw_arr</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">param_reduc_from</span></div>



<div class="viewcode-block" id="paramred_parallel_config">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.inference.paramred_parallel_config">[docs]</a>
<span class="k">def</span> <span class="nf">paramred_parallel_config</span><span class="p">(</span><span class="n">run_spec</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
    <span class="n">config_filepath</span> <span class="o">=</span> <span class="n">run_spec</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
    <span class="n">gempyor_inference</span> <span class="o">=</span> <span class="n">GempyorInference</span><span class="p">(</span>
        <span class="n">config_filepath</span><span class="o">=</span><span class="n">config_filepath</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="s2">&quot;test_run_id&quot;</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;test_prefix/&quot;</span><span class="p">,</span>
        <span class="n">first_sim_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">seir_modifiers_scenario</span><span class="o">=</span><span class="s2">&quot;inference&quot;</span><span class="p">,</span>  <span class="c1"># NPIs scenario to use</span>
        <span class="n">outcome_modifiers_scenario</span><span class="o">=</span><span class="s2">&quot;med&quot;</span><span class="p">,</span>  <span class="c1"># Outcome scenario to use</span>
        <span class="n">path_prefix</span><span class="o">=</span><span class="n">run_spec</span><span class="p">[</span>
            <span class="s2">&quot;geodata&quot;</span>
        <span class="p">],</span>  <span class="c1"># prefix where to find the folder indicated in subpop_setup$</span>
    <span class="p">)</span>

    <span class="n">npi_seir</span> <span class="o">=</span> <span class="n">gempyor_inference</span><span class="o">.</span><span class="n">get_seir_npi</span><span class="p">()</span>

    <span class="n">params_draw_arr</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gempyor_inference</span><span class="o">.</span><span class="n">get_seir_parameters</span><span class="p">()</span>
    <span class="p">)</span>  <span class="c1"># could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=&lt;some_spar_df&gt;) or (bypass_FN=&lt;some_spar_filename&gt;)</span>
    <span class="n">param_reduc_from</span> <span class="o">=</span> <span class="n">gempyor_inference</span><span class="o">.</span><span class="n">get_seir_parameter_reduced</span><span class="p">(</span>
        <span class="n">npi_seir</span><span class="o">=</span><span class="n">npi_seir</span><span class="p">,</span> <span class="n">p_draw</span><span class="o">=</span><span class="n">params_draw_arr</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">param_reduc_from</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">gempyor</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/gempyor.html">gempyor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/gempyor.html">gempyor package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, ACCIDDA.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>