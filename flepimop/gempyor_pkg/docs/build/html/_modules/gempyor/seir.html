<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>gempyor.seir &#8212; gempyor  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for gempyor.seir</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">tqdm.contrib.concurrent</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">NPI</span><span class="p">,</span> <span class="n">steps_rk4</span>
<span class="kn">from</span> <span class="nn">.model_info</span> <span class="kn">import</span> <span class="n">ModelInfo</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">_nslots_random_seeds</span><span class="p">,</span> <span class="n">read_df</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="check_parameter_positivity">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.check_parameter_positivity">[docs]</a>
<span class="k">def</span> <span class="nf">check_parameter_positivity</span><span class="p">(</span>
    <span class="n">parsed_parameters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">parameter_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">dates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span>
    <span class="n">subpop_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identifies and reports earliest negative values for parameters after modifiers have been applied.</span>

<span class="sd">    Args:</span>
<span class="sd">        parsed_parameters: An array of parameter values.</span>
<span class="sd">        parameter_names: A list of the names of parameters.</span>
<span class="sd">        dates: A pandas DatetimeIndex containing the dates.</span>
<span class="sd">        subpop_names: A list of the names of subpopulations.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Negative parameter values were detected.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_index_parameters</span> <span class="o">:=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">parsed_parameters</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">unique_param_sp_combinations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">row_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">redundant_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">negative_index_parameters</span><span class="p">:</span>
            <span class="n">row_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">in</span> <span class="n">unique_param_sp_combinations</span><span class="p">:</span>
                <span class="n">redundant_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_param_sp_combinations</span><span class="p">:</span>
                <span class="n">unique_param_sp_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">non_redundant_negative_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
            <span class="n">negative_index_parameters</span><span class="p">,</span> <span class="p">(</span><span class="n">redundant_rows</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">neg_subpops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">neg_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">first_neg_date</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param_idx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sp_idx</span> <span class="ow">in</span> <span class="n">non_redundant_negative_parameters</span><span class="p">:</span>
            <span class="n">neg_subpops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subpop_names</span><span class="p">[</span><span class="n">sp_idx</span><span class="p">])</span>
            <span class="n">neg_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">[</span><span class="n">param_idx</span><span class="p">])</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;There are negative parameter errors in subpops </span><span class="si">{</span><span class="n">neg_subpops</span><span class="si">}</span><span class="s2">, starting from date </span><span class="si">{</span><span class="n">first_neg_date</span><span class="si">}</span><span class="s2"> in parameters </span><span class="si">{</span><span class="n">neg_params</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="build_step_source_arg">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.build_step_source_arg">[docs]</a>
<span class="k">def</span> <span class="nf">build_step_source_arg</span><span class="p">(</span>
    <span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span>
    <span class="n">parsed_parameters</span><span class="p">,</span>
    <span class="n">transition_array</span><span class="p">,</span>
    <span class="n">proportion_array</span><span class="p">,</span>
    <span class="n">proportion_info</span><span class="p">,</span>
    <span class="n">initial_conditions</span><span class="p">,</span>
    <span class="n">seeding_data</span><span class="p">,</span>
    <span class="n">seeding_amounts</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;integration&quot;</span> <span class="ow">in</span> <span class="n">modinf</span><span class="o">.</span><span class="n">seir_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">modinf</span><span class="o">.</span><span class="n">seir_config</span><span class="p">[</span><span class="s2">&quot;integration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">integration_method</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">seir_config</span><span class="p">[</span><span class="s2">&quot;integration&quot;</span><span class="p">][</span><span class="s2">&quot;method&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">as_str</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">integration_method</span> <span class="o">==</span> <span class="s2">&quot;best.current&quot;</span><span class="p">:</span>
                <span class="n">integration_method</span> <span class="o">=</span> <span class="s2">&quot;rk4.jit&quot;</span>
            <span class="k">if</span> <span class="n">integration_method</span> <span class="o">==</span> <span class="s2">&quot;rk4&quot;</span><span class="p">:</span>
                <span class="n">integration_method</span> <span class="o">=</span> <span class="s2">&quot;rk4.jit&quot;</span>
            <span class="k">if</span> <span class="n">integration_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rk4.jit&quot;</span><span class="p">,</span> <span class="s2">&quot;euler&quot;</span><span class="p">,</span> <span class="s2">&quot;stochastic&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unknown integration method given, &#39;</span><span class="si">{</span><span class="n">integration_method</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;dt&quot;</span> <span class="ow">in</span> <span class="n">modinf</span><span class="o">.</span><span class="n">seir_config</span><span class="p">[</span><span class="s2">&quot;integration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">seir_config</span><span class="p">[</span><span class="s2">&quot;integration&quot;</span><span class="p">][</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
            <span class="p">)</span>  <span class="c1"># ugly way to parse string and formulas</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">integration_method</span> <span class="o">=</span> <span class="s2">&quot;rk4.jit&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Integration method not provided, assuming type </span><span class="si">{</span><span class="n">integration_method</span><span class="si">}</span><span class="s2"> with dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1">## The type is very important for the call to the compiled function, and e.g mixing an int64 for an int32 can</span>
    <span class="c1">## result in serious error. Note that &quot;In Microsoft C, even on a 64 bit system, the size of the long int data type</span>
    <span class="c1">## is 32 bits.&quot; so upstream user need to specifcally cast everything to int64</span>
    <span class="c1">## Somehow only mobility data is caseted by this function, but perhaps we should handle it all here ?</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">mobility</span><span class="p">)</span> <span class="o">==</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span>
    <span class="n">mobility_data</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">mobility</span><span class="o">.</span><span class="n">data</span>
    <span class="n">mobility_data</span> <span class="o">=</span> <span class="n">mobility_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span>
    <span class="k">assert</span> <span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">parsed_parameters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">transition_array</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">proportion_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">proportion_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>
    <span class="k">assert</span> <span class="n">initial_conditions</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span>
        <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">initial_conditions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
    <span class="c1"># Test of empty seeding:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seeding_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">4</span>

    <span class="n">keys_ref</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;seeding_sources&quot;</span><span class="p">,</span>
        <span class="s2">&quot;seeding_destinations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;seeding_subpops&quot;</span><span class="p">,</span>
        <span class="s2">&quot;day_start_idx&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seeding_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_ref</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;day_start_idx&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># assert (item == np.zeros(s.n_days + 1, dtype=np.int64)).all()</span>
        <span class="c1"># else:</span>
        <span class="c1">#     assert item.size == np.array([], dtype=np.int64)</span>
        <span class="k">assert</span> <span class="n">item</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mobility_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">mobility_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mobility_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">mobility</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">mobility</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">mobility</span><span class="o">.</span><span class="n">indptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">mobility</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_pop</span><span class="p">)</span> <span class="o">==</span> <span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_pop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>

    <span class="k">assert</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">dt</span> <span class="o">==</span> <span class="mf">2.0</span>

    <span class="n">fnct_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ncompartments&quot;</span><span class="p">:</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;nspatial_nodes&quot;</span><span class="p">:</span> <span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span><span class="p">,</span>
        <span class="s2">&quot;ndays&quot;</span><span class="p">:</span> <span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span><span class="p">,</span>
        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parsed_parameters</span><span class="p">,</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
        <span class="s2">&quot;integration_method&quot;</span><span class="p">:</span> <span class="n">integration_method</span><span class="p">,</span>
        <span class="s2">&quot;transitions&quot;</span><span class="p">:</span> <span class="n">transition_array</span><span class="p">,</span>
        <span class="s2">&quot;proportion_info&quot;</span><span class="p">:</span> <span class="n">proportion_info</span><span class="p">,</span>
        <span class="s2">&quot;transition_sum_compartments&quot;</span><span class="p">:</span> <span class="n">proportion_array</span><span class="p">,</span>
        <span class="s2">&quot;initial_conditions&quot;</span><span class="p">:</span> <span class="n">initial_conditions</span><span class="p">,</span>
        <span class="s2">&quot;seeding_data&quot;</span><span class="p">:</span> <span class="n">seeding_data</span><span class="p">,</span>
        <span class="s2">&quot;seeding_amounts&quot;</span><span class="p">:</span> <span class="n">seeding_amounts</span><span class="p">,</span>
        <span class="s2">&quot;mobility_data&quot;</span><span class="p">:</span> <span class="n">mobility_data</span><span class="p">,</span>
        <span class="s2">&quot;mobility_row_indices&quot;</span><span class="p">:</span> <span class="n">modinf</span><span class="o">.</span><span class="n">mobility</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
        <span class="s2">&quot;mobility_data_indices&quot;</span><span class="p">:</span> <span class="n">modinf</span><span class="o">.</span><span class="n">mobility</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span>
        <span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">modinf</span><span class="o">.</span><span class="n">subpop_pop</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">check_parameter_positivity</span><span class="p">(</span>
        <span class="n">fnct_args</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pnames</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">dates</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">subpop_pop</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fnct_args</span></div>



<div class="viewcode-block" id="steps_SEIR">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.steps_SEIR">[docs]</a>
<span class="k">def</span> <span class="nf">steps_SEIR</span><span class="p">(</span>
    <span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span>
    <span class="n">parsed_parameters</span><span class="p">,</span>
    <span class="n">transition_array</span><span class="p">,</span>
    <span class="n">proportion_array</span><span class="p">,</span>
    <span class="n">proportion_info</span><span class="p">,</span>
    <span class="n">initial_conditions</span><span class="p">,</span>
    <span class="n">seeding_data</span><span class="p">,</span>
    <span class="n">seeding_amounts</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">fnct_args</span> <span class="o">=</span> <span class="n">build_step_source_arg</span><span class="p">(</span>
        <span class="n">modinf</span><span class="p">,</span>
        <span class="n">parsed_parameters</span><span class="p">,</span>
        <span class="n">transition_array</span><span class="p">,</span>
        <span class="n">proportion_array</span><span class="p">,</span>
        <span class="n">proportion_info</span><span class="p">,</span>
        <span class="n">initial_conditions</span><span class="p">,</span>
        <span class="n">seeding_data</span><span class="p">,</span>
        <span class="n">seeding_amounts</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">integration_method</span> <span class="o">=</span> <span class="n">fnct_args</span><span class="p">[</span><span class="s2">&quot;integration_method&quot;</span><span class="p">]</span>
    <span class="n">fnct_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;integration_method&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integrating with method </span><span class="si">{</span><span class="n">integration_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">integration_method</span> <span class="o">==</span> <span class="s2">&quot;euler&quot;</span><span class="p">:</span>
        <span class="n">seir_sim</span> <span class="o">=</span> <span class="n">steps_rk4</span><span class="o">.</span><span class="n">rk4_integration</span><span class="p">(</span><span class="o">**</span><span class="n">fnct_args</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;euler&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">integration_method</span> <span class="o">==</span> <span class="s2">&quot;stochastic&quot;</span><span class="p">:</span>
        <span class="n">seir_sim</span> <span class="o">=</span> <span class="n">steps_rk4</span><span class="o">.</span><span class="n">rk4_integration</span><span class="p">(</span><span class="o">**</span><span class="n">fnct_args</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;stochastic&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">integration_method</span> <span class="o">==</span> <span class="s2">&quot;rk4.jit&quot;</span><span class="p">:</span>
        <span class="n">seir_sim</span> <span class="o">=</span> <span class="n">steps_rk4</span><span class="o">.</span><span class="n">rk4_integration</span><span class="p">(</span><span class="o">**</span><span class="n">fnct_args</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">integration_method</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s2">&quot;scipy.solve_ivp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scipy.odeint&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scipy.solve_ivp2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scipy.odeint2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rk4.jit1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rk4.jit2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rk4.jit3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rk4.jit4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rk4.jit5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rk4.jit6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rk4.jit.smart&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rk4_aot&quot;</span><span class="p">,</span>
        <span class="p">}:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; integration method is considered experimental, please use the &#39;rk4_experimental&#39; git branch.&quot;</span><span class="p">,</span>
                <span class="n">integration_method</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown integration method given, &#39;</span><span class="si">{</span><span class="n">integration_method</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># We return an xarray instead of a ndarray now</span>
    <span class="n">compartment_coords</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">compartment_df</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_compartments_explicitDF</span><span class="p">()</span>
    <span class="c1"># Iterate over columns of the DataFrame and populate the dictionary</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">compartment_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">compartment_coords</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;compartment&quot;</span><span class="p">,</span> <span class="n">compartment_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="c1"># comparment is a dimension with coordinate from each of the compartments</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="n">data_vars</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">prevalence</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;compartment&quot;</span><span class="p">,</span> <span class="s2">&quot;subpop&quot;</span><span class="p">],</span> <span class="n">seir_sim</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">incidence</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;compartment&quot;</span><span class="p">,</span> <span class="s2">&quot;subpop&quot;</span><span class="p">],</span> <span class="n">seir_sim</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">),</span>
        <span class="n">coords</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">ti</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">tf</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">compartment_coords</span><span class="p">,</span>
            <span class="n">subpop</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Dynamical simulation results&quot;</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">in_run_id</span>
        <span class="p">),</span>  <span class="c1"># TODO add more information</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">states</span></div>



<div class="viewcode-block" id="build_npi_SEIR">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.build_npi_SEIR">[docs]</a>
<span class="k">def</span> <span class="nf">build_npi_SEIR</span><span class="p">(</span>
    <span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span>
    <span class="n">load_ID</span><span class="p">,</span>
    <span class="n">sim_id2load</span><span class="p">,</span>
    <span class="n">config</span><span class="p">,</span>
    <span class="n">bypass_DF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bypass_FN</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;SEIR.NPI&quot;</span><span class="p">):</span>
        <span class="n">loaded_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bypass_DF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loaded_df</span> <span class="o">=</span> <span class="n">bypass_DF</span>
        <span class="k">elif</span> <span class="n">bypass_FN</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loaded_df</span> <span class="o">=</span> <span class="n">read_df</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">bypass_FN</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">load_ID</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">loaded_df</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">read_simID</span><span class="p">(</span><span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;snpi&quot;</span><span class="p">,</span> <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">)</span>

        <span class="n">npi</span> <span class="o">=</span> <span class="n">NPI</span><span class="o">.</span><span class="n">NPIBase</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">npi_config</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_seir</span><span class="p">,</span>
            <span class="n">modinf_ti</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">ti</span><span class="p">,</span>
            <span class="n">modinf_tf</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">tf</span><span class="p">,</span>
            <span class="n">modifiers_library</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">seir_modifiers_library</span><span class="p">,</span>
            <span class="n">subpops</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span><span class="p">,</span>
            <span class="n">loaded_df</span><span class="o">=</span><span class="n">loaded_df</span><span class="p">,</span>
            <span class="n">pnames_overlap_operation_sum</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">stacked_modifier_method</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">],</span>
            <span class="n">pnames_overlap_operation_reductionprod</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">stacked_modifier_method</span><span class="p">[</span>
                <span class="s2">&quot;reduction_product&quot;</span>
            <span class="p">],</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">npi</span></div>



<div class="viewcode-block" id="onerun_SEIR">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.onerun_SEIR">[docs]</a>
<span class="k">def</span> <span class="nf">onerun_SEIR</span><span class="p">(</span>
    <span class="n">sim_id2write</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span>
    <span class="n">load_ID</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sim_id2load</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">npi</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">modinf</span><span class="o">.</span><span class="n">npi_config_seir</span><span class="p">:</span>
        <span class="n">npi</span> <span class="o">=</span> <span class="n">build_npi_SEIR</span><span class="p">(</span>
            <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_SEIR.compartments&quot;</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">unique_strings</span><span class="p">,</span>
            <span class="n">transition_array</span><span class="p">,</span>
            <span class="n">proportion_array</span><span class="p">,</span>
            <span class="n">proportion_info</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_transition_array</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_SEIR.seeding&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">load_ID</span><span class="p">:</span>
            <span class="n">initial_conditions</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">initial_conditions</span><span class="o">.</span><span class="n">get_from_file</span><span class="p">(</span>
                <span class="n">sim_id2load</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initial_conditions</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">initial_conditions</span><span class="o">.</span><span class="n">get_from_config</span><span class="p">(</span>
                <span class="n">sim_id2write</span><span class="p">,</span> <span class="n">modinf</span><span class="o">=</span><span class="n">modinf</span>
            <span class="p">)</span>
        <span class="n">seeding_data</span><span class="p">,</span> <span class="n">seeding_amounts</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">get_seeding_data</span><span class="p">(</span>
            <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id2load</span> <span class="k">if</span> <span class="n">load_ID</span> <span class="k">else</span> <span class="n">sim_id2write</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_SEIR.parameters&quot;</span><span class="p">):</span>
        <span class="c1"># Draw or load parameters</span>
        <span class="k">if</span> <span class="n">load_ID</span><span class="p">:</span>
            <span class="n">p_draw</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_load</span><span class="p">(</span>
                <span class="n">param_df</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">read_simID</span><span class="p">(</span><span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;spar&quot;</span><span class="p">,</span> <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">),</span>
                <span class="n">n_days</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span><span class="p">,</span>
                <span class="n">nsubpops</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_draw</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_quick_draw</span><span class="p">(</span>
                <span class="n">n_days</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span><span class="p">,</span> <span class="n">nsubpops</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span>
            <span class="p">)</span>
        <span class="c1"># reduce them</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters_reduce</span><span class="p">(</span><span class="n">p_draw</span><span class="p">,</span> <span class="n">npi</span><span class="p">)</span>
        <span class="n">log_debug_parameters</span><span class="p">(</span><span class="n">p_draw</span><span class="p">,</span> <span class="s2">&quot;Parameters without seir_modifiers&quot;</span><span class="p">)</span>
        <span class="n">log_debug_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;Parameters with seir_modifiers&quot;</span><span class="p">)</span>

        <span class="c1"># Parse them</span>
        <span class="n">parsed_parameters</span> <span class="o">=</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">parse_parameters</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pnames</span><span class="p">,</span> <span class="n">unique_strings</span>
        <span class="p">)</span>
        <span class="n">log_debug_parameters</span><span class="p">(</span><span class="n">parsed_parameters</span><span class="p">,</span> <span class="s2">&quot;Unique Parameters used by transitions&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_SEIR.compute&quot;</span><span class="p">):</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">steps_SEIR</span><span class="p">(</span>
            <span class="n">modinf</span><span class="p">,</span>
            <span class="n">parsed_parameters</span><span class="p">,</span>
            <span class="n">transition_array</span><span class="p">,</span>
            <span class="n">proportion_array</span><span class="p">,</span>
            <span class="n">proportion_info</span><span class="p">,</span>
            <span class="n">initial_conditions</span><span class="p">,</span>
            <span class="n">seeding_data</span><span class="p">,</span>
            <span class="n">seeding_amounts</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;onerun_SEIR.postprocess&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">modinf</span><span class="o">.</span><span class="n">write_csv</span> <span class="ow">or</span> <span class="n">modinf</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">:</span>
            <span class="n">write_spar_snpi</span><span class="p">(</span><span class="n">sim_id2write</span><span class="p">,</span> <span class="n">modinf</span><span class="p">,</span> <span class="n">p_draw</span><span class="p">,</span> <span class="n">npi</span><span class="p">)</span>
            <span class="n">out_df</span> <span class="o">=</span> <span class="n">write_seir</span><span class="p">(</span><span class="n">sim_id2write</span><span class="p">,</span> <span class="n">modinf</span><span class="p">,</span> <span class="n">states</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_df</span></div>



<span class="k">def</span> <span class="nf">_onerun_SEIR_with_random_seed</span><span class="p">(</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sim_id2write</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span>
    <span class="n">load_ID</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sim_id2load</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper function to `onerun_SEIR` that sets a random seed.</span>

<span class="sd">    Args:</span>
<span class="sd">        random_seed: The random seed to use.</span>
<span class="sd">        sim_id2write: The simulation ID to write.</span>
<span class="sd">        modinf: The ModelInfo object.</span>
<span class="sd">        load_ID: Whether to load the simulation ID.</span>
<span class="sd">        sim_id2load: The simulation ID to load.</span>
<span class="sd">        config: The configuration.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A pandas DataFrame containing the simulated SEIR output.</span>

<span class="sd">    See Also:</span>
<span class="sd">        `onerun_SEIR`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">reinitialize_distributions</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">onerun_SEIR</span><span class="p">(</span>
        <span class="n">sim_id2write</span><span class="p">,</span> <span class="n">modinf</span><span class="p">,</span> <span class="n">load_ID</span><span class="o">=</span><span class="n">load_ID</span><span class="p">,</span> <span class="n">sim_id2load</span><span class="o">=</span><span class="n">sim_id2load</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span>
    <span class="p">)</span>


<div class="viewcode-block" id="run_parallel_SEIR">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.run_parallel_SEIR">[docs]</a>
<span class="k">def</span> <span class="nf">run_parallel_SEIR</span><span class="p">(</span><span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run SEIR simulations in parallel.</span>

<span class="sd">    Args:</span>
<span class="sd">        modinf: The ModelInfo object.</span>
<span class="sd">        config: The configuration.</span>
<span class="sd">        n_jobs: The number of parallel jobs to run. Default is 1 (no parallelization).</span>

<span class="sd">    Notes:</span>
<span class="sd">        Successive calls to this function will produce different samples for random</span>
<span class="sd">        parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">sim_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">nslots</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">random_seeds</span> <span class="o">=</span> <span class="n">_nslots_random_seeds</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">nslots</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># run single process for debugging/profiling purposes</span>
        <span class="k">for</span> <span class="n">sim_id</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">sim_ids</span><span class="p">):</span>
            <span class="n">_onerun_SEIR_with_random_seed</span><span class="p">(</span>
                <span class="n">random_seeds</span><span class="p">[</span><span class="n">sim_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">sim_id</span><span class="p">,</span>
                <span class="n">modinf</span><span class="p">,</span>
                <span class="n">load_ID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">sim_id2load</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tqdm</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">process_map</span><span class="p">(</span>
            <span class="n">_onerun_SEIR_with_random_seed</span><span class="p">,</span>
            <span class="n">random_seeds</span><span class="p">,</span>
            <span class="n">sim_ids</span><span class="p">,</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">modinf</span><span class="p">),</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">config</span><span class="p">),</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&gt;&gt; </span><span class="si">{</span><span class="n">modinf</span><span class="o">.</span><span class="n">nslots</span><span class="si">}</span><span class="s2"> seir simulations completed &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="states2Df">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.states2Df">[docs]</a>
<span class="k">def</span> <span class="nf">states2Df</span><span class="p">(</span><span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
    <span class="c1"># Tidyup data for  R, to save it:</span>
    <span class="c1">#</span>
    <span class="c1"># Write output to .snpi.*, .spar.*, and .seir.* files</span>
    <span class="c1"># states is  # both are [ndays x ncompartments x nspatial_nodes ] -&gt; this is important here</span>

    <span class="c1"># add line of zero to diff, so we get the real cumulative.</span>
    <span class="c1"># states_diff = np.zeros((states_cumu.shape[0] + 1, *states_cumu.shape[1:]))</span>
    <span class="c1"># states_diff[1:, :, :] = states_cumu</span>
    <span class="c1"># states_diff = np.diff(states_diff, axis=0)</span>

    <span class="n">ts_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">ti</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">tf</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">),</span>
            <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;mc_name&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># prevalence data, we use multi.index dataframe, sparring us the array manipulation we use to do</span>
    <span class="n">prev_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;prevalence&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span> <span class="o">*</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_ncomp</span><span class="p">(),</span> <span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">ts_index</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">prev_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_compartments_explicitDF</span><span class="p">(),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">prev_df</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;mc_name&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">prev_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;mc_value_type&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;prevalence&quot;</span><span class="p">)</span>

    <span class="n">ts_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">ti</span><span class="p">,</span> <span class="n">modinf</span><span class="o">.</span><span class="n">tf</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">),</span>
            <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;mc_name&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">incid_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;incidence&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">modinf</span><span class="o">.</span><span class="n">n_days</span> <span class="o">*</span> <span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_ncomp</span><span class="p">(),</span> <span class="n">modinf</span><span class="o">.</span><span class="n">nsubpops</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">ts_index</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">subpop_struct</span><span class="o">.</span><span class="n">subpop_names</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">incid_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">get_compartments_explicitDF</span><span class="p">(),</span>
        <span class="n">right</span><span class="o">=</span><span class="n">incid_df</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;mc_name&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">incid_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;mc_value_type&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;incidence&quot;</span><span class="p">)</span>

    <span class="n">out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">incid_df</span><span class="p">,</span> <span class="n">prev_df</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

    <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_df</span><span class="o">.</span><span class="n">index</span>

    <span class="k">return</span> <span class="n">out_df</span></div>



<div class="viewcode-block" id="write_spar_snpi">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.write_spar_snpi">[docs]</a>
<span class="k">def</span> <span class="nf">write_spar_snpi</span><span class="p">(</span><span class="n">sim_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span> <span class="n">p_draw</span><span class="p">,</span> <span class="n">npi</span><span class="p">):</span>
    <span class="c1"># NPIs</span>
    <span class="k">if</span> <span class="n">npi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">modinf</span><span class="o">.</span><span class="n">write_simID</span><span class="p">(</span><span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;snpi&quot;</span><span class="p">,</span> <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">npi</span><span class="o">.</span><span class="n">getReductionDF</span><span class="p">())</span>
    <span class="c1"># Parameters</span>
    <span class="n">modinf</span><span class="o">.</span><span class="n">write_simID</span><span class="p">(</span>
        <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;spar&quot;</span><span class="p">,</span> <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">modinf</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">getParameterDF</span><span class="p">(</span><span class="n">p_draw</span><span class="o">=</span><span class="n">p_draw</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="write_seir">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.write_seir">[docs]</a>
<span class="k">def</span> <span class="nf">write_seir</span><span class="p">(</span><span class="n">sim_id</span><span class="p">,</span> <span class="n">modinf</span><span class="p">:</span> <span class="n">ModelInfo</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
    <span class="c1"># print_disk_diagnosis()</span>
    <span class="n">out_df</span> <span class="o">=</span> <span class="n">states2Df</span><span class="p">(</span><span class="n">modinf</span><span class="p">,</span> <span class="n">states</span><span class="p">)</span>
    <span class="n">modinf</span><span class="o">.</span><span class="n">write_simID</span><span class="p">(</span><span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;seir&quot;</span><span class="p">,</span> <span class="n">sim_id</span><span class="o">=</span><span class="n">sim_id</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">out_df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_df</span></div>



<div class="viewcode-block" id="log_debug_parameters">
<a class="viewcode-back" href="../../api/gempyor.html#gempyor.seir.log_debug_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">log_debug_parameters</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;    shape </span><span class="si">{</span><span class="n">parameter</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, type </span><span class="si">{</span><span class="n">parameter</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, range [</span><span class="si">{</span><span class="n">parameter</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">parameter</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">parameter</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;&quot;&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;    value </span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">gempyor</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/gempyor.html">gempyor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/gempyor.html">gempyor package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, ACCIDDA.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>