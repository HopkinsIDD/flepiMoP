name: gempyor-ci

on:
  workflow_dispatch:
  push:
    paths:
      - examples/**/*
      - flepimop/gempyor_pkg/**/*
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
      - breaking-improvements

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    container:
      image: hopkinsidd/flepimop:latest-dev
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
      - name: Install the gempyor package
        run: |
          source /var/python/3.10/virtualenv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install "flepimop/gempyor_pkg[test]"
        shell: bash
      - name: Run gempyor tests
        run: |
          source /var/python/3.10/virtualenv/bin/activate
          cd flepimop/gempyor_pkg
          pytest --exitfirst
        shell: bash
      - name: Run gempyor-cli integration tests from examples
        run: |
          source /var/python/3.10/virtualenv/bin/activate
          cd examples
          pytest --exitfirst
